---
title: "Coastwide analysis of impacts of forestry on BC Pacific Salmon"
author: ''
date: "Apr. 2024"
output:
  html_document:
    collapsed: no
    fig_caption: yes
    highlight: espresso
    number_sections: yes
    smooth_scroll: yes
    theme: sandstone
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 13px;
  }
td {  /* Table  */
  font-size: 13px;
}
h1.title {
  font-size: 24px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 19px;
  color: Black;
}
h2 { /* Header 2 */
    font-size: 15px;
  color: Black;
}
h3 { /* Header 3 */
    font-size: 15px;
  color: Black;
}
</style>
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

# Intro

This short document provides some details on initial models fit and inferential outputs. It can be treated as a living appendix of sorts, and can be added to and polished over time.

Code and data to reproduce the analyses summarized in this document can be found in [this repository](https://github.com/Pacific-salmon-assess/coastwide-salmon-forestry) which is private for now in case there is anything in the ECA dataset that is not suitable for public consumption. Access can be granted by sending Dan or Brendan your github username.

The first set of models we fit includes a covariate for ECA alone (logit transformed and standardized) which is modeled hierarchically down to the individual river (subscript r) level assuming either a Ricker, Beverton-Holt, or Cushing type spawner-recruitment relationship (see m1_ricker.stan, m1_bh.stan, m1_cush.stan for full models written in Stan).

The second set of models drops the varying effects for ECA at the River scale (but allows them to varying at the CU scale). The third set of models includes watershed area and its interaction with the ECA covariate.

The Ricker formulation of the model is:

$log(R_{t,r}/S_{t,r}) = \alpha_r - \beta_r*S_{t,r} + \beta_{eca,r}*ECA_{t,r} + w_{t,r}$

Where residual productivity is autocorrelated by 1-year:

$w_{1,r} \sim N(0,\sigma)$

$w_{t,r} \sim N(\rho_r*w_{t-1,r},\sigma*\sqrt(1-\rho_r^2))$

$\rho \sim U(-1,1)$

And stock-specific parameters are drawn hierarchically at the CU scale for productivity and ECA effects:

$\alpha_r \sim N(\alpha_{cu}, \sigma_{ar}^2)$

$\alpha_{cu} \sim N(\alpha, \sigma_{acu}^2)$

$\alpha \sim N(1.5,2)$

$\beta_{eca,r} \sim N(\beta_{eca,cu}, \sigma_{br})$

$\beta_{eca,cu} \sim N(\beta_{eca}, \sigma_{bcu})$

$\beta_{eca} \sim N(0,1)$

$\sigma s \sim N[0,0.5)$

Stock-specific within brood year density-dependence is estimated independently at the river level, but with informative priors for $S_{max}$ (=$1/\beta$) based on observed spawner counts ($S_r$):

$\beta \sim lognormal(log(0.5*max(S_r)),log(0.5*max(S_r)))$

The Beverton Holt form of the model was linearized as:

$log(R_{t,r}/S_{t,r}) = \alpha_r - log(1+(e^{\alpha_r})/R_{k,r})*S_{t,r}) + \beta_{eca,r}*ECA_{t,r} + w_{t,r}$

Where the new parameter $R_{k,r}$ is the stock-specific equilibrium recruitment, sampled with informative priors based on observed recruitment ($R$):

$R_{k,r} \sim lognormal(log(0.75*max(R_r))-0.5*log(2),log(2))$

For the Cushing model, the linearized form is:

$log(R_t,r/S_{t,r}) = \alpha_r + \beta_r*log(S_{t,r}) + \beta_{eca,r}*ECA_{t,r} + w_{t,r}$

A version of each model was fit to the Chum dataset. The model summaries in CSV form (parameter estimate summaries, model diagnostics etc.) can be found in 'outs/summary' in the repository.

```{r load model fits,  include=FALSE}
 library(here);library(cmdstanr);library(dplyr)

ch20r=ch20r <- read.csv(here('origional-ecofish-data-models','Data','Processed','chum_SR_20_hat_yr_reduced_VRI90.csv'))
#fit set 2: cu varying effects. Ricker/BH/Cushing form
f2ric=readRDS(here('stan models','outs','fits','fit2ric.RDS'))
f2bh= readRDS(here('stan models','outs','fits','fit2bh.RDS'))
f2cu=readRDS(here('stan models','outs','fits','fit2cs.RDS'))
    
```

# Model form comparison

Overall model likelihood across the 3 alternative model forms, assessed by approximate leave-one-out cross-validation, is:

```{r, loo}
loo_comp=readRDS(here('stan models','outs','loo','loo_results_fitset2.RDS'))
loo_comp
```

From this the Beverton-Holt model appears to have substantially better predictive performance compared to the Ricker/Cushing model forms. We will proceed with presenting results for both Beverton-Holt and Ricker models.

# Forestry effects

The overall among population effect size for ECA from the Ricker fit:

```{r, b_eca ric}
summary(f2ric$draws(variable='b_ECA',format='draws_matrix'))
```

and Beverton Holt (R):

```{r, b_eca bh}
summary(f2bh$draws(variable='b_ECA',format='draws_matrix'))
```

Visualized (back converted from logit scale to original ECA) for the Ricker model:

```{r, b_eca plots 1}
ch20r$logit.ECA=qlogis(ch20r$ECA_age_proxy_forested_only+0.005)
ch20r$logit.ECA.std=(ch20r$logit.ECA-mean(ch20r$logit.ECA))/sd(ch20r$logit.ECA)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))


pRS=f2ric$draws(variable='b_ECA',format='draws_matrix')%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',type='l',ylab='change in log(R/S)',title='Beverton-Holt',ylim=c(-0.5,0.3))
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)

```

And Beverton-Holt:

```{r, b_eca plots 2}
pRS=f2bh$draws(variable='b_ECA',format='draws_matrix')%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',type='l',ylab='change in log(R/S)',title='Beverton-Holt',ylim=c(-0.5,0.3))
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)
```

Variation in ECA effect among CUs (Ricker):

```{r, b_eca plots cu 1}
d2=f2ric$draws(variable='b_ECA_cu',format='draws_matrix')

plot(c(0,10)~c(-1,1),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by CU (Ricker)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
abline(v=0,lwd=2)
for(j in 1:ncol(d2)){
d=density(d2[,j],bw=0.02)
lines(d$y~d$x)
}

```

Variation in ECA effect among CUs (BH):

```{r, b_eca plots cu 2}
d2=f2bh$draws(variable='b_ECA_cu',format='draws_matrix')

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
abline(v=0,lwd=2)
for(j in 1:ncol(d2)){
d=density(d2[,j],bw=0.02)
lines(d$y~d$x)
}

```
