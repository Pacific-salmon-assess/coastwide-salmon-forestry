---
title: "Coastwide analysis of forestry impacts on BC Pacific Salmon"
author: ''
date: "Apr. 2024"
output:
  html_document:
    collapsed: no
    fig_caption: yes
    highlight: espresso
    number_sections: yes
    smooth_scroll: yes
    theme: sandstone
    toc: yes
    toc_float: yes
  pdf_document:
    toc: no
  word_document:
    toc: yes
---

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 13px;
  }
td {  /* Table  */
  font-size: 13px;
}
h1.title {
  font-size: 24px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 19px;
  color: Black;
}
h2 { /* Header 2 */
    font-size: 15px;
  color: Black;
}
h3 { /* Header 3 */
    font-size: 15px;
  color: Black;
}
</style>
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

# Overview

This short document provides some details on initial models fit and inferential outputs. It can be treated as a living appendix of sorts, and can be added to and polished over time.

Code and data to reproduce the analyses summarized in this document can be found in [**this repository**](https://github.com/Pacific-salmon-assess/coastwide-salmon-forestry).

The structure of the document will cover several areas.


The first set of models we fit includes a covariate for ECA alone (logit transformed and standardized) which is modeled hierarchically down to CU-level for ECA effects and to the individual river (subscript $r$) level for productivity (m1...). The second set has individual river level effects of ECA (m2...). The third set includes watershed area as a mediator of ECA impacts (ie. an interaction with watershed area and ECA; m3...). 

We test 3 models for the structure of density dependence: either a Ricker (model 1), Beverton-Holt (model 2), or Cushing type (model 3) spawner-recruitment relationship. The stan models themselves are in the github repo as m1_ricker.stan, m1_bh.stan, m1_cush.stan.

#Model structure forms

Ricker formulation:

$log(R_{t,r}/S_{t,r}) = \alpha_r - \beta_r*S_{t,r} + \beta_{eca,r}*ECA_{t,r} + w_{t,r}$

Where residual productivity is autocorrelated by 1-year:

$w_{1,r} \sim N(0,\sigma_r)$

$w_{t,r} \sim N(\rho_r*w_{t-1,r},\sigma_r*\sqrt(1-\rho_r^2))$

$\rho \sim U(-1,1)$

And stock-specific parameters are drawn hierarchically at the River-level for productivity and CU-level for forestry effects:

$\alpha_r \sim N(\alpha_{c}, \sigma_{ar}^2)$

$\alpha_{c} \sim N(\alpha, \sigma_{ac}^2)$

$\alpha \sim N(1.5,2)$

$\beta_{eca,c} \sim N(\beta_{eca}, \sigma_{eca})$

$\beta_{eca} \sim N(0,1)$

$\sigma_{eca} \sim N[0,0.5)$

$\sigma_r \sim N(\sigma_c,\sigma_{\sigma,r})$

$\sigma_c \sim N(\sigma,\sigma_{\sigma,c})$

$\sigma \sim N[0.5,0.5)$

Stock-specific within brood year density-dependence is estimated independently at the river level, but with informative priors for $S_{max}$ (=$1/\beta$; density where total predicted recruitment is maximized) based on observed spawner counts ($S_r$):

$\beta \sim lognormal(0.5*max(S_r),max(S_r))$

The Beverton Holt form of this model was the linearized as:

$log(R_{t,r}/S_{t,r}) = \alpha_r - log(1+(e^{\alpha_r})/R_{k,r})*S_{t,r}) + \beta_{eca,c}*ECA_{t,r} + w_{t,r}$

Where the new parameter $R_{k,r}$ is the stock-specific equilibrium recruitment, sampled with informative priors based on observed recruitment ($R$):

$R_{k,r} \sim lognormal(0.75*max(R_r),max(R_r))$

For the Beverton-Holt form the global among-stock productivity ($\alpha$) we use an alternative prior specification since the range of plausible values differ from the Ricker:

$\alpha \sim normal(4,4)$


For the Cushing model, the linearized form is:

$log(R_t,r/S_{t,r}) = \alpha_r + \beta_r*log(S_{t,r}) + \beta_{eca,c}*ECA_{t,r} + w_{t,r}$

Where the scaling exponent $\beta_r$ for spawners is sampled with generic priors:

$\beta_r \sim lognormal(0,2)$


A version of each model was fit to the Chum dataset. Model summaries can be found in the github repository under 'outs/summary' in the 'stan models' subfolder.

```{r load model fits,  include=FALSE}
 library(here);library(cmdstanr);library(dplyr)

ch20r=ch20r <- read.csv(here('origional-ecofish-data-models','Data','Processed','chum_SR_20_hat_yr_reduced_VRI90.csv'))
#fit set 2: cu varying effects. Ricker/BH/Cushing form
f2ric=readRDS(here('stan models','outs','fits','fit2ric.RDS'))
f2bh= readRDS(here('stan models','outs','fits','fit2bh.RDS'))
f2cu=readRDS(here('stan models','outs','fits','fit2cs.RDS'))
    
```

# Model form comparison

Overall model likelihood across the 3 alternative model (model 1: Ricker, model 2: BH, model 3: Cushing) forms assessed by approximate leave-one-out cross-validation, is:

```{r, loo}
loo_comp=readRDS(here('stan models','outs','loo','loo_results_fitset2.RDS'))
loo_comp[,1:6]
```

From this the Beverton-Holt model appears to have substantially better predictive performance compared to the Ricker/Cushing model forms. We will proceed with results for both BH/Ricker however.

\newpage

# Forestry effects

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit. The plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, b_eca bh}
as.data.frame(f2bh$summary(variables=c('b_ECA','b_ECA_cu'),"mean","sd","quantile2","rhat"))


d2=f2bh$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0=density(d2[,1],bw=0.02)
for(j in 2:ncol(d2)){
d=density(d2[,j],bw=0.02)
lines(d$y~d$x)
}
lines(d0$y~d0$x,col='darkred',lwd=3)
abline(v=0,lwd=2)
```

\newpage

and alternatively with the Ricker model form:

```{r, b_eca ric}
as.data.frame(f2ric$summary(variables=c('b_ECA','b_ECA_cu'),"mean","sd","quantile2","rhat"))

d2r=f2ric$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

plot(c(0,12)~c(-1,1),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by CU (Ricker)',ylim=c(0,12),yaxt='n',xlab='Standardized coefficients')
d0=density(d2r[,1],bw=0.02)

for(j in 2:ncol(d2)){
d=density(d2r[,j],bw=0.02)
lines(d$y~d$x)
}
lines(d0$y~d0$x,col='darkred',lwd=3)
abline(v=0,lwd=2)
```

Visualized (back converted from logit scale to original ECA) for the Beverton-Holt model:

```{r, b_eca plots 2}
#create logit transformed and standardized ECA:
ch20r$logit.ECA=qlogis(ch20r$ECA_age_proxy_forested_only+0.005)
ch20r$logit.ECA.std=(ch20r$logit.ECA-mean(ch20r$logit.ECA))/sd(ch20r$logit.ECA)

#predict over standardized values (x_n) and back calculate natural scale ECA (eca_n)
x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=f2bh$draws(variable='b_ECA',format='draws_matrix')%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',type='l',ylab='change in log(R/S)',title='Beverton-Holt',ylim=c(-0.5,0.3))
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)
```

\newpage

And Ricker model:

```{r, b_eca plots ric}
pRS=f2ric$draws(variable='b_ECA',format='draws_matrix')%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',type='l',ylab='change in log(R/S)',title='Beverton-Holt',ylim=c(-0.5,0.3))
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)

```

Proposed to do/future tweaks:

1.  Shared year effects or shared latent productivity trends

2.  Watershed area & interaction with ECA

3.  non-linear function for ECA?

\newpage

Overall distribution of ECA among all observations:

```{r, eca histogram, fig.width=8,fig.height=6}
hist(ch20r$ECA_age_proxy_forested_only,breaks=30,main='ECA for all observations')
hist(ch20r$logit.ECA,breaks=30,main='Logit transformed ECA for all observations')

```

\newpage

River-level ECA and effect on productivity through time by CU (BH model):

```{r, eca time-series, fig.width=8,fig.height=12}

for(c in 1:length(unique(ch20r$CU))){
  s=subset(ch20r,CU==levels(factor(ch20r$CU))[c])
  par(mfrow=c(2,1))
  plot(c(0,1)~c(min(ch20r$BroodYear),max(ch20r$BroodYear)),bty='l',type='n',ylab='ECA',ylim=c(0,1),xlab='',main=unique(s$CU))
  for(j in 1:length(unique(s$River))){
    r=subset(s,River==unique(s$River)[j])
    lines(r$ECA_age_proxy_forested_only~r$BroodYear,lwd=2,col=adjustcolor('black',alpha.f=0.5))
  }
  s$d_eca=median(d2[,c+1])*s$ECA_age_proxy_forested_only_std
   plot(c(-1.5,1.5)~c(min(ch20r$BroodYear),max(ch20r$BroodYear)),bty='l',type='n',ylab='Realized ECA effect on productivity',xlab='Brood year')
  for(j in 1:length(unique(s$River))){
    r=subset(s,River==unique(s$River)[j])
    lines(r$d_eca~r$BroodYear,lwd=2,col=adjustcolor('black',alpha.f=0.5))
  }
      
}
```
