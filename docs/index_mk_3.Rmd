---
title: "Coastwide analysis of forestry impacts on BC Pacific Salmon"
author: ''
date: "Nov 2024"
output:
  word_document:
    toc: true
  pdf_document:
    toc: true
  html_document:
    collapsed: false
    fig_caption: true
    highlight: espresso
    number_sections: true
    smooth_scroll: true
    theme: sandstone
    toc: true
    toc_float: true
---

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 13px;
  }
td {  /* Table  */
  font-size: 13px;
}
h1.title {
  font-size: 24px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 19px;
  color: Black;
}
h2 { /* Header 2 */
    font-size: 15px;
  color: Black;
}
h3 { /* Header 3 */
    font-size: 15px;
  color: Black;
}
</style>
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(cache=FALSE)
options(max.print=23)
library(cmdstanr)
library(here);library(dplyr); library(stringr)
library(ggplot2)
library(tidyverse)
library(bayesplot)
library(patchwork)
library(hues)
library(GGally)
library(latex2exp)
library(ggforce)
```

# Model

Beverton-Holt (BH):


$log(R_{t,r}/S_{t,r}) = \alpha_r - log(1+(\frac{e^{\alpha_t+\alpha_r + \beta_{forestry,r}*Forestry_{t,r} }}{R_{k,r}})*S_{t,r}) + \beta_{forestry,r}*Forestry_{t,r} + \rho \epsilon_{t-1,r}$

$log(R_{t,r}/S_{t,r}) = \alpha_t + \alpha_r - log(1+(\frac{e^{\alpha_t+\alpha_r + \beta_{forestry,r}*Forestry_{t,r} }}{R_{k,r}})*S_{t,r}) + \beta_{forestry,r}*Forestry_{t,r} + \rho \epsilon_{t-1,r}$

$log(R_{t,r}/S_{t,r}) = \alpha_r - log(1+(\frac{e^{\alpha_t+\alpha_r + \beta_{forestry,r}*Forestry_{t,r}+ \beta_{npgo,r}*NPGO_{t} + \beta_{sst,r}*SST_{t,r} }}{R_{k,r}})*S_{t,r}) + \beta_{forestry,r}*Forestry_{t,r} + \beta_{npgo,r}*NPGO_{t} + \beta_{sst,r}*SST_{t,r} + \rho \epsilon_{t-1,r}$

Ricker:


$log(R_{t,r}/S_{t,r}) = \alpha_r - \frac{S_{t,r}}{Smax_r} + \beta_{forestry,r}*Forestry_{t,r} + \epsilon_{t-1,r}$

$log(R_{t,r}/S_{t,r}) = \alpha_t + \alpha_r - \frac{S_{t,r}}{Smax_r} + \beta_{forestry,r}*Forestry_{t,r} + \epsilon_{t-1,r}$

$log(R_{t,r}/S_{t,r}) = \alpha_r - \frac{S_{t,r}}{Smax_r} + \beta_{forestry,r}*Forestry_{t,r} + \beta_{npgo,r}*NPGO_{t} + \beta_{sst,r}*SST_{t,r} + \epsilon_{t-1,r}$


# Chum and Pink salmon Watersheds

```{r out.width = "100%", fig.align = "center"}

# load png from figures folder and show

# p1 <- png(here("figures","correlation_plot_sst_npgo_PDO.png"))

knitr::include_graphics(here("figures","chum_pink_watersheds_location_map.png"))
```

## ERSST

```{r out.width = "100%", fig.align = "center"}

# load png from figures folder and show

# p1 <- png(here("figures","correlation_plot_sst_npgo_PDO.png"))

knitr::include_graphics(here("figures","sstersst_1959_2014.png"))
```

# Chum salmon

```{r}

# Data wrangling

# ch20rsc <-read.csv("../origional-ecofish-data-models/Data/Processed/chum_SR_20_hat_yr_w_npgo.csv")
# ch20rsc_sst <-read.csv("../origional-ecofish-data-models/Data/Processed/chum_SR_20_hat_yr_w_coord_w_SSTCOBE2.csv")
ch20rsc <- read.csv(here("origional-ecofish-data-models","Data","Processed","chum_SR_20_hat_yr_w_ersst.csv"))

#two rivers with duplicated names:
ch20rsc$River=ifelse(ch20rsc$WATERSHED_CDE=='950-169400-00000-00000-0000-0000-000-000-000-000-000-000','SALMON RIVER 2',ch20rsc$River)
ch20rsc$River=ifelse(ch20rsc$WATERSHED_CDE=="915-486500-05300-00000-0000-0000-000-000-000-000-000-000",'LAGOON CREEK 2',ch20rsc$River)


ch20rsc=ch20rsc[order(factor(ch20rsc$River),ch20rsc$BroodYear),]

ch20rsc$River_n <- as.numeric(factor(ch20rsc$River))

#normalize ECA 2 - square root transformation (ie. sqrt(x))
ch20rsc$sqrt.ECA=sqrt(ch20rsc$ECA_age_proxy_forested_only)
ch20rsc$sqrt.ECA.std=(ch20rsc$sqrt.ECA-mean(ch20rsc$sqrt.ECA))/sd(ch20rsc$sqrt.ECA)

#normalize CPD 2 - square root transformation (ie. sqrt(x))
ch20rsc$sqrt.CPD=sqrt(ch20rsc$disturbedarea_prct_cs)
ch20rsc$sqrt.CPD.std=(ch20rsc$sqrt.CPD-mean(ch20rsc$sqrt.CPD))/sd(ch20rsc$sqrt.CPD)

ch20rsc$npgo.std=(ch20rsc$npgo-mean(ch20rsc$npgo))/sd(ch20rsc$npgo)
ch20rsc$sst.std=(ch20rsc$spring_ersst-mean(ch20rsc$spring_ersst))/sd(ch20rsc$spring_ersst)


# CU names
#####
cu_names <- data.frame(CU = c("CM-1","CM-2","CM-3","CM-4","CM-5","CM-6",
                              "CM-7","CM-8","CM-9","CM-10","CM-11","CM-12",
                              "CM-13","CM-14","CM-15","CM-16","CM-17","CM-18",
                              "CM-19","CM-20","CM-21","CM-22","CM-23","CM-24",
                              "CM-25","CM-26","CM-27","CM-28","CM-29","CM-30",
                              "CM-31","CM-32","CM-33","CM-34","CM-35","CM-36",
                              "CM-37","CM-38", "CM-39"),
                        CU_name = c("Fraser Canyon",
                                    "Lower Fraser",
                                    "Howe Sound-Burrard Inlet",
                                    "Georgia Strait",
                                    "East Vancouver Island",
                                    "Loughborough",
                                    "Bute Inlet",
                                    "Southern Coastal Streams",
                                    "Upper Knight",
                                    "Southwest Vancouver Island",
                                    "Northwest Vancouver Island",
                                    "Smith Inlet",
                                    "Rivers Inlet",
                                    "Wannock",
                                    "Spiller-Fitz Hugh-Burke",
                                    "Bella Coola - Dean Rivers",
                                    "Bella Coola River - Late",
                                    "Hecate Lowlands",
                                    "Mussel-Kynoch",
                                    "Douglas-Gardner",
                                    "East Haida Gwaii",
                                    "Skidegate",
                                    "West Haida Gwaii",
                                    "North Haida Gwaii",
                                    "North Haida Gwaii-Stanley Creek",
                                    "Skeena Estuary",
                                    "Lower Skeena",
                                    "Middle Skeena",
                                    "Upper Skeena",
                                    "Portland Inlet",
                                    "Lower Nass",
                                    "Portland Canal-Observatory",
                                    "Unuk",
                                    "Lower Stikine",
                                    "Whiting",
                                    "Taku",
                                    "Lynn Canal",
                                    "Teslin",
                                    "Lower Liard"))
#####

ch20rsc <- ch20rsc %>% left_join(cu_names, by = 'CU') 

max_eca_df <- ch20rsc %>% 
  select(River, River_n,CU, ECA_age_proxy_forested_only) %>%
  group_by(River) %>%
  summarize(River_n = first(River_n),
            River = first(River),
            CU = first(CU),
            eca_max = 100*max(ECA_age_proxy_forested_only, na.rm =TRUE)) %>% 
  mutate(eca_level = case_when(eca_max < 12 ~ 'low',
                               eca_max >= 12 & eca_max < 24 ~ 'medium',
                               eca_max >= 24 ~ 'high'))

max_cpd_df <- ch20rsc %>% 
  select(River, River_n,CU, disturbedarea_prct_cs) %>%
  group_by(River) %>% 
  summarize(River_n = first(River_n),
            River = first(River),
            CU = first(CU),
            cpd_max = max(disturbedarea_prct_cs, na.rm = TRUE))


```

```{r}

#function to produce ggplot figure of global forestry effect and watershed level
#posterior density of ECA and CPD effects

#input - posterior samples of ECA and CPD effects
#output - ggplot figure

plot_forestry_effect <- function(posterior = bh_chm_eca, effect = "eca", species = "chum", model = "BH model with NPGO", xlim = c(-2, 2)){
  
  if(effect == "eca"){
    x_name = "Standardized coefficients of ECA"
    y_name = "Posterior density\nof ECA effect"
    color_var = "eca_level"
    color_name = "Max ECA level\nin River (%)"
    scale_color = scale_color_manual(name = "Max ECA level\nin River (%)",
                                     values = c('low' = '#35978f', 'medium' = 'gray', 'high' = '#bf812d'))
    
    if(species == "chum"){
      max_df = max_eca_df
    } else if(species == "pink"){
      max_df = max_eca_pink_df
    }
    
  } else if(effect == "cpd"){
    x_name = "Standardized coefficients of CPD"
    y_name = "Posterior density\nof CPD effect"
    color_var = "cpd_max"
    color_name = "Max CPD\nin River (%)"
    scale_color = scale_color_gradient2(name = 'Max CPD\nin River (%)',
                                        low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = 50)
    
    if(species == "chum"){
      max_df = max_cpd_df
    } else if(species == "pink"){
      max_df = max_cpd_pink_df
    }
  }
       
       
       
  posterior_df <- posterior %>%
    select(starts_with('b_for_rv')) %>%
    pivot_longer(cols = everything(), 
                 names_to = 'River', 
                 names_prefix = 'b_for_rv',
                 values_to = effect) %>%
    mutate(River_n = as.numeric(str_extract(River, '\\d+'))) %>% 
    select(-River) %>%
    left_join(max_df, by = 'River_n')
  
  #color by river
  plot1 <- ggplot() +
    stat_density(data= posterior_df, aes(!!sym(effect), color = !!sym(color_var), group = River),
                 geom = 'line', position = 'identity', 
                 alpha = 0.1, linewidth = 1) +
    geom_vline(xintercept = 0, color = 'slategray', linewidth = 0.8) +
    labs(title = model, x = x_name, y = y_name) +
    xlim(xlim[1], xlim[2]) +
    scale_color +
    geom_density(aes(posterior$b_for), color = 'black', linewidth = 1.2, alpha = 0.2)+
    #vline at the median value of the posterior
    geom_vline(xintercept = median(posterior$b_for), color = 'black', linetype = 'dashed')+
    theme_classic()+
    theme(legend.position = 'right',
          axis.title.x = element_text(size = 12),
          axis.title.y = element_text(size = 12),
          axis.text.x = element_text(size = 10),
          axis.text.y = element_text(size = 10),
          plot.title = element_text(size = 14, hjust = 0.5)
          )+
    guides(color = guide_legend(override.aes = list(alpha = 1)))
  
  
  
  return(plot1)
}

plot_productivity_decline <- function(posterior = bh_chm_eca_sst, effect = "eca", species = "chum", model = "BH model with NPGO, LH SST"){
  
  
  if(species == "chum"){
    df <- ch20rsc 
    df$sst.std <- (ch20rsc$spring_ersst-mean(ch20rsc$spring_ersst))/sd(ch20rsc$spring_ersst)
    
  } else if(species == "pink"){
    df <- pk10r
    df$sst.std <- (pk10r$spring_ersst-mean(pk10r$spring_ersst))/sd(pk10r$spring_ersst)
  }
  
  if(effect == "eca"){
    forestry <- seq(0,1,length.out=100)
    b <- posterior %>% select(ends_with("b_for"))
    
    forestry_sqrt <- sqrt(forestry)
  
    forestry_sqrt_std = (forestry_sqrt-mean(forestry_sqrt))/sd(forestry_sqrt)
   
  }else if(effect == "cpd"){
    forestry <- seq(0,100,length.out=100)
    b <- posterior %>% select(ends_with("b_for"))
    forestry_sqrt <- sqrt(forestry)
  
    forestry_sqrt_std = (forestry_sqrt-mean(forestry_sqrt))/sd(forestry_sqrt)
   
  }else if(effect == "sst"){
    forestry <- seq(10,15,length.out=100)
    b <- posterior %>% select(ends_with("b_sst"))
    
    forestry_sqrt_std = (forestry-mean(forestry))/sd(forestry)
    
  }
  
  
  
  no_forestry <- min(forestry_sqrt_std)
  
  # bh_chm_eca_sst=read.csv(here('stan models','outs','posterior',bh_chm_eca_sst),check.names=F)
  
  
  
  global_prediction <- apply(exp(as.matrix(b[,1])%*%
                                 (forestry_sqrt_std-no_forestry))*100 - 100,2,median)
  
  global_025 <- apply(exp(as.matrix(b[,1])%*%
                          (forestry_sqrt_std-no_forestry))*100 - 100,2,quantile,c(0.025), 
                      row.names = c("q025"))
  
  global_975 <- apply(exp(as.matrix(b[,1])%*%
                          (forestry_sqrt_std-no_forestry))*100 - 100,2,quantile,c(0.975),
                      row.names = c("q975"))
  
  global_df <- data.frame(forestry = forestry,
                          productivity_median = global_prediction,
                          q025 = global_025,
                          q975 = global_975)
  
  full_productivity <- NULL
  
  # no_forestry <- min(eca_std_sqrt)
  for (i in 1:length(unique(df$River_n))){
    river <- unique(df$River_n)[i]
    
    river_data <- df %>% filter(River_n == river)
    
    if(effect == "eca"){
      b_rv <- posterior %>% select(starts_with("b_for_rv")) %>%
      select(ends_with(paste0("[",river,"]")))
      
      forestry_sqrt_std_river <- seq(min(river_data$sqrt.ECA.std),max(river_data$sqrt.ECA.std),length.out=100)
      
      forestry_river <- seq(min(river_data$ECA_age_proxy_forested_only),max(river_data$ECA_age_proxy_forested_only),length.out=100)
      
      
    } else if(effect == "cpd"){
      b_rv <- posterior %>% select(starts_with("b_for_rv")) %>%
      select(ends_with(paste0("[",river,"]")))
      
      forestry_sqrt_std_river <- seq(min(river_data$sqrt.CPD.std),max(river_data$sqrt.CPD.std),length.out=100)
      
      forestry_river <- seq(min(river_data$disturbedarea_prct_cs),max(river_data$disturbedarea_prct_cs),length.out=100)
      
      
    } else if(effect == "sst"){
      b_rv <- posterior %>% select(starts_with("b_sst_rv")) %>%
      select(ends_with(paste0("[",river,"]")))
      
      # use only spring_ersst
      
      forestry_sqrt_std_river <- seq(min(river_data$sst.std),max(river_data$sst.std),length.out=100)
      
      forestry_river <- seq(min(river_data$spring_ersst),max(river_data$spring_ersst),length.out=100)
      
    }
    
    

    
    
    
    
    productivity <- (exp(as.matrix(b_rv[,1])%*%
                           (forestry_sqrt_std-no_forestry)))*100 - 100
    
    productivity_median <- apply(productivity,2,median)
    
    productivity_median_df <- data.frame(River = unique(river_data$River),
                                         productivity_median = productivity_median,
                                         forestry = forestry_river) %>% 
  filter(forestry >= min(forestry_river), forestry <= max(forestry_river))
    
    full_productivity <- rbind(full_productivity, productivity_median_df)
    
  }
  
  # b <- posterior %>% select(ends_with("b_for"))
  
  median_prediction <- apply(exp(as.matrix(b[,1])%*%
                                (forestry_sqrt_std-no_forestry))*100 - 100,2,median)
  
  median_df <- data.frame(forestry = forestry,
                          productivity_median = median_prediction)
  
  if(effect == "eca" || effect == "cpd"){
    p1 <- ggplot(full_productivity) +
    geom_line(aes(x = forestry, y = productivity_median, group = River,
                  color = "watershed level\nforestry effect"),alpha=0.5) +
    geom_line(data = global_df, 
              aes(x = forestry, y = productivity_median, color = "global forestry effect"), linewidth = 1) +
    geom_ribbon(data = global_df, aes(x = forestry, ymin = q025, ymax = q975),
                alpha = 0.5, fill = "gray") +
    # scale_fill_manual("",values  = c("95% credible interval" = "gray")) +
    scale_color_manual("",values = c("watershed level\nforestry effect" = "darkgray", 
                                     "global forestry effect" = "black")) +
    ylim(-100,100) +
    scale_x_continuous(n.breaks = 5) +
    labs(title = model,
      x = ifelse(effect == "eca", "Equivalent clearcut area", "Cumulative percent disturbed (%)"),
      y = "Median change\n in productivity (%)") +
    theme_classic() +
    theme(legend.position = c(0.8,0.8),
          legend.title = element_blank(),
          legend.key.size = unit(0.5, "cm"),
          legend.key.width = unit(1, "cm"),
          axis.title.x = element_text(size = 12),
          axis.title.y = element_text(size = 12),
          axis.text.x = element_text(size = 10),
          axis.text.y = element_text(size = 10),
          plot.title = element_text(size = 14, hjust = 0.5))+
    guides(color = guide_legend(override.aes = list(alpha = 1, linewidth = 1.5)))
  } else if(effect == "sst"){
    p1 <- ggplot(full_productivity) +
    geom_line(aes(x = forestry, y = productivity_median, group = River,
                  color = "watershed level\nSST effect"),alpha=0.5) +
    geom_line(data = global_df, 
              aes(x = forestry, y = productivity_median, color = "global SST effect"), linewidth = 1) +
    geom_ribbon(data = global_df, aes(x = forestry, ymin = q025, ymax = q975),
                alpha = 0.5, fill = "gray") +
    # scale_fill_manual("",values  = c("95% credible interval" = "gray")) +
    scale_color_manual("",values = c("watershed level\nSST effect" = "darkgray", 
                                     "global SST effect" = "black")) +
    ylim(-100,100) +
    scale_x_continuous(n.breaks = 5, limits = c(10,15)) +
    labs(title = model,
      x = "Spring SST (°C)",
      y = "Median change\n in productivity (%)") +
    theme_classic() +
    theme(legend.position = c(0.8,0.8),
          legend.title = element_blank(),
          legend.key.size = unit(0.5, "cm"),
          legend.key.width = unit(1, "cm"),
          axis.title.x = element_text(size = 12),
          axis.title.y = element_text(size = 12),
          axis.text.x = element_text(size = 10),
          axis.text.y = element_text(size = 10),
          plot.title = element_text(size = 14, hjust = 0.5))+
    guides(color = guide_legend(override.aes = list(alpha = 1, linewidth = 1.5)))
  }
  
  return(p1)
  
}
  




```

## Beverton Holt Models

```{r fig.width=10, fig.height=12}
bh_chm_eca=read.csv(here('stan models','outs','posterior','bh_chm_eca_ac_oct24.csv'),check.names=F)
bh_chm_cpd=read.csv(here('stan models','outs','posterior','bh_chm_cpd_ac_oct24.csv'),check.names=F)

bh_chm_eca_st=read.csv(here('stan models','outs','posterior','bh_chm_eca_static_nov24.csv'),check.names=F)
bh_chm_cpd_st=read.csv(here('stan models','outs','posterior','bh_chm_cpd_static_nov24.csv'),check.names=F)



# 
# bh_chm_eca_npgo=read.csv(here('stan models','outs','posterior','bh_chm_eca_npgo.csv'),check.names=F)
# bh_chm_cpd_npgo=read.csv(here('stan models','outs','posterior','bh_chm_cpd_npgo.csv'),check.names=F)
# 
# bh_chm_eca_sst=read.csv(here('stan models','outs','posterior','bh_chm_eca_npgo_sst.csv'),check.names=F)
# bh_chm_cpd_sst=read.csv(here('stan models','outs','posterior','bh_chm_cpd_npgo_sst.csv'),check.names=F)
# 
# bh_chm_eca_lh_sst=read.csv(here('stan models','outs','posterior','bh_chm_eca_npgo_lh_sst.csv'),check.names=F)
# bh_chm_cpd_lh_sst=read.csv(here('stan models','outs','posterior','bh_chm_cpd_npgo_lh_sst.csv'),check.names=F)

# bh_chm_eca_cobe_sst=read.csv(here('stan models','outs','posterior','bh_chm_eca_npgo_cobe_sst.csv'),check.names=F)
# bh_chm_cpd_cobe_sst=read.csv(here('stan models','outs','posterior','bh_chm_cpd_npgo_cobe_sst.csv'),check.names=F)

bh_chm_eca_ersst=read.csv(here('stan models','outs','posterior','bh_chm_eca_npgo_ersst.csv'),check.names=F)
bh_chm_cpd_ersst=read.csv(here('stan models','outs','posterior','bh_chm_cpd_npgo_ersst.csv'),check.names=F)

bh_chm_eca_ersst_pdo=read.csv(here('stan models','outs','posterior','bh_chm_eca_npgo_ersst_pdo.csv'),check.names=F)
bh_chm_cpd_ersst_pdo=read.csv(here('stan models','outs','posterior','bh_chm_cpd_npgo_ersst_pdo.csv'),check.names=F)



((plot_forestry_effect(posterior = bh_chm_eca_ersst_pdo, effect = "eca", species = "chum", model = "BH model with NPGO, ERSST, PDO") +
    plot_forestry_effect(posterior = bh_chm_cpd_ersst_pdo, effect = "cpd", species = "chum", model = "BH model with NPGO, ERSST, PDO"))/(plot_forestry_effect(posterior = bh_chm_eca_ersst, effect = "eca", species = "chum", model = "BH model with NPGO, ERSST") +
    plot_forestry_effect(posterior = bh_chm_cpd_ersst, effect = "cpd", species = "chum", model = "BH model with NPGO, ERSST"))/(plot_forestry_effect(posterior = bh_chm_eca_st, effect = "eca", species = "chum", model = "BH model without coastwide productivity") +
    plot_forestry_effect(posterior = bh_chm_cpd_st, effect = "cpd", species = "chum", model = "BH model without coastwide productivity"))/(plot_forestry_effect(posterior = bh_chm_eca, effect = "eca", species = "chum", model = "BH model with coastwide productivity") +
    plot_forestry_effect(posterior = bh_chm_cpd, effect = "cpd", species = "chum", model = "BH model with coastwide productivity"))) + plot_layout(guides = "collect")


```

## Corrected Beverton-Holt Models

```{r fig.width= 10, fig.height=9}

bh_chm_eca_correct=read.csv(here('stan models','outs','posterior','bh_chm_eca_ac_mar25_corrected.csv'),check.names=F)
bh_chm_cpd_correct=read.csv(here('stan models','outs','posterior','bh_chm_cpd_ac_mar25_corrected.csv'),check.names=F)

bh_chm_eca_st_correct=read.csv(here('stan models','outs','posterior','bh_chm_eca_static_corrected.csv'),check.names=F)
bh_chm_cpd_st_correct=read.csv(here('stan models','outs','posterior','bh_chm_cpd_static_corrected.csv'),check.names=F)



bh_chm_eca_ersst_correct=read.csv(here('stan models','outs','posterior','bh_chm_eca_npgo_ersst_corrected.csv'),check.names=F)
bh_chm_cpd_ersst_correct=read.csv(here('stan models','outs','posterior','bh_chm_cpd_npgo_ersst_corrected.csv'),check.names=F)

((plot_forestry_effect(posterior = bh_chm_cpd_st_correct, effect = "cpd", species = "chum", model = "BH model with CPD", xlim = c(-3,3)) +
    plot_forestry_effect(posterior = bh_chm_eca_st_correct, effect = "eca", species = "chum", model = "BH model with ECA", xlim = c(-3,3)))/(plot_forestry_effect(posterior = bh_chm_cpd_correct, effect = "cpd", species = "chum", model = "BH model with CPD,\ncoastwide productivity", xlim = c(-3,3)) +
    plot_forestry_effect(posterior = bh_chm_eca_correct, effect = "eca", species = "chum", model = "BH model with ECA,\ncoastwide productivity", xlim = c(-3,3)))/(plot_forestry_effect(posterior = bh_chm_cpd_ersst_correct, effect = "cpd", species = "chum", model = "BH model with CPD, NPGO, SST", xlim = c(-3,3)) +
    plot_forestry_effect(posterior = bh_chm_eca_ersst_correct, effect = "eca", species = "chum", model = "BH model with ECA, NPGO, SST", xlim = c(-3,3))) + plot_layout(guides = "collect"))




```

## Beverton-Holt Models with forestry effect on carrying capacity


```{r fig.width=10, fig.height=6}


bh_chm_eca_st_cc = read.csv(here('stan models','outs','posterior','bh_chm_eca_static_cc.csv'),check.names=F)

bh_chm_cpd_st_cc = read.csv(here('stan models','outs','posterior','bh_chm_cpd_static_cc.csv'),check.names=F)

((plot_forestry_effect(posterior = bh_chm_eca_st_cc, effect = "eca", species = "chum", model = "BH model with ECA effect on K", xlim = c(-2,2)) + plot_forestry_effect(posterior = bh_chm_cpd_st_cc, effect = "cpd", species = "chum", model = "BH model with CPD effect on K", xlim = c(-2,2)))/(plot_forestry_effect(posterior = bh_chm_eca_st_correct, effect = "eca", species = "chum", model = "BH model with ECA effect\n on productivity", xlim = c(-2,2)) +
    plot_forestry_effect(posterior = bh_chm_cpd_st_correct, effect = "cpd", species = "chum", model = "BH model with CPD effect\n on productivity", xlim = c(-2,2))) + plot_layout(guides = "collect"))



```




## Ricker Models

```{r fig.width=10, fig.height=9}

ric_chm_eca=read.csv(here('stan models','outs','posterior','ric_chm_eca_ac_oct24.csv'),check.names=F)
ric_chm_cpd=read.csv(here('stan models','outs','posterior','ric_chm_cpd_ac_oct24.csv'),check.names=F)


ric_chm_eca_st=read.csv(here('stan models','outs','posterior','ric_chm_eca_static_nov24.csv'),check.names=F)
ric_chm_cpd_st=read.csv(here('stan models','outs','posterior','ric_chm_cpd_static_nov24.csv'),check.names=F)


# ric_chm_eca_npgo=read.csv(here('stan models','outs','posterior','ric_chm_eca_npgo.csv'),check.names=F)
# ric_chm_cpd_npgo=read.csv(here('stan models','outs','posterior','ric_chm_cpd_npgo.csv'),check.names=F)
# 
# ric_chm_eca_sst=read.csv(here('stan models','outs','posterior','ric_chm_eca_npgo_sst.csv'),check.names=F)
# ric_chm_cpd_sst=read.csv(here('stan models','outs','posterior','ric_chm_cpd_npgo_sst.csv'),check.names=F)
# 
# ric_chm_eca_lh_sst=read.csv(here('stan models','outs','posterior','ric_chm_eca_npgo_lh_sst.csv'),check.names=F)
# ric_chm_cpd_lh_sst=read.csv(here('stan models','outs','posterior','ric_chm_cpd_npgo_lh_sst.csv'),check.names=F)
# 
# 
# ric_chm_eca_cobe_sst=read.csv(here('stan models','outs','posterior','ric_chm_eca_npgo_cobe_sst.csv'),check.names=F)
# ric_chm_cpd_cobe_sst=read.csv(here('stan models','outs','posterior','ric_chm_cpd_npgo_cobe_sst.csv'),check.names=F)

ric_chm_eca_ersst=read.csv(here('stan models','outs','posterior','ric_chm_eca_npgo_ersst.csv'),check.names=F)

ric_chm_cpd_ersst=read.csv(here('stan models','outs','posterior','ric_chm_cpd_npgo_ersst.csv'),check.names=F)


((plot_forestry_effect(posterior = ric_chm_eca_ersst, effect = "eca", species = "chum", model = "Ricker model with NPGO, ERSST", xlim = c(-0.5,0.5)) + plot_forestry_effect(posterior = ric_chm_cpd_ersst, effect = "cpd", species = "chum", model = "Ricker model with NPGO, ERSST", xlim = c(-0.5,0.5)))/(plot_forestry_effect(posterior = ric_chm_eca_st, effect = "eca", species = "chum", model = "Ricker model without coastwide productivity", xlim = c(-0.5,0.5)) +
    plot_forestry_effect(posterior = ric_chm_cpd_st, effect = "cpd", species = "chum", model = "Ricker model without coastwide productivity", xlim = c(-0.5,0.5)))/(plot_forestry_effect(posterior = ric_chm_eca, effect = "eca", species = "chum", model = "Ricker model with coastwide productivity", xlim = c(-0.5,0.5)) +
    plot_forestry_effect(posterior = ric_chm_cpd, effect = "cpd", species = "chum", model = "Ricker model with coastwide productivity", xlim = c(-0.5,0.5))))  + plot_layout(guides = "collect")


```


## Ricker Models with forestry effect on carrying capacity

```{r fig.width=10, fig.height=6}

ric_chm_eca_st_cc = read.csv(here('stan models','outs','posterior','ric_chm_eca_static_cc.csv'),check.names=F)

ric_chm_cpd_st_cc = read.csv(here('stan models','outs','posterior','ric_chm_cpd_static_cc.csv'),check.names=F)

((plot_forestry_effect(posterior = ric_chm_eca_st_cc, effect = "eca", species = "chum", model = "Ricker model with ECA effect on K", xlim = c(-3,3)) + plot_forestry_effect(posterior = ric_chm_cpd_st_cc, effect = "cpd", species = "chum", model = "Ricker model with CPD effect on K", xlim = c(-3,3)))/(plot_forestry_effect(posterior = ric_chm_eca_st, effect = "eca", species = "chum", model = "Ricker model with ECA effect \non productivity", xlim = c(-3,3)) +
    plot_forestry_effect(posterior = ric_chm_cpd_st, effect = "cpd", species = "chum", model = "Ricker model with CPD effect \non productivity", xlim = c(-3,3))) + plot_layout(guides = "collect"))


ric_chm_eca_ersst_cc = read.csv(here('stan models','outs','posterior','ric_chm_eca_npgo_ersst_cc_trial.csv'),check.names=F)

ric_chm_cpd_ersst_cc = read.csv(here('stan models','outs','posterior','ric_chm_cpd_npgo_ersst_cc_trial.csv'),check.names=F)

((plot_forestry_effect(posterior = ric_chm_eca_ersst_cc, effect = "eca", species = "chum", model = "Ricker model with NPGO, ERSST, CC", xlim = c(-3,3)) + plot_forestry_effect(posterior = ric_chm_cpd_ersst_cc, effect = "cpd", species = "chum", model = "Ricker model with NPGO, ERSST, CC", xlim = c(-3,3)))/(plot_forestry_effect(posterior = ric_chm_eca_ersst, effect = "eca", species = "chum", model = "Ricker model with NPGO, ERSST", xlim = c(-3,3)) +
    plot_forestry_effect(posterior = ric_chm_cpd_ersst, effect = "cpd", species = "chum", model = "Ricker model with NPGO, ERSST", xlim = c(-3,3))) + plot_layout(guides = "collect"))

ric_chm_eca_ersst_cc2 = read.csv(here('stan models','outs','posterior','ric_chm_eca_npgo_ersst_cc2.csv'),check.names=F)

ric_chm_cpd_ersst_cc2 = read.csv(here('stan models','outs','posterior','ric_chm_cpd_npgo_ersst_cc2.csv'),check.names=F)

((plot_forestry_effect(posterior = ric_chm_eca_ersst_cc2, effect = "eca", species = "chum", model = "Ricker model with NPGO, ERSST, \nECA effect on K", xlim = c(-3,3)) + plot_forestry_effect(posterior = ric_chm_cpd_ersst_cc2, effect = "cpd", species = "chum", model = "Ricker model with NPGO, ERSST, \nCPD effect on K", xlim = c(-3,3)))/(plot_forestry_effect(posterior = ric_chm_eca_ersst, effect = "eca", species = "chum", model = "Ricker model with NPGO, ERSST,\nECA effect on productivity", xlim = c(-3,3)) +
    plot_forestry_effect(posterior = ric_chm_cpd_ersst, effect = "cpd", species = "chum", model = "Ricker model with NPGO, ERSST,\nCPD effect on productivity", xlim = c(-3,3))) + plot_layout(guides = "collect"))



```



## Correlation plots

```{r fig.width=12, fig.height=10}

# correlation between max CPD in river and the median effect of CPD in that river for Ricker model

# take median cpd values from ric_chm_cpd_ersst

#make function to take in posterior and effect and return correlation plot

  cor_plot <- function(posterior = ric_chm_cpd_ersst, effect = "cpd", model = "Ricker model with CPD, NPGO, SST"){
  
  if(effect == "cpd"){
    max_df <- ch20rsc %>% 
  select(River, River_n,CU, disturbedarea_prct_cs,area_km2) %>%
  group_by(River) %>% 
  summarize(River_n = first(River_n),
            River = first(River),
            CU = first(CU),
            forestry_max = max(disturbedarea_prct_cs, na.rm = TRUE),
            forestry_level =max(disturbedarea_prct_cs, na.rm = TRUE),
            area_km2 = mean(area_km2, na.rm = TRUE)
            )
    scale_color <- scale_color_gradient2(name = "Max CPD level\nin River (%)",
                                         low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = 50)
    
  } else{
    max_df <- ch20rsc %>% 
  select(River, River_n,CU, ECA_age_proxy_forested_only,area_km2) %>%
  group_by(River) %>%
  summarize(River_n = first(River_n),
            River = first(River),
            CU = first(CU),
            area_km2 = mean(area_km2, na.rm = TRUE),
            forestry_max = 100*max(ECA_age_proxy_forested_only, na.rm =TRUE)) %>% 
  mutate(forestry_level = case_when(forestry_max < 12 ~ 'low',
                               forestry_max >= 12 & forestry_max < 24 ~ 'medium',
                               forestry_max >= 24 ~ 'high'))
    
    scale_color <- scale_color_manual(name = "Max ECA level\nin River (%)",
                                     values = c('low' = '#35978f', 'medium' = 'gray', 'high' = '#bf812d'))
  }
  

  
  posterior_df <- posterior %>%
    select(starts_with('b_for_rv')) %>%
    pivot_longer(cols = everything(), 
                 names_to = 'River', 
                 names_prefix = 'b_for_rv',
                 values_to = effect) %>%
    group_by(River) %>%
    summarize(effect_median = median(!!sym(effect), na.rm = TRUE)) %>%
    ungroup() %>% 
    mutate(River_n = as.numeric(str_extract(River, '\\d+'))) %>% 
    select(-River) %>%
    left_join(max_df, by = 'River_n')
  
  cor <- cor(posterior_df$forestry_max, posterior_df$effect_median, use = "complete.obs")
  
  
  
  cor_plot_model <-   ggplot(posterior_df) +
    geom_point(aes(x = forestry_max,
                   y = effect_median, color = forestry_level,
                   size = area_km2),alpha = 0.5) +
    annotate("text",x = 80, y = min(posterior_df$effect_median), label = paste("Correlation = ", round(cor,2)), show.legend = FALSE, size = 4) +
    xlim(0,100) +
    # ylim(-0.3,0.15) +
    labs(title = model,
         x = paste("Max", effect, "in river (%)"),
         y = paste("Median effect of", effect, "in river")) +
    scale_color +
    theme_classic() +
    theme(legend.position = 'right',
          axis.title.x = element_text(size = 14),
          axis.title.y = element_text(size = 14),
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 12),
          plot.title = element_text(size = 16, hjust = 0.5))

  return(cor_plot_model)
  
}

cor_plot_1 <- cor_plot(posterior = ric_chm_cpd_ersst, effect = "cpd", model = "Ricker model with CPD, NPGO, SST")

cor_plot_2 <- cor_plot(posterior = ric_chm_eca_ersst, effect = "eca", model = "Ricker model with ECA, NPGO, SST")

# cor_plot_1 + cor_plot_2 + plot_layout(guides = "collect")

cor_plot_3 <- cor_plot(posterior = bh_chm_cpd_ersst, effect = "cpd", model = "BH model with CPD, NPGO, SST")

cor_plot_4 <- cor_plot(posterior = bh_chm_eca_ersst, effect = "eca", model = "BH model with ECA, NPGO, SST")

(cor_plot_1 + cor_plot_2 )/( cor_plot_3 + cor_plot_4) + plot_layout(guides = "collect")



```





```{r fig.width=8, fig.height=10}

# make correlation plot between median effects from Ricker model and median effects from BH model

cor_plot_bw_models <- function(posterior1 = ric_chm_cpd_ersst, posterior2 = bh_chm_cpd_ersst, effect = "cpd"){
  
  if(effect == "cpd"){
    max_df <- ch20rsc %>% 
  select(River, River_n,CU, CU_name, disturbedarea_prct_cs,area_km2) %>%
  group_by(River) %>% 
  summarize(River_n = first(River_n),
            River = first(River),
            CU = first(CU),
            CU_name = first(CU_name),
            forestry_max = max(disturbedarea_prct_cs, na.rm = TRUE),
            forestry_level =max(disturbedarea_prct_cs, na.rm = TRUE),
            area_km2 = mean(area_km2, na.rm = TRUE)
            )
    scale_color <- scale_color_gradient2(name = "Max CPD level\nin River (%)",
                                         low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = 50)
    scale_fill <- scale_fill_gradient2(name = "Max CPD level\nin River (%)",
                                       low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = 50)
    
    max_cu_df <- max_df %>% 
      group_by(CU, CU_name) %>% 
      summarize(forestry_mean = mean(forestry_max, na.rm = TRUE),
                area_km2_mean = mean(area_km2, na.rm = TRUE)) 
    
  } else{
    max_df <- ch20rsc %>% 
  select(River, River_n,CU, CU_name, ECA_age_proxy_forested_only,area_km2) %>%
  group_by(River) %>%
  summarize(River_n = first(River_n),
            River = first(River),
            CU = first(CU),
            CU_name = first(CU_name),
            area_km2 = mean(area_km2, na.rm = TRUE),
            forestry_max = 100*max(ECA_age_proxy_forested_only, na.rm =TRUE)) %>% 
  mutate(forestry_level = case_when(forestry_max < 12 ~ 'low',
                               forestry_max >= 12 & forestry_max < 24 ~ 'medium',
                               forestry_max >= 24 ~ 'high'))
    
    scale_color <- scale_color_manual(name = "Max ECA level\nin River (%)",
                                     values = c('low' = '#35978f', 'medium' = 'gray', 'high' = '#bf812d'))
    scale_fill <- scale_fill_manual(name = "Max ECA level\nin River (%)",
                                     values = c('low' = '#35978f', 'medium' = 'gray', 'high' = '#bf812d'))
    
    max_cu_df <- max_df %>%
      group_by(CU, CU_name) %>% 
      summarize(forestry_mean = mean(forestry_max, na.rm = TRUE),
                area_km2_mean = mean(area_km2, na.rm = TRUE))
  }
  
  posterior_df1 <- posterior1 %>%
    select(starts_with('b_for_rv')) %>%
    pivot_longer(cols = everything(), 
                 names_to = 'River', 
                 names_prefix = 'b_for_rv',
                 values_to = effect) %>%
    group_by(River) %>%
    summarize(ric_effect_median = median(!!sym(effect), na.rm = TRUE)) %>%
    ungroup() %>% 
    mutate(River_n = as.numeric(str_extract(River, '\\d+'))) %>% 
    select(-River) 

  posterior_df2 <- posterior2 %>%
    select(starts_with('b_for_rv')) %>%
    pivot_longer(cols = everything(), 
                 names_to = 'River', 
                 names_prefix = 'b_for_rv',
                 values_to = effect) %>%
    group_by(River) %>%
    summarize(bh_effect_median = median(!!sym(effect), na.rm = TRUE)) %>%
    ungroup() %>% 
    mutate(River_n = as.numeric(str_extract(River, '\\d+'))) %>% 
    select(-River)
  
  posterior_df <- left_join(posterior_df1, posterior_df2, by = 'River_n') %>% 
    left_join(max_df, by = 'River_n') %>% 
    left_join(max_cu_df, by = c('CU' = 'CU', 'CU_name' = 'CU_name'))
  
  cor <- cor(posterior_df$ric_effect_median, posterior_df$bh_effect_median, use = "complete.obs")
  
  if(effect == "cpd"){
    cpd_plot <- ggplot(posterior_df,aes(x = ric_effect_median,
                   y = bh_effect_median, color = forestry_level)) +
    geom_point(aes(size = area_km2), alpha = 0.5) +
    annotate("text",x = 0.9*min(posterior_df$ric_effect_median), 
             y = 0.9*max(posterior_df$bh_effect_median), label = paste("Correlation = ", round(cor,2)), 
             size = 4) +
    scale_color +
    scale_fill +
    # xlim(0,100) +
    # ylim(-0.3,0.15) +
    # ellipse around CU
    geom_mark_ellipse(data = posterior_df %>% filter(CU == "CM-4"), aes(label = CU_name),
                      label.buffer = unit(-5, 'mm'), label.fontsize = 8) + 
    geom_mark_ellipse(data = posterior_df %>% filter(CU == "CM-21"), aes(label = CU_name),
                      label.buffer = unit(-5, 'mm'), label.fontsize = 8) +
    geom_mark_ellipse(data = posterior_df %>% filter(CU == "CM-16"), aes(label = CU_name),
                      label.buffer = unit(-5, 'mm'), label.fontsize = 8) +
    geom_mark_ellipse(data = posterior_df %>% filter(CU == "CM-23"), aes(label = CU_name),
                      label.buffer = unit(-5, 'mm'), label.fontsize = 8) +
    geom_mark_ellipse(data = posterior_df %>% filter(CU == "CM-18"), aes(label = CU_name),
                      label.buffer = unit(-5, 'mm'), label.fontsize = 8) +
    # scale_color_manual(values = c('CM-4' = 'red', 'CM-21' = 'blue')) +
    labs(title = toupper(effect),
         x = paste("Median effect of", effect, "in Ricker model"),
         y = paste("Median effect of", effect, "in BH model")) +
    theme_classic() +
    theme(legend.position = 'right',
          axis.title.x = element_text(size = 14),
          axis.title.y = element_text(size = 14),
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 12, angle = 90),
          plot.title = element_text(size = 16, hjust = 0.5))
  } else{
    eca_plot <- ggplot(posterior_df,aes(x = ric_effect_median,
                   y = bh_effect_median, color = forestry_level)) +
    geom_point(aes(size = area_km2), alpha = 0.5) +
    annotate("text",x = 0.9*min(posterior_df$ric_effect_median), 
             y = 0.9*max(posterior_df$bh_effect_median), label = paste("Correlation = ", round(cor,2)), 
             size = 4) +
    scale_color +
    geom_mark_ellipse(data = posterior_df %>% filter(CU == "CM-4"), aes(label = CU_name), color = "gray",
                      label.buffer = unit(-5, 'mm'), label.fontsize = 8) +
    geom_mark_ellipse(data = posterior_df %>% filter(CU == "CM-18"), aes(label = CU_name), color = "gray",
                      label.buffer = unit(-5, 'mm'), label.fontsize = 8) +
    labs(title = toupper(effect),
         x = paste("Median effect of", effect, "in Ricker model"),
         y = paste("Median effect of", effect, "in BH model")) +
    theme_classic() +
    theme(legend.position = 'right',
          axis.title.x = element_text(size = 14),
          axis.title.y = element_text(size = 14),
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 12, angle = 90),
          plot.title = element_text(size = 16, hjust = 0.5))
  }
  
}

cpd_plot1 <- cor_plot_bw_models(posterior1 = ric_chm_cpd_ersst, posterior2 = bh_chm_cpd_ersst, effect = "cpd")



eca_plot1 <- cor_plot_bw_models(posterior1 = ric_chm_eca_ersst, posterior2 = bh_chm_eca_ersst, effect = "eca")

cpd_plot1 / eca_plot1





```


### With corrected BH Model


```{r fig.width=10, fig.height=10}



cor_plot_3_corrected <- cor_plot(posterior = bh_chm_cpd_ersst_correct, effect = "cpd", model = "BH model with CPD, NPGO, SST")

cor_plot_4_corrected <- cor_plot(posterior = bh_chm_eca_ersst_correct, effect = "eca", model = "BH model with ECA, NPGO, SST")

(cor_plot_1 + cor_plot_2 )/( cor_plot_3_corrected + cor_plot_4_corrected) + plot_layout(guides = "collect")



```



```{r fig.width=8, fig.height=10}


cor_plot_bw_models_corrected <- function(posterior1 = ric_chm_cpd_ersst, posterior2 = bh_chm_cpd_ersst, effect = "cpd"){
  
  if(effect == "cpd"){
    max_df <- ch20rsc %>% 
  select(River, River_n,CU, CU_name, disturbedarea_prct_cs,area_km2) %>%
  group_by(River) %>% 
  summarize(River_n = first(River_n),
            River = first(River),
            CU = first(CU),
            CU_name = first(CU_name),
            forestry_max = max(disturbedarea_prct_cs, na.rm = TRUE),
            forestry_level =max(disturbedarea_prct_cs, na.rm = TRUE),
            area_km2 = mean(area_km2, na.rm = TRUE)
            )
    scale_color <- scale_color_gradient2(name = "Max CPD level\nin River (%)",
                                         low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = 50)
    scale_fill <- scale_fill_gradient2(name = "Max CPD level\nin River (%)",
                                       low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = 50)
    
    max_cu_df <- max_df %>% 
      group_by(CU, CU_name) %>% 
      summarize(forestry_mean = mean(forestry_max, na.rm = TRUE),
                area_km2_mean = mean(area_km2, na.rm = TRUE)) 
    
  } else{
    max_df <- ch20rsc %>% 
  select(River, River_n,CU, CU_name, ECA_age_proxy_forested_only,area_km2) %>%
  group_by(River) %>%
  summarize(River_n = first(River_n),
            River = first(River),
            CU = first(CU),
            CU_name = first(CU_name),
            area_km2 = mean(area_km2, na.rm = TRUE),
            forestry_max = 100*max(ECA_age_proxy_forested_only, na.rm =TRUE)) %>% 
  mutate(forestry_level = case_when(forestry_max < 12 ~ 'low',
                               forestry_max >= 12 & forestry_max < 24 ~ 'medium',
                               forestry_max >= 24 ~ 'high'))
    
    scale_color <- scale_color_manual(name = "Max ECA level\nin River (%)",
                                     values = c('low' = '#35978f', 'medium' = 'gray', 'high' = '#bf812d'))
    scale_fill <- scale_fill_manual(name = "Max ECA level\nin River (%)",
                                     values = c('low' = '#35978f', 'medium' = 'gray', 'high' = '#bf812d'))
    
    max_cu_df <- max_df %>%
      group_by(CU, CU_name) %>% 
      summarize(forestry_mean = mean(forestry_max, na.rm = TRUE),
                area_km2_mean = mean(area_km2, na.rm = TRUE))
  }
  
  posterior_df1 <- posterior1 %>%
    select(starts_with('b_for_rv')) %>%
    pivot_longer(cols = everything(), 
                 names_to = 'River', 
                 names_prefix = 'b_for_rv',
                 values_to = effect) %>%
    group_by(River) %>%
    summarize(ric_effect_median = median(!!sym(effect), na.rm = TRUE)) %>%
    ungroup() %>% 
    mutate(River_n = as.numeric(str_extract(River, '\\d+'))) %>% 
    select(-River) 

  posterior_df2 <- posterior2 %>%
    select(starts_with('b_for_rv')) %>%
    pivot_longer(cols = everything(), 
                 names_to = 'River', 
                 names_prefix = 'b_for_rv',
                 values_to = effect) %>%
    group_by(River) %>%
    summarize(bh_effect_median = median(!!sym(effect), na.rm = TRUE)) %>%
    ungroup() %>% 
    mutate(River_n = as.numeric(str_extract(River, '\\d+'))) %>% 
    select(-River)
  
  posterior_df <- left_join(posterior_df1, posterior_df2, by = 'River_n') %>% 
    left_join(max_df, by = 'River_n') %>% 
    left_join(max_cu_df, by = c('CU' = 'CU', 'CU_name' = 'CU_name'))
  
  cor <- cor(posterior_df$ric_effect_median, posterior_df$bh_effect_median, use = "complete.obs")
  
  if(effect == "cpd"){
    cpd_plot <- ggplot(posterior_df,aes(x = ric_effect_median,
                   y = bh_effect_median, color = forestry_level)) +
    geom_point(aes(size = area_km2), alpha = 0.5) +
    annotate("text",x = 0.9*min(posterior_df$ric_effect_median), 
             y = 0.9*max(posterior_df$bh_effect_median), label = paste("Correlation = ", round(cor,2)), 
             size = 4) +
    scale_color +
    scale_fill +
    # xlim(0,100) +
    # ylim(-0.3,0.15) +
    # ellipse around CU
    # geom_mark_ellipse(data = posterior_df %>% filter(CU == "CM-4"), aes(label = CU_name),
    #                   label.buffer = unit(-5, 'mm'), label.fontsize = 8) + 
    # geom_mark_ellipse(data = posterior_df %>% filter(CU == "CM-21"), aes(label = CU_name),
    #                   label.buffer = unit(-5, 'mm'), label.fontsize = 8) +
    # geom_mark_ellipse(data = posterior_df %>% filter(CU == "CM-16"), aes(label = CU_name),
    #                   label.buffer = unit(-5, 'mm'), label.fontsize = 8) +
    # geom_mark_ellipse(data = posterior_df %>% filter(CU == "CM-23"), aes(label = CU_name),
    #                   label.buffer = unit(-5, 'mm'), label.fontsize = 8) +
    # geom_mark_ellipse(data = posterior_df %>% filter(CU == "CM-18"), aes(label = CU_name),
    #                   label.buffer = unit(-5, 'mm'), label.fontsize = 8) +
    # scale_color_manual(values = c('CM-4' = 'red', 'CM-21' = 'blue')) +
    labs(title = toupper(effect),
         x = paste("Median effect of", effect, "in Ricker model"),
         y = paste("Median effect of", effect, "in BH model")) +
    theme_classic() +
    theme(legend.position = 'right',
          axis.title.x = element_text(size = 14),
          axis.title.y = element_text(size = 14),
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 12, angle = 90),
          plot.title = element_text(size = 16, hjust = 0.5))
  } else{
    eca_plot <- ggplot(posterior_df,aes(x = ric_effect_median,
                   y = bh_effect_median, color = forestry_level)) +
    geom_point(aes(size = area_km2), alpha = 0.5) +
    annotate("text",x = 0.9*min(posterior_df$ric_effect_median), 
             y = 0.9*max(posterior_df$bh_effect_median), label = paste("Correlation = ", round(cor,2)), 
             size = 4) +
    scale_color +
    # geom_mark_ellipse(data = posterior_df %>% filter(CU == "CM-4"), aes(label = CU_name), color = "gray",
    #                   label.buffer = unit(-5, 'mm'), label.fontsize = 8) +
    # geom_mark_ellipse(data = posterior_df %>% filter(CU == "CM-18"), aes(label = CU_name), color = "gray",
    #                   label.buffer = unit(-5, 'mm'), label.fontsize = 8) +
    labs(title = toupper(effect),
         x = paste("Median effect of", effect, "in Ricker model"),
         y = paste("Median effect of", effect, "in BH model")) +
    theme_classic() +
    theme(legend.position = 'right',
          axis.title.x = element_text(size = 14),
          axis.title.y = element_text(size = 14),
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 12, angle = 90),
          plot.title = element_text(size = 16, hjust = 0.5))
  }
  
}



cpd_plot1_corrected <- cor_plot_bw_models_corrected(posterior1 = ric_chm_cpd_ersst, posterior2 = bh_chm_cpd_ersst_correct, effect = "cpd")



eca_plot1_corrected <- cor_plot_bw_models_corrected(posterior1 = ric_chm_eca_ersst, posterior2 = bh_chm_eca_ersst_correct, effect = "eca")

cpd_plot1_corrected / eca_plot1_corrected


```



### Models with forestry affecting carrying capacity

```{r fig.width=10, fig.height=10}

cpd_plot1_cc <- cor_plot_bw_models_corrected(posterior1 = ric_chm_cpd_ersst_cc2, posterior2 = bh_chm_cpd_st_cc, effect = "cpd")

eca_plot1_cc <- cor_plot_bw_models_corrected(posterior1 = ric_chm_eca_ersst_cc2, posterior2 = bh_chm_eca_st_cc, effect = "eca")

cpd_plot1_cc / eca_plot1_cc

cor_plot(posterior = bh_chm_cpd_st_cc, effect = "cpd", model = "BH model with CPD effect on K")

cor_plot(posterior = bh_chm_eca_st_cc, effect = "eca", model = "BH model with ECA effect on K")

cor_plot(posterior = ric_chm_cpd_ersst_cc2, effect = "cpd", model = "Ricker model with CPD effect on K")

cor_plot(posterior = ric_chm_eca_ersst_cc2, effect = "eca", model = "Ricker model with ECA effect on K")

```







## Productivity decline

```{r fig.width=10, fig.height=3}


plot_productivity_decline <- function(posterior = bh_chm_eca_sst, effect = "eca", species = "chum", model = "BH model with NPGO, LH SST", by_river = FALSE){
  
  
  if(species == "chum"){
    df <- ch20rsc 
    df$sst.std <- (ch20rsc$spring_ersst-mean(ch20rsc$spring_ersst))/sd(ch20rsc$spring_ersst)
    
  } else if(species == "pink"){
    df <- pk10r
    df$sst.std <- (pk10r$spring_ersst-mean(pk10r$spring_ersst))/sd(pk10r$spring_ersst)
  }
  
  if(effect == "eca"){
    forestry <- seq(0,1,length.out=100)
    b <- posterior %>% select(ends_with("b_for"))
    
    forestry_sqrt <- sqrt(forestry)
  
    forestry_sqrt_std = (forestry_sqrt-mean(forestry_sqrt))/sd(forestry_sqrt)
   
  }else if(effect == "cpd"){
    forestry <- seq(0,100,length.out=100)
    b <- posterior %>% select(ends_with("b_for"))
    forestry_sqrt <- sqrt(forestry)
  
    forestry_sqrt_std = (forestry_sqrt-mean(forestry_sqrt))/sd(forestry_sqrt)
   
  }else if(effect == "sst"){
    forestry <- seq(10,15,length.out=100)
    b <- posterior %>% select(ends_with("b_sst"))
    
    forestry_sqrt_std = (forestry-mean(forestry))/sd(forestry)
    
  }
  
  
  
  no_forestry <- min(forestry_sqrt_std)
  
  # bh_chm_eca_sst=read.csv(here('stan models','outs','posterior',bh_chm_eca_sst),check.names=F)
  
  
  
  global_prediction <- apply(exp(as.matrix(b[,1])%*%
                                 (forestry_sqrt_std-no_forestry))*100 - 100,2,median)
  
  global_025 <- apply(exp(as.matrix(b[,1])%*%
                          (forestry_sqrt_std-no_forestry))*100 - 100,2,quantile,c(0.025), 
                      row.names = c("q025"))
  
  global_975 <- apply(exp(as.matrix(b[,1])%*%
                          (forestry_sqrt_std-no_forestry))*100 - 100,2,quantile,c(0.975),
                      row.names = c("q975"))
  
  global_df <- data.frame(forestry = forestry,
                          productivity_median = global_prediction,
                          q025 = global_025,
                          q975 = global_975)
  
  full_productivity <- NULL
  
  if(by_river){
    
  # no_forestry <- min(eca_std_sqrt)
    for (i in 1:length(unique(df$River_n))){
      river <- unique(df$River_n)[i]
      
      river_data <- df %>% filter(River_n == river)
      
      if(effect == "eca"){
        b_rv <- posterior %>% select(starts_with("b_for_rv")) %>%
        select(ends_with(paste0("[",river,"]")))
        
        forestry_sqrt_std_river <- seq(min(river_data$sqrt.ECA.std),max(river_data$sqrt.ECA.std),length.out=100)
        
        forestry_river <- seq(min(river_data$ECA_age_proxy_forested_only),max(river_data$ECA_age_proxy_forested_only),length.out=100)
        
        
      } else if(effect == "cpd"){
        b_rv <- posterior %>% select(starts_with("b_for_rv")) %>%
        select(ends_with(paste0("[",river,"]")))
        
        forestry_sqrt_std_river <- seq(min(river_data$sqrt.CPD.std),max(river_data$sqrt.CPD.std),length.out=100)
        
        forestry_river <- seq(min(river_data$disturbedarea_prct_cs),max(river_data$disturbedarea_prct_cs),length.out=100)
        
        
      } else if(effect == "sst"){
        b_rv <- posterior %>% select(starts_with("b_sst_rv")) %>%
        select(ends_with(paste0("[",river,"]")))
        
        # use only spring_ersst
        
        forestry_sqrt_std_river <- seq(min(river_data$sst.std),max(river_data$sst.std),length.out=100)
        
        forestry_river <- seq(min(river_data$spring_ersst),max(river_data$spring_ersst),length.out=100)
        
      }
      
      
  
      
      
      
      
      productivity <- (exp(as.matrix(b_rv[,1])%*%
                             (forestry_sqrt_std-no_forestry)))*100 - 100
      
      productivity_median <- apply(productivity,2,median)
      
      productivity_median_df <- data.frame(River = unique(river_data$River),
                                           productivity_median = productivity_median,
                                           forestry = forestry_river) %>% 
    filter(forestry >= min(forestry_river), forestry <= max(forestry_river))
      
      full_productivity <- rbind(full_productivity, productivity_median_df)
      
    }
    
    # b <- posterior %>% select(ends_with("b_for"))
    
    median_prediction <- apply(exp(as.matrix(b[,1])%*%
                                  (forestry_sqrt_std-no_forestry))*100 - 100,2,median)
    
    median_df <- data.frame(forestry = forestry,
                            productivity_median = median_prediction)
    
    if(effect == "eca" || effect == "cpd"){
      p1 <- ggplot(full_productivity) +
      geom_line(aes(x = forestry, y = productivity_median, group = River,
                    color = "watershed level\nforestry effect"),alpha=0.5) +
      geom_line(data = global_df, 
                aes(x = forestry, y = productivity_median, color = "global forestry effect"), linewidth = 1) +
      geom_ribbon(data = global_df, aes(x = forestry, ymin = q025, ymax = q975),
                  alpha = 0.5, fill = "gray") +
      # scale_fill_manual("",values  = c("95% credible interval" = "gray")) +
      scale_color_manual("",values = c("watershed level\nforestry effect" = "darkgray", 
                                       "global forestry effect" = "black")) +
      ylim(-100,100) +
      scale_x_continuous(n.breaks = 5) +
      labs(title = model,
        x = ifelse(effect == "eca", "Equivalent clearcut area", "Cumulative percent disturbed (%)"),
        y = "Median change\n in productivity (%)") +
      theme_classic() +
      theme(legend.position = c(0.8,0.8),
            legend.title = element_blank(),
            legend.key.size = unit(0.5, "cm"),
            legend.key.width = unit(1, "cm"),
            axis.title.x = element_text(size = 12),
            axis.title.y = element_text(size = 12),
            axis.text.x = element_text(size = 10),
            axis.text.y = element_text(size = 10),
            plot.title = element_text(size = 14, hjust = 0.5))+
      guides(color = guide_legend(override.aes = list(alpha = 1, linewidth = 1.5)))
    } else if(effect == "sst"){
      p1 <- ggplot(full_productivity) +
      geom_line(aes(x = forestry, y = productivity_median, group = River,
                    color = "watershed level\nSST effect"),alpha=0.5) +
      geom_line(data = global_df, 
                aes(x = forestry, y = productivity_median, color = "global SST effect"), linewidth = 1) +
      geom_ribbon(data = global_df, aes(x = forestry, ymin = q025, ymax = q975),
                  alpha = 0.5, fill = "gray") +
      # scale_fill_manual("",values  = c("95% credible interval" = "gray")) +
      scale_color_manual("",values = c("watershed level\nSST effect" = "darkgray", 
                                       "global SST effect" = "black")) +
      ylim(-100,100) +
      scale_x_continuous(n.breaks = 5, limits = c(10,15)) +
      labs(title = model,
        x = "Spring SST (°C)",
        y = "Median change\n in productivity (%)") +
      theme_classic() +
      theme(legend.position = c(0.8,0.8),
            legend.title = element_blank(),
            legend.key.size = unit(0.5, "cm"),
            legend.key.width = unit(1, "cm"),
            axis.title.x = element_text(size = 12),
            axis.title.y = element_text(size = 12),
            axis.text.x = element_text(size = 10),
            axis.text.y = element_text(size = 10),
            plot.title = element_text(size = 14, hjust = 0.5))+
      guides(color = guide_legend(override.aes = list(alpha = 1, linewidth = 1.5)))
    }
} else {
  
  if(effect == "eca" || effect == "cpd"){
    p1 <- ggplot(full_productivity) +
    # geom_line(aes(x = forestry, y = productivity_median, group = River,
    #               color = "watershed level\nforestry effect"),alpha=0.5) +
    geom_line(data = global_df, 
              aes(x = forestry, y = productivity_median, color = "global forestry effect"), linewidth = 1) +
    geom_ribbon(data = global_df, aes(x = forestry, ymin = q025, ymax = q975),
                alpha = 0.5, fill = "gray") +
    # scale_fill_manual("",values  = c("95% credible interval" = "gray")) +
    scale_color_manual("",values = c("global forestry effect" = "black")) +
    ylim(-100,100) +
    scale_x_continuous(n.breaks = 5) +
    labs(title = model,
      x = ifelse(effect == "eca", "Equivalent clearcut area", "Cumulative percent disturbed (%)"),
      y = "Median change\n in productivity (%)") +
    theme_classic() +
    theme(legend.position = c(0.8,0.8),
          legend.title = element_blank(),
          legend.key.size = unit(0.5, "cm"),
          legend.key.width = unit(1, "cm"),
          axis.title.x = element_text(size = 12),
          axis.title.y = element_text(size = 12),
          axis.text.x = element_text(size = 10),
          axis.text.y = element_text(size = 10),
          plot.title = element_text(size = 14, hjust = 0.5))+
    guides(color = guide_legend(override.aes = list(alpha = 1, linewidth = 1.5)))
  } else if(effect == "sst"){
    p1 <- ggplot(full_productivity) +
    # geom_line(aes(x = forestry, y = productivity_median, group = River,
    #               color = "watershed level\nSST effect"),alpha=0.5) +
    geom_line(data = global_df, 
              aes(x = forestry, y = productivity_median, color = "global SST effect"), linewidth = 1) +
    geom_ribbon(data = global_df, aes(x = forestry, ymin = q025, ymax = q975),
                alpha = 0.5, fill = "gray") +
    # scale_fill_manual("",values  = c("95% credible interval" = "gray")) +
    scale_color_manual("",values = c("global SST effect" = "black")) +
                                      
    ylim(-100,100) +
    scale_x_continuous(n.breaks = 5, limits = c(10,15)) +
    labs(title = model,
      x = "Spring SST (°C)",
      y = "Median change\n in productivity (%)") +
    theme_classic() +
    theme(legend.position = c(0.8,0.8),
          legend.title = element_blank(),
          legend.key.size = unit(0.5, "cm"),
          legend.key.width = unit(1, "cm"),
          axis.title.x = element_text(size = 12),
          axis.title.y = element_text(size = 12),
          axis.text.x = element_text(size = 10),
          axis.text.y = element_text(size = 10),
          plot.title = element_text(size = 14, hjust = 0.5))+
    guides(color = guide_legend(override.aes = list(alpha = 1, linewidth = 1.5)))
  }
}
  
  return(p1)
  
}

((plot_productivity_decline(posterior = bh_chm_eca_ersst, effect = "eca", species = "chum", model = "BH model with NPGO, ERSST", by_river = FALSE) +
    plot_productivity_decline(posterior = bh_chm_cpd_ersst, effect = "cpd", species = "chum", model = "BH model with NPGO, ERSST", by_river = FALSE) )/(plot_productivity_decline(posterior = ric_chm_eca_ersst, effect = "eca", species = "chum", model = "Ricker model with NPGO, ERSST", by_river = FALSE) +
    plot_productivity_decline(posterior = ric_chm_cpd_ersst, effect = "cpd", species = "chum", model = "Ricker model with NPGO, ERSST", by_river = FALSE))) + plot_layout(guides = "collect") 



```

```{r fig.width = 10, fig.height = 3}
(plot_productivity_decline(posterior = bh_chm_cpd_ersst, effect = "sst", species = "chum", model = "BH model with NPGO, ERSST", by_river = FALSE) + plot_productivity_decline(posterior = ric_chm_cpd_ersst, effect = "sst", species = "chum", model = "Ric model with NPGO, ERSST", by_river = FALSE))+ plot_layout(guides = "collect")



```

## Effect of SST

```{r fig.width = 12, fig.height = 6}
plot_sst_effect <- function(posterior = bh_chm_eca_sst, effect = "sst", species = "chum", model = "BH model with NPGO", 
                            color_by = "CU_name", xlim = c(-1, 1)) {
  
  if(species == "chum"){
    df <- ch20rsc
    posterior_rv <- posterior %>% 
    dplyr::select(starts_with('b_sst_rv')) %>%
    pivot_longer(cols = everything(), 
                 names_to = 'River', 
                 names_prefix = 'b_sst_rv',
                 values_to = 'sst_effect') %>%
    mutate(River_n = as.numeric(str_extract(River, '\\d+'))) %>% 
    dplyr::select(-River) %>%
  left_join(df %>% dplyr::select(River_n, CU, CU_name, X_LONG, Y_LAT) %>% 
              distinct(), by = 'River_n')
    
  } else if(species == "pink"){
    df <- pk10r
    posterior_rv <- posterior %>% 
    dplyr::select(starts_with('b_sst_rv')) %>%
    pivot_longer(cols = everything(), 
                 names_to = 'River', 
                 names_prefix = 'b_sst_rv',
                 values_to = 'sst_effect') %>%
    mutate(River_n = as.numeric(str_extract(River, '\\d+'))) %>% 
    dplyr::select(-River) %>%
  left_join(df %>% dplyr::select(River_n, X_LONG, Y_LAT) %>% 
              distinct(), by = 'River_n')
  }
  
  
  
  if(color_by == "CU_name"){
    color_var = "CU_name"
    color_name = "CU"
    scale_color = scale_color_iwanthue(name = 'CU', hmin = 0, hmax = 360, cmin = 0, cmax = 80,
                                       lmin = 10, lmax = 95)
    
    
  } else if(color_by == "Y_LAT"){
    color_var = "Y_LAT"
    color_name = "Latitude"
    scale_color = scale_color_viridis_c(name = 'Latitude', direction = -1)
    
    
  } else if(color_by == "CU"){
    
    color_var = "CU"
    color_name = "CU"
    scale_color = scale_color_iwanthue(name = 'CU', hmin = 0, hmax = 360, cmin = 0, cmax = 80,
                                       lmin = 10, lmax = 95)
    
  } 
  
  if(species == "chum"){
    p1 <- ggplot()+
    stat_density(data= posterior_rv, aes(sst_effect, color = !!sym(color_by), group = River_n),
                 geom = 'line', position = 'identity', 
                 alpha = 0.03, linewidth = 1) +
    geom_vline(xintercept = 0, color = 'slategray', linewidth = 0.8) +
    labs(title = model, 
         x = 'Standardized coefficients of SST', y = 'Posterior density\nof SST effect') +
    xlim(xlim[1], xlim[2]) +
    geom_density(aes(posterior$b_sst), color = 'black', linewidth = 1.2, alpha = 0.2)+
    # scale_color_iwanthue(name = 'CU', hmin = 0, hmax = 360, cmin = 0, cmax = 80,
    #                      lmin = 10, lmax = 95) +
    scale_color +
    geom_vline(xintercept = median(posterior$b_sst), color = 'black', linetype = 'dashed') + 
    theme_classic()+
    theme(legend.position = "right",
        legend.key.width = unit(0.5, "cm"),
        legend.key.height = unit(0.4, "lines"),
        legend.text = element_text(size = 7),
        legend.spacing.y = unit(0.001, "cm"),
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(size = 16, hjust = 0.5)
        )+
  guides(color = guide_legend(override.aes = list(alpha = 1, linewidth = 2), ncol = 1))
  } else if(species == "pink"){
    p1 <- ggplot()+
    stat_density(data= posterior_rv, aes(sst_effect, group = River_n),
                 geom = 'line', position = 'identity', color = "gray",
                 alpha = 0.03, linewidth = 1) +
    geom_vline(xintercept = 0, color = 'slategray', linewidth = 0.8) +
    labs(title = model, 
         x = 'Standardized coefficients of SST', y = 'Posterior density\nof SST effect') +
    xlim(xlim[1], xlim[2]) +
    geom_density(aes(posterior$b_sst), color = 'black', linewidth = 1.2, alpha = 0.2)+
    # scale_color_iwanthue(name = 'CU', hmin = 0, hmax = 360, cmin = 0, cmax = 80,
    #                      lmin = 10, lmax = 95) +
    geom_vline(xintercept = median(posterior$b_sst), color = 'black', linetype = 'dashed') + 
    theme_classic()+
    theme(legend.position = "right",
        legend.key.width = unit(0.5, "cm"),
        legend.key.height = unit(0.4, "lines"),
        legend.text = element_text(size = 7),
        legend.spacing.y = unit(0.001, "cm"),
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(size = 16, hjust = 0.5)
        )+
  guides(color = guide_legend(override.aes = list(alpha = 1, linewidth = 2), ncol = 1))
  }
  
  return(p1)
  
}

plot_sst_effect(posterior = bh_chm_eca_ersst_pdo, effect = "cpd", species = "chum", model = "BH model with NPGO, ERSST, PDO")

(plot_sst_effect(posterior = bh_chm_eca_ersst, effect = "cpd", species = "chum", model = "BH model with CPD, NPGO, ERSST", xlim = c(-0.5,0.5)) + plot_sst_effect(posterior = ric_chm_cpd_ersst, effect = "cpd", species = "chum", model = "Ric model with CPD, NPGO, ERSST", xlim = c(-0.5,0.5)))/(plot_sst_effect(posterior = bh_chm_eca_ersst, effect = "cpd", species = "chum", model = "BH model with CPD, NPGO, ERSST", xlim = c(-0.5,0.5),color_by = "Y_LAT") + plot_sst_effect(posterior = ric_chm_cpd_ersst, effect = "cpd", species = "chum", model = "Ric model with CPD, NPGO, ERSST", xlim = c(-0.5,0.5),color_by = "Y_LAT"))+ plot_layout(guides = "collect")

```

## Effect of NPGO

```{r fig.width = 12, fig.height = 3}
plot_npgo_effect <- function(posterior = bh_chm_eca_npgo, effect = "npgo", species = "chum", model = "BH model with NPGO", xlim = c(-0.5,0.5)) {
  
  
  
  if(species == "chum"){
    df <- ch20rsc
  } else if(species == "pink"){
    df <- pk10r
  }
  
  posterior_rv <- posterior %>% 
    select(starts_with('b_npgo_rv')) %>%
    pivot_longer(cols = everything(), 
                 names_to = 'River', 
                 names_prefix = 'b_npgo_rv',
                 values_to = 'npgo_effect') %>%
    mutate(River_n = as.numeric(str_extract(River, '\\d+'))) %>% 
    select(-River) %>%
  left_join(df %>% select(River_n, CU, CU_name, X_LONG, Y_LAT) %>% distinct(), by = 'River_n')
  
  if(species == "chum"){
    p1 <- ggplot()+
    stat_density(data= posterior_rv, aes(npgo_effect, color = CU_name, group = River_n),
                 geom = 'line', position = 'identity', 
                 alpha = 0.03, linewidth = 1) +
    geom_vline(xintercept = 0, color = 'slategray', linewidth = 0.8) +
    labs(title = model, 
         x = 'Standardized coefficients of NPGO', y = 'Posterior density\nof NPGO effect') +
    xlim(xlim[1], xlim[2]) +
    geom_density(aes(posterior$b_npgo), color = 'black', linewidth = 1.2, alpha = 0.2)+
    scale_color_iwanthue(name = 'CU', hmin = 0, hmax = 360, cmin = 0, cmax = 80,
                         lmin = 10, lmax = 95) +
    geom_vline(xintercept = median(posterior$b_npgo), color = 'black', linetype = 'dashed') + 
    theme_classic()+
    theme(legend.position = "right",
        legend.key.width = unit(0.5, "cm"),
        legend.key.height = unit(0.4, "lines"),
        legend.text = element_text(size = 7),
        legend.spacing.y = unit(0.001, "cm"),
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(size = 16, hjust = 0.5)
        )+
  guides(color = guide_legend(override.aes = list(alpha = 1, linewidth = 2), ncol = 1))
    
    
  } else if(species == "pink"){
    p1 <- ggplot()+
    stat_density(data= posterior_rv, aes(npgo_effect, group = River_n),
                 geom = 'line', position = 'identity', color ="gray",
                 alpha = 0.03, linewidth = 1) +
    geom_vline(xintercept = 0, color = 'slategray', linewidth = 0.8) +
    labs(title = model, 
         x = 'Standardized coefficients of NPGO', y = 'Posterior density\nof NPGO effect') +
    xlim(xlim[1], xlim[2]) +
    geom_density(aes(posterior$b_npgo), color = 'black', linewidth = 1.2, alpha = 0.2)+
    # scale_color_iwanthue(name = 'CU', hmin = 0, hmax = 360, cmin = 0, cmax = 80,
    #                      lmin = 10, lmax = 95) +
    geom_vline(xintercept = median(posterior$b_npgo), color = 'black', linetype = 'dashed') + 
    theme_classic()+
    theme(legend.position = "right",
        legend.key.width = unit(0.5, "cm"),
        legend.key.height = unit(0.4, "lines"),
        legend.text = element_text(size = 7),
        legend.spacing.y = unit(0.001, "cm"),
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(size = 16, hjust = 0.5)
        )+
  guides(color = guide_legend(override.aes = list(alpha = 1, linewidth = 2), ncol = 1))
  }
  
  
  
  return(p1)
  
}

(plot_npgo_effect(posterior = bh_chm_eca_ersst, effect = "cpd", species = "chum", model = "BH model with NPGO, ERSST") +
  plot_npgo_effect(posterior = ric_chm_cpd_ersst, effect = "cpd", species = "chum", model = "Ric model with NPGO, ERSST")) + plot_layout(guides = "collect")

```


## Effect of PDO

```{r fig.width = 12, fig.height = 5}

plot_pdo_effect <- function(posterior = bh_chm_eca_ersst_pdo, 
                            effect = "pdo", 
                            species = "chum", 
                            model = "BH model with NPGO, ERSST, PDO", xlim = c(-0.5,0.5)) {
  
  
  
  if(species == "chum"){
    df <- ch20rsc
  } else if(species == "pink"){
    df <- pk10r
  }
  
  posterior_rv <- posterior %>% 
    select(starts_with('b_pdo_rv')) %>%
    pivot_longer(cols = everything(), 
                 names_to = 'River', 
                 names_prefix = 'b_pdo_rv',
                 values_to = 'pdo_effect') %>%
    mutate(River_n = as.numeric(str_extract(River, '\\d+'))) %>% 
    select(-River) %>%
  left_join(df %>% select(River_n, CU, CU_name, X_LONG, Y_LAT) %>% distinct(), by = 'River_n')
  
  if(species == "chum"){
    p1 <- ggplot()+
    stat_density(data= posterior_rv, aes(pdo_effect, color = CU_name, group = River_n),
                 geom = 'line', position = 'identity', 
                 alpha = 0.1, linewidth = 1) +
    geom_vline(xintercept = 0, color = 'slategray', linewidth = 0.8) +
    labs(title = model, 
         x = 'Standardized coefficients of PDO', y = 'Posterior density\nof PDO effect') +
    xlim(xlim[1], xlim[2]) +
    geom_density(aes(posterior$b_pdo), color = 'black', linewidth = 1.2, alpha = 0.2)+
    scale_color_iwanthue(name = 'CU', hmin = 0, hmax = 360, cmin = 0, cmax = 80,
                         lmin = 10, lmax = 95) +
    geom_vline(xintercept = median(posterior$b_pdo), color = 'black', linetype = 'dashed') + 
    theme_classic()+
    theme(legend.position = "right",
        legend.key.width = unit(0.5, "cm"),
        legend.key.height = unit(0.4, "lines"),
        legend.text = element_text(size = 7),
        legend.spacing.y = unit(0.001, "cm"),
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(size = 16, hjust = 0.5)
        )+
  guides(color = guide_legend(override.aes = list(alpha = 1, linewidth = 2), ncol = 1))
    
    
  } else if(species == "pink"){
    p1 <- ggplot()+
    stat_density(data= posterior_rv, aes(pdo_effect, group = River_n),
                 geom = 'line', position = 'identity', color = "gray",
                 alpha = 0.1, linewidth = 1) +
    geom_vline(xintercept = 0, color = 'slategray', linewidth = 0.8) +
    labs(title = model, 
         x = 'Standardized coefficients of PDO', y = 'Posterior density\nof PDO effect') +
    xlim(xlim[1], xlim[2]) +
    geom_density(aes(posterior$b_pdo), color = 'black', linewidth = 1.2, alpha = 0.2)+
    scale_color_iwanthue(name = 'CU', hmin = 0, hmax = 360, cmin = 0, cmax = 80,
                         lmin = 10, lmax = 95) +
    geom_vline(xintercept = median(posterior$b_pdo), color = 'black', linetype = 'dashed') + 
    theme_classic()+
    theme(legend.position = "right",
        legend.key.width = unit(0.5, "cm"),
        legend.key.height = unit(0.4, "lines"),
        legend.text = element_text(size = 7),
        legend.spacing.y = unit(0.001, "cm"),
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(size = 16, hjust = 0.5)
        )+
      
  guides(color = guide_legend(override.aes = list(alpha = 1, linewidth = 2), ncol = 1))
  }
  
  return(p1)
}

(plot_pdo_effect(posterior = bh_chm_eca_ersst_pdo, effect = "cpd", species = "chum", model = "BH model with NPGO, ERSST, PDO",
                 xlim = c(-0.75,0.75))  + plot_layout(guides = "collect"))



```


## Residual plots

```{r, residual-plots, fig.width = 12, fig.height = 8, results="asis"}
  
df <- ch20rsc

posterior <- ric_chm_cpd_ersst

posterior_bh <- bh_chm_cpd_ersst

posterior_a_t <- ric_chm_cpd

posterior_a_t_bh <- bh_chm_cpd


rivers <- unique(df$River_n)

# plotting residuals of ricker model vs predicted values of ricker model for all rivers combined

residual_df_full_chum <- data.frame()

residual_bh_df_full_chum <- data.frame()

for(river in rivers){
  
  river_data <- df %>% filter(River_n == river)
  
  posterior_rv_b_for <- posterior %>% 
      select(starts_with('b_for_rv')) %>%
      select(ends_with(paste0("[",river,"]")))
  
  posterior_rv_b_npgo <- posterior %>% 
      select(starts_with('b_npgo_rv')) %>%
      select(ends_with(paste0("[",river,"]")))
  
  posterior_rv_b_sst <- posterior %>% 
      select(starts_with('b_sst_rv')) %>%
      select(ends_with(paste0("[",river,"]")))
  
  posterior_rv_alpha_j <- posterior %>% 
      select(starts_with('alpha_j')) %>%
      select(ends_with(paste0("[",river,"]")))
  
  posterior_rv_S_max <- posterior %>% 
      select(starts_with('Smax')) %>%
      select(ends_with(paste0("[",river,"]")))
  
  
  residual_df <- data.frame(spawners = river_data$Spawners,
                              recruits = river_data$Recruits,
                              observed_log_RS = river_data$ln_RS,
                              predicted_log_RS = apply((matrix(posterior_rv_alpha_j[,1], ncol = length(river_data$Spawners), nrow = length(posterior_rv_alpha_j[,1])) - as.matrix(1/posterior_rv_S_max)%*%river_data$Spawners + as.matrix(posterior_rv_b_for)%*%river_data$sqrt.CPD.std +
                                                          as.matrix(posterior_rv_b_npgo)%*%river_data$npgo.std + 
                                                          as.matrix(posterior_rv_b_sst)%*%river_data$sst.std ), 2, median),
                                                        
                              cpd = river_data$disturbedarea_prct_cs,
                            sqrt.CPD.std = river_data$sqrt.CPD.std,
                            forestry_effect = apply(as.matrix(posterior_rv_b_for)%*%river_data$sqrt.CPD.std , 2, median)
    )
    
    residual_df$residuals <- residual_df$observed_log_RS - residual_df$predicted_log_RS
    
    residual_df$partial_residuals <- residual_df$residuals + residual_df$forestry_effect
      
    residual_df_full_chum <- rbind(residual_df_full_chum, residual_df)
    
    posterior_bh_rv_b_for <- posterior_bh %>% 
      select(starts_with('b_for_rv')) %>%
      select(ends_with(paste0("[",river,"]")))
    
    posterior_bh_rv_b_npgo <- posterior_bh %>% 
      select(starts_with('b_npgo_rv')) %>%
      select(ends_with(paste0("[",river,"]")))
    
    posterior_bh_rv_b_sst <- posterior_bh %>%
      select(starts_with('b_sst_rv')) %>%
      select(ends_with(paste0("[",river,"]")))
    
    posterior_bh_rv_alpha_j <- posterior_bh %>%
      select(starts_with('alpha_j')) %>%
      select(ends_with(paste0("[",river,"]")))
    
    posterior_bh_rv_Rk <- posterior_bh %>%
      select(starts_with('Rk')) %>%
      select(ends_with(paste0("[",river,"]")))
    
    residual_bh_df <- data.frame(spawners = river_data$Spawners,
                              recruits = river_data$Recruits,
                              observed_log_RS = river_data$ln_RS,
                              predicted_log_RS = apply((matrix(posterior_bh_rv_alpha_j[,1], ncol = length(river_data$Spawners), nrow = length(posterior_bh_rv_alpha_j[,1])) - log(1+as.matrix(exp(posterior_bh_rv_alpha_j[,1])/posterior_bh_rv_Rk)%*%river_data$Spawners) +
                                                          as.matrix(posterior_bh_rv_b_for)%*%river_data$sqrt.CPD.std +
                                                          as.matrix(posterior_bh_rv_b_npgo)%*%river_data$npgo.std + 
                                                          as.matrix(posterior_bh_rv_b_sst)%*%river_data$sst.std), 2, median),
                              cpd = river_data$disturbedarea_prct_cs,
                              forestry_effect = apply(as.matrix(posterior_bh_rv_b_for)%*%river_data$sqrt.CPD.std, 2, median),
                              sqrt.CPD.std = river_data$sqrt.CPD.std
    )
    
    residual_bh_df$residuals <- residual_bh_df$observed_log_RS - residual_bh_df$predicted_log_RS
    
    residual_bh_df$partial_residuals <- residual_bh_df$residuals + residual_bh_df$forestry_effect
    
    residual_bh_df_full_chum <- rbind(residual_bh_df_full_chum, residual_bh_df)
    
}

p_ric_residuals_chum <- ggplot(residual_df_full_chum)+
  geom_point(aes(x = predicted_log_RS, y = residuals, color = cpd), alpha = 0.2, size = 2) +
  geom_hline(yintercept = 0, color = 'black', linetype = 'dashed') +
  labs(title = "Ricker model with CPD, NPGO, ERSST", x = TeX(r"(Predicted $\log \left(\frac{Recruits}{Spawners}\right)$)"), y = "Residuals") +
  scale_color_gradient2(name = 'CPD (%)',
                                        low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = 50)+
  ylim(-6, 6) +
  theme_classic() +
  
  theme(legend.position = "right",
        legend.key.width = unit(0.5, "cm"),
        legend.key.height = unit(1, "lines"),
        legend.text = element_text(size = 7),
        legend.spacing.y = unit(0.001, "cm"),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(size = 16, hjust = 0.5)
        )


p_ric_partial_residuals_chum <- ggplot(residual_df_full_chum)+
  geom_point(aes(x = sqrt.CPD.std, y = partial_residuals, color = cpd), alpha = 0.2, size = 2) +
  geom_hline(yintercept = 0, color = 'black', linetype = 'dashed') +
  geom_smooth(aes(x = sqrt.CPD.std, y = partial_residuals), method = 'lm', se = TRUE, color = 'black') +
  labs(title = "Ricker model with CPD, NPGO, ERSST", x = TeX(r"($standardized\ \sqrt{CPD}$)"), 
       y = TeX(r"(Residuals + $\beta_{forestry, river} \times standardized\ \sqrt{CPD}$)")) +
  scale_color_gradient2(name = 'CPD (%)',
                                        low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = 50)+
  ylim(-6, 6) +
  theme_classic() +
  
  theme(legend.position = "right",
        legend.key.width = unit(0.5, "cm"),
        legend.key.height = unit(1, "lines"),
        legend.text = element_text(size = 7),
        legend.spacing.y = unit(0.001, "cm"),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(size = 16, hjust = 0.5)
        )



p_bh_residuals_chum <- ggplot(residual_bh_df_full_chum)+
  geom_point(aes(x = predicted_log_RS, y = residuals, color = cpd), alpha = 0.2, size = 2) +
  geom_hline(yintercept = 0, color = 'black', linetype = 'dashed') +
  labs(title = "BH model with CPD, NPGO, ERSST", x = TeX(r"(Predicted $\log \left(\frac{Recruits}{Spawners}\right)$)"), y = "Residuals") +
  scale_color_gradient2(name = 'CPD (%)',
                                        low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = 50)+
  ylim(-6, 6) +
  theme_classic() +
  theme(legend.position = "right",
        legend.key.width = unit(0.5, "cm"),
        legend.key.height = unit(1, "lines"),
        legend.text = element_text(size = 7),
        legend.spacing.y = unit(0.001, "cm"),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(size = 16, hjust = 0.5)
        )


p_bh_partial_residuals_chum <- ggplot(residual_bh_df_full_chum)+
  geom_point(aes(x = sqrt.CPD.std, y = partial_residuals, color = cpd), alpha = 0.2, size = 2) +
  geom_hline(yintercept = 0, color = 'black', linetype = 'dashed') +
  geom_smooth(aes(x = sqrt.CPD.std, y = partial_residuals), method = 'lm', se = TRUE, color = 'black') +
  labs(title = "BH model with CPD, NPGO, ERSST", x = TeX(r"($standardized\ \sqrt{CPD}$)"), 
       y = TeX(r"(Residuals + $\beta_{forestry, river} \times standardized\ \sqrt{CPD}$)")) +
  scale_color_gradient2(name = 'CPD (%)',
                                        low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = 50)+
  ylim(-6, 6) +
  theme_classic() +
  theme(legend.position = "right",
        legend.key.width = unit(0.5, "cm"),
        legend.key.height = unit(1, "lines"),
        legend.text = element_text(size = 7),
        legend.spacing.y = unit(0.001, "cm"),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(size = 16, hjust = 0.5)
        )


print((p_ric_residuals_chum + p_bh_residuals_chum)/(p_ric_partial_residuals_chum + p_bh_partial_residuals_chum) + plot_layout(guides = "collect"))
    
    


```


\newpage

## Spawner-Recruit fits

```{r, spawner-recruit, fig.width = 10, fig.height = 8, results="asis"}

# function to plot recruit vs spawner for chum for each river
# data in points
# and prediction with line and credible intervals with shading
# use ricker model with cpd, npgo, ersst

plot_recruit_spawner <- function(data, species = "chum", river, river_data,  posterior, posterior_bh, posterior_a_t, posterior_a_t_bh){
  
  # river_data <- df %>% filter(River_n == river)
  
  
  
  if(species == "chum"){
    posterior_rv_b_for <- posterior %>% 
      select(starts_with('b_for_rv')) %>%
      select(ends_with(paste0("[",river,"]")))
    
    posterior_rv_alpha_j <- posterior %>% 
      select(starts_with('alpha_j')) %>%
      select(ends_with(paste0("[",river,"]")))
    
    posterior_rv_S_max <- posterior %>% 
      select(starts_with('Smax')) %>%
      select(ends_with(paste0("[",river,"]")))
    
    #bh
    
    posterior_bh_rv_b_for <- posterior_bh %>% 
      select(starts_with('b_for_rv')) %>%
      select(ends_with(paste0("[",river,"]")))
    
    posterior_bh_rv_alpha_j <- posterior_bh %>%
      select(starts_with('alpha_j')) %>%
      select(ends_with(paste0("[",river,"]")))
    
    posterior_bh_rv_Rk <- posterior_bh %>%
      select(starts_with('Rk')) %>%
      select(ends_with(paste0("[",river,"]")))
    
  } else if(species == "pink"){
    
    river_wo_broodline <- river_data$River_n
    river_w_broodline <- river_data$River_n2
    
    posterior_rv_b_for <- posterior %>% 
      select(starts_with('b_for_rv')) %>%
      select(ends_with(paste0("[",river_wo_broodline,"]")))
    
    posterior_rv_alpha_j <- posterior %>% 
      select(starts_with('alpha_j')) %>%
      select(ends_with(paste0("[",river_w_broodline,"]")))
    
    posterior_rv_S_max <- posterior %>% 
      select(starts_with('Smax')) %>%
      select(ends_with(paste0("[",river_w_broodline,"]")))
    
    #time varying productivity for ricker
    
    # if(river_data$Broodline[1] == "Even"){
    #   
    #   posterior_a_t_alpha_j <- posterior_a_t %>% 
    #   select(starts_with('alpha_j')) %>%
    #   select(ends_with(paste0("[",river_w_broodline,"]")))
    #   
    #   posterior_a_t_alpha_t <- posterior_a_t %>%
    #   select(starts_with('alpha_t[1,'))
    #   
    #   posterior_a_t_alpha_t_j_full <- matrix(posterior_a_t_alpha_j[,1], ncol = length(posterior_a_t_alpha_t), nrow = length(posterior_a_t_alpha_j[,1])) + posterior_a_t_alpha_t
    #   
    #   posterior_a_t_alpha_t_j <- posterior_a_t_alpha_t_j_full %>%
    #     pivot_longer(cols = everything(), names_to = "year", values_to = "alpha_t_odd") %>%
    #     mutate(year = as.numeric(substring(year, 11, ifelse(nchar(year) == 12, 11, 12))) + 1953)
    #   
    # } else if(river_data$Broodline[1] == "Odd"){
    #   
    #   
    #   posterior_a_t_alpha_j <- posterior_a_t %>% 
    #   select(starts_with('alpha_j')) %>%
    #   select(ends_with(paste0("[",river_w_broodline,"]")))
    #   
    #   posterior_a_t_alpha_t <- posterior_a_t %>%
    #   select(starts_with('alpha_t[2,'))
    #   
    #   posterior_a_t_alpha_t_j_full <- matrix(posterior_a_t_alpha_j[,1], ncol = length(posterior_a_t_alpha_t), nrow = length(posterior_a_t_alpha_j[,1])) + posterior_a_t_alpha_t
    #   
    #   posterior_a_t_alpha_t_j <- posterior_a_t_alpha_t_j_full %>%
    #     pivot_longer(cols = everything(), names_to = "year", values_to = "alpha_t_odd") %>%
    #     mutate(year = as.numeric(substring(year, 11, ifelse(nchar(year) == 12, 11, 12))) + 1953)
    #   
    #   
    #   
    #   
    #   
    #   
    # }
    
    
    
    
    #bh
    
    posterior_bh_rv_b_for <- posterior_bh %>% 
      select(starts_with('b_for_rv')) %>%
      select(ends_with(paste0("[",river_wo_broodline,"]")))
    
    posterior_bh_rv_alpha_j <- posterior_bh %>%
      select(starts_with('alpha_j')) %>%
      select(ends_with(paste0("[",river_w_broodline,"]")))
    
    posterior_bh_rv_Rk <- posterior_bh %>%
      select(starts_with('Rk')) %>%
      select(ends_with(paste0("[",river_w_broodline,"]")))
    
    
    
  }
 
    
    spawners_predicted <- seq(0, max(river_data$Spawners), length.out = 100)
    
    # calculate recruit prediction
    
    low_cpd <- min(river_data$sqrt.CPD.std)
    high_cpd <- max(river_data$sqrt.CPD.std)
    # avg_cpd <- mean(river_data$sqrt.CPD.std)
    mid_cpd <- min(river_data$sqrt.CPD.std) + (max(river_data$sqrt.CPD.std) - min(river_data$sqrt.CPD.std))/2
    
    mid_cpd_real <- min(river_data$disturbedarea_prct_cs) + (max(river_data$disturbedarea_prct_cs) - min(river_data$disturbedarea_prct_cs))/2
    
    recruits_predicted <- exp(apply((matrix(posterior_rv_alpha_j[,1], ncol = length(spawners_predicted), nrow = length(posterior_rv_alpha_j[,1])) - 
                                       as.matrix(1/posterior_rv_S_max)%*%spawners_predicted  + matrix(posterior_rv_b_for[,1]*mid_cpd, ncol = length(spawners_predicted), nrow = length(posterior_rv_alpha_j[,1]))), 2, median))*spawners_predicted
    
    recruits_predicted_lower <- exp(apply((matrix(posterior_rv_alpha_j[,1], ncol = length(spawners_predicted), nrow = length(posterior_rv_alpha_j[,1])) - as.matrix(1/posterior_rv_S_max)%*%spawners_predicted), 2, quantile, c(0.025)))*spawners_predicted
    
    recruits_predicted_upper <- exp(apply((matrix(posterior_rv_alpha_j[,1], ncol = length(spawners_predicted), nrow = length(posterior_rv_alpha_j[,1])) - as.matrix(1/posterior_rv_S_max)%*%spawners_predicted), 2, quantile, c(0.975)))*spawners_predicted
                          
    
    
    # if(low_cpd == high_cpd){
    #   scale_color <- scale_color_manual(name = 'CPD in River (%)', values = c("black"))
    #   
    # } else{
    #    scale_color <- scale_color_gradient2(name = 'CPD in River (%)',
    #                                     low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = 50)
    # }
    
    
    recruits_predicted_low_cpd <- exp(apply((matrix(posterior_rv_alpha_j[,1], ncol = length(spawners_predicted), nrow = length(posterior_rv_alpha_j[,1])) - as.matrix(1/posterior_rv_S_max)%*%spawners_predicted  + matrix(posterior_rv_b_for[,1]*low_cpd, ncol = length(spawners_predicted), nrow = length(posterior_rv_alpha_j[,1]))), 2, median))*spawners_predicted
    
    recruits_predicted_high_cpd <- exp(apply((matrix(posterior_rv_alpha_j[,1], ncol = length(spawners_predicted), nrow = length(posterior_rv_alpha_j[,1])) - as.matrix(1/posterior_rv_S_max)%*%spawners_predicted  + matrix(posterior_rv_b_for[,1]*high_cpd, ncol = length(spawners_predicted), nrow = length(posterior_rv_alpha_j[,1]))), 2, median))*spawners_predicted
    
    #make dataframe
    
    prediction_df <- data.frame(spawners = spawners_predicted,
                                recruits = recruits_predicted,
                                recruits_lower = recruits_predicted_lower,
                                recruits_upper = recruits_predicted_upper,
                                recruits_low_cpd = recruits_predicted_low_cpd,
                                recruits_high_cpd = recruits_predicted_high_cpd,
                                log_RS = log(recruits_predicted/spawners_predicted))
    
    
    
    
    # recruits_bh_predicted <- exp(apply((matrix(posterior_bh_rv_alpha_j[,1], ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1])) - log(1+as.matrix(exp(posterior_bh_rv_alpha_j[,1])/posterior_bh_rv_Rk)%*%spawners_predicted) + matrix(posterior_bh_rv_b_for[,1]*mid_cpd, ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1]))), 2, median))*spawners_predicted
    
    recruits_bh_predicted <- exp(apply((matrix(posterior_bh_rv_alpha_j[,1], ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1])) - log(1+as.matrix(exp(posterior_bh_rv_alpha_j[,1] + matrix(posterior_bh_rv_b_for[,1]*mid_cpd, ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1])))/posterior_bh_rv_Rk)%*%spawners_predicted) + matrix(posterior_bh_rv_b_for[,1]*mid_cpd, ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1]))), 2, median))*spawners_predicted
      
    recruits_bh_predicted_lower <- exp(apply((matrix(posterior_bh_rv_alpha_j[,1], ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1])) - log(1+as.matrix(exp(posterior_bh_rv_alpha_j[,1] + matrix(posterior_bh_rv_b_for[,1]*mid_cpd, ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1])))/posterior_bh_rv_Rk)%*%spawners_predicted) + matrix(posterior_bh_rv_b_for[,1]*mid_cpd, ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1]))), 2, quantile, c(0.025)))*spawners_predicted
                                       
                                    
    recruits_bh_predicted_upper <- exp(apply((matrix(posterior_bh_rv_alpha_j[,1], ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1])) - log(1+as.matrix(exp(posterior_bh_rv_alpha_j[,1]+matrix(posterior_bh_rv_b_for[,1]*mid_cpd, ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1])))/posterior_bh_rv_Rk)%*%spawners_predicted) + matrix(posterior_bh_rv_b_for[,1]*mid_cpd, ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1]))), 2, quantile, c(0.975)))*spawners_predicted
    
    
    recruits_bh_predicted_low_cpd <- exp(apply((matrix(posterior_bh_rv_alpha_j[,1], ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1])) - log(1+as.matrix(exp(posterior_bh_rv_alpha_j[,1]+matrix(posterior_bh_rv_b_for[,1]*low_cpd, ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1])))/posterior_bh_rv_Rk)%*%spawners_predicted) + matrix(posterior_bh_rv_b_for[,1]*low_cpd, ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1]))), 2, median))*spawners_predicted
    
    recruits_bh_predicted_high_cpd <- exp(apply((matrix(posterior_bh_rv_alpha_j[,1], ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1])) - log(1+as.matrix(exp(posterior_bh_rv_alpha_j[,1]+matrix(posterior_bh_rv_b_for[,1]*high_cpd, ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1])))/posterior_bh_rv_Rk)%*%spawners_predicted) + matrix(posterior_bh_rv_b_for[,1]*high_cpd, ncol = length(spawners_predicted), nrow = length(posterior_bh_rv_alpha_j[,1]))), 2, median))*spawners_predicted
                                         
          
    
    
      
    prediction_bh_df <- data.frame(spawners = spawners_predicted,
                                recruits = recruits_bh_predicted,
                                recruits_lower = recruits_bh_predicted_lower,
                                recruits_upper = recruits_bh_predicted_upper,
                                recruits_low_cpd = recruits_bh_predicted_low_cpd,
                                recruits_high_cpd = recruits_bh_predicted_high_cpd,
                                log_RS = log(recruits_bh_predicted/spawners_predicted))
      
  
  
    #plot the time varying productivity vs year, with log(R/S) data
    
    
    
    
    
    #plot recruit vs spawner as points
    
    p1 <- ggplot() +
      geom_point(data = river_data,aes(x = Spawners, y = Recruits, color = disturbedarea_prct_cs), alpha = 0.5, size = 2) +
      geom_line(data = prediction_df, aes(x = spawners, y = recruits_low_cpd), color = '#35978f', size = 1, alpha = 0.5) +
      geom_line(data = prediction_df, aes(x = spawners, y = recruits_high_cpd), color = '#bf812d', size = 1, alpha = 0.5) +
      geom_line(data = prediction_df, aes(x = spawners, y = recruits), color = "black", size = 1, alpha = 0.5) +
      geom_ribbon(data = prediction_df, aes(x = spawners, ymin = recruits_lower, ymax = recruits_upper), fill = "gray", alpha = 0.5) +
      #make y log scale
      # scale_y_log10() +
      labs(title = "Ricker model with CPD, NPGO, ERSST", x = "Spawners", y = "Recruits") +
      # scale_color_manual(name = "CPD", values = c("Low" = '#35978f', "High" = '#bf812d')) +
      scale_color_gradient2(name = 'CPD in River (%)',
                                        low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = mid_cpd_real)+
      theme_classic() +
      theme(legend.position = "right",
            legend.key.width = unit(0.5, "cm"),
            legend.key.height = unit(1, "lines"),
            legend.text = element_text(size = 7),
            legend.spacing.y = unit(0.001, "cm"),
            axis.title.x = element_text(size = 12),
            axis.title.y = element_text(size = 12),
            axis.text.x = element_text(size = 12),
            axis.text.y = element_text(size = 12),
            plot.title = element_text(size = 16, hjust = 0.5)
            )
    
    p2 <- ggplot(river_data) +
      geom_point(aes(x = Spawners, y = Recruits, color = disturbedarea_prct_cs), alpha = 0.5, size = 2) +
      #make y log scale
      # scale_y_log10() +
      
      geom_line(data = prediction_bh_df, aes(x = spawners, y = recruits_low_cpd), color = '#35978f', size = 1, alpha = 0.5) +
      geom_line(data = prediction_bh_df, aes(x = spawners, y = recruits_high_cpd), color = '#bf812d', size = 1, alpha = 0.5) +
      geom_line(data = prediction_bh_df, aes(x = spawners, y = recruits), color = "black", size = 1, alpha = 0.5) +
      geom_ribbon(data = prediction_bh_df, aes(x = spawners, ymin = recruits_lower, ymax = recruits_upper), fill = "gray", alpha = 0.5) +
      
      scale_color_gradient2(name = 'CPD in River (%)',
                                        low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = mid_cpd_real)+
      labs(title = "BH model with CPD, NPGO, ERSST", x = "Spawners", y = "Recruits") +
      theme_classic() +
      theme(legend.position = "right",
            legend.key.width = unit(0.5, "cm"),
            legend.key.height = unit(1, "lines"),
            legend.text = element_text(size = 7),
            legend.spacing.y = unit(0.001, "cm"),
            axis.title.x = element_text(size = 12),
            axis.title.y = element_text(size = 12),
            axis.text.x = element_text(size = 12),
            axis.text.y = element_text(size = 12),
            plot.title = element_text(size = 16, hjust = 0.5)
            )
    
    # p3 log R/s vs spawners
    
    p3 <- ggplot(river_data) + 
      geom_point(aes(x = Spawners, y = log(Recruits/Spawners), color = disturbedarea_prct_cs), alpha = 0.5, size = 2) +
      geom_line(data = prediction_df, aes(x = spawners, y = log(recruits_predicted_low_cpd/spawners_predicted)), color = '#35978f', size = 1, alpha = 0.5) +
      geom_line(data = prediction_df, aes(x = spawners, y = log(recruits_predicted_high_cpd/spawners_predicted)), color = '#bf812d', size = 1, alpha = 0.5) +
      geom_line(data = prediction_df, aes(x = spawners, y = log_RS), color = "black", size = 1, alpha = 0.5) +
      geom_ribbon(data = prediction_df, aes(x = spawners, ymin = log(recruits_predicted_lower/spawners_predicted), ymax = log(recruits_predicted_upper/spawners_predicted)), fill = "gray", alpha = 0.5) +
      labs(#title = "Ricker model with CPD, NPGO, ERSST", 
           x = "Spawners", y = TeX(r"($\log \left(\frac{Recruits}{Spawners}\right)$)")) +
      scale_color_gradient2(name = 'CPD in River (%)',
                                        low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = mid_cpd_real)+
      theme_classic() +
      theme(legend.position = "right",
            legend.key.width = unit(0.5, "cm"),
            legend.key.height = unit(1, "lines"),
            legend.text = element_text(size = 7),
            legend.spacing.y = unit(0.001, "cm"),
            axis.title.x = element_text(size = 12),
            axis.title.y = element_text(size = 12),
            axis.text.x = element_text(size = 12),
            axis.text.y = element_text(size = 12),
            plot.title = element_text(size = 16, hjust = 0.5)
            )
    
    p4 <- ggplot(river_data) + 
      geom_point(aes(x = Spawners, y = log(Recruits/Spawners), color = disturbedarea_prct_cs), alpha = 0.5, size = 2) +
      geom_line(data = prediction_bh_df, aes(x = spawners, y = log(recruits_bh_predicted_low_cpd/spawners_predicted)), color = '#35978f', size = 1, alpha = 0.5) +
      geom_line(data = prediction_bh_df, aes(x = spawners, y = log(recruits_bh_predicted_high_cpd/spawners_predicted)), color = '#bf812d', size = 1, alpha = 0.5) +
      geom_line(data = prediction_bh_df, aes(x = spawners, y = log_RS), color = "black", size = 1, alpha = 0.5) +
      geom_ribbon(data = prediction_bh_df, aes(x = spawners, ymin = log(recruits_bh_predicted_lower/spawners_predicted), ymax = log(recruits_bh_predicted_upper/spawners_predicted)), fill = "gray", alpha = 0.5) +
      labs(#title = "BH model with CPD, NPGO, ERSST", 
           x = "Spawners", y = TeX(r"($\log \left(\frac{Recruits}{Spawners}\right)$)")) +
             # "log(Recruits/Spawners)") +
      scale_color_gradient2(name = 'CPD in River (%)',
                                        low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = mid_cpd_real)+
      theme_classic() +
      theme(legend.position = "right",
            legend.key.width = unit(0.5, "cm"),
            legend.key.height = unit(1, "lines"),
            legend.text = element_text(size = 7),
            legend.spacing.y = unit(0.001, "cm"),
            axis.title.x = element_text(size = 12),
            axis.title.y = element_text(size = 12),
            axis.text.x = element_text(size = 12),
            axis.text.y = element_text(size = 12),
            plot.title = element_text(size = 16, hjust = 0.5)
            )
    
    
    # p5 residuals of ricker model vs predicted values of ricker model
    
    residual_df <- data.frame(spawners = river_data$Spawners,
                              recruits = river_data$Recruits,
                              observed_log_RS = river_data$ln_RS,
                              predicted_log_RS = apply((matrix(posterior_rv_alpha_j[,1], ncol = length(river_data$Spawners), nrow = length(posterior_rv_alpha_j[,1])) - as.matrix(1/posterior_rv_S_max)%*%river_data$Spawners), 2, median),
                              cpd = river_data$disturbedarea_prct_cs
    )
    
    residual_df$residuals <- residual_df$observed_log_RS - residual_df$predicted_log_RS
    
    p5 <- ggplot(residual_df)+
      geom_point(aes(x = predicted_log_RS, y = residuals, color = cpd), alpha = 0.5, size = 2) +
      geom_hline(yintercept = 0, color = 'black', linetype = 'dashed') +
      labs(#title = "Ricker model with CPD, NPGO, ERSST", 
        x = TeX(r"(Predicted $\log \left(\frac{Recruits}{Spawners}\right)$)"), 
        y = "Residuals") +
      scale_color_gradient2(name = 'CPD in River (%)',
                                        low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = mid_cpd_real)+
      theme_classic() +
      theme(legend.position = "right",
            legend.key.width = unit(0.5, "cm"),
            legend.key.height = unit(1, "lines"),
            legend.text = element_text(size = 7),
            legend.spacing.y = unit(0.001, "cm"),
            axis.title.x = element_text(size = 12),
            axis.title.y = element_text(size = 12),
            axis.text.x = element_text(size = 12),
            axis.text.y = element_text(size = 12),
            plot.title = element_text(size = 16, hjust = 0.5)
            )
    
    residual_bh_df <- data.frame(spawners = river_data$Spawners,
                              recruits = river_data$Recruits,
                              observed_log_RS = river_data$ln_RS,
                              predicted_log_RS = apply((matrix(posterior_bh_rv_alpha_j[,1], ncol = length(river_data$Spawners), nrow = length(posterior_bh_rv_alpha_j[,1])) - log(1+as.matrix(exp(posterior_bh_rv_alpha_j[,1])/posterior_bh_rv_Rk)%*%river_data$Spawners)), 2, median),
                              cpd = river_data$disturbedarea_prct_cs
    )
    
    residual_bh_df$residuals <- residual_bh_df$observed_log_RS - residual_bh_df$predicted_log_RS
    
    p6 <- ggplot(residual_bh_df)+
      geom_point(aes(x = predicted_log_RS, y = residuals, color = cpd), alpha = 0.5, size = 2) +
      geom_hline(yintercept = 0, color = 'black', linetype = 'dashed') +
      labs(#title = "BH model with CPD, NPGO, ERSST", 
           x = TeX(r"(Predicted $\log \left(\frac{Recruits}{Spawners}\right)$)"), y = "Residuals") +
      scale_color_gradient2(name = 'CPD in River (%)',
                                        low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = mid_cpd_real)+
      theme_classic() +
      theme(legend.position = "right",
            legend.key.width = unit(0.5, "cm"),
            legend.key.height = unit(1, "lines"),
            legend.text = element_text(size = 7),
            legend.spacing.y = unit(0.001, "cm"),
            axis.title.x = element_text(size = 12),
            axis.title.y = element_text(size = 12),
            axis.text.x = element_text(size = 12),
            axis.text.y = element_text(size = 12),
            plot.title = element_text(size = 16, hjust = 0.5)
            )
    
    
    
    
    
    print((p1+p2)/(p3+p4)/(p5+p6) + plot_layout(guides = "collect", heights = c(3,2,1)))
    cat('\n')
  
    
    
  return()
}
  
species = "chum"
if(species == "chum"){
    df <- ch20rsc
    posterior <- ric_chm_cpd_ersst
  
    posterior_bh <- bh_chm_cpd_ersst_correct
    
    posterior_a_t <- ric_chm_cpd
    
    posterior_a_t_bh <- bh_chm_cpd
    
    
    rivers <- unique(df$River_n)
    
  } else if(species == "pink"){
    df <- pk10r
    
    posterior <- ric_pk_cpd_ersst
    
    posterior_bh <- bh_pk_cpd_ersst
    
    posterior_a_t <- ric_pk_cpd
    
    posterior_a_t_bh <- bh_pk_cpd
    
    rivers <- unique(df$River_n2)
  }
  
for(river in rivers){

  if(species == "chum"){
    river_data <- df %>% filter(River_n == river)
    cat('\n')
    cat("### ", river_data$River[1], "\n")
  } else if(species == "pink"){
    river_data <- df %>% filter(River_n2 == river)
    cat('\n')
    cat("### ", river_data$River2[1], "\n")
  }
  # river_data_even <- river_data %>% filter(Broodline=='Even')
  # river_data_odd <- river_data %>% filter(Broodline=='Odd')


  plot_recruit_spawner(data = df, species = species, river = river, river_data, posterior = posterior, posterior_bh = posterior_bh, 
                       posterior_a_t = posterior_a_t, posterior_a_t_bh = posterior_a_t_bh)
}

# posterior <- ric_chm_cpd_ersst
# posterior_bh <- bh_chm_cpd_st_correct
# 
# plot_recruit_spawner(river = 7, posterior = ric_chm_cpd_ersst_cc2, posterior_bh = bh_chm_cpd_st_cc)
  
```





# Pink Salmon

```{r}

pk10r_e <- read.csv(here("origional-ecofish-data-models","Data","Processed","pke_SR_10_hat_yr_w_ersst.csv"))

#odd year pinks
pk10r_o <- read.csv(here("origional-ecofish-data-models","Data","Processed","pko_SR_10_hat_yr_w_ersst.csv"))

options(mc.cores=8)

# Pink salmon - even/odd broodlines #####
pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=='950-169400-00000-00000-0000-0000-000-000-000-000-000-000','SALMON RIVER 2',pk10r_o$River)
pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=='915-765500-18600-00000-0000-0000-000-000-000-000-000-000','HEAD CREEK 2',pk10r_o$River)
pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=='915-488000-41400-00000-0000-0000-000-000-000-000-000-000','WINDY BAY CREEK 2',pk10r_o$River)
pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=="915-486500-05300-00000-0000-0000-000-000-000-000-000-000",'LAGOON CREEK 2',pk10r_o$River)
pk10r_o=pk10r_o[order(factor(pk10r_o$River),pk10r_o$BroodYear),]
rownames(pk10r_o)=seq(1:nrow(pk10r_o))

pk10r_e$River=ifelse(pk10r_e$WATERSHED_CDE=='950-169400-00000-00000-0000-0000-000-000-000-000-000-000','SALMON RIVER 2',pk10r_e$River)
pk10r_e$River=ifelse(pk10r_e$WATERSHED_CDE=='915-765500-18600-00000-0000-0000-000-000-000-000-000-000','HEAD CREEK 2',pk10r_e$River)
pk10r_e$River=ifelse(pk10r_e$WATERSHED_CDE=='915-488000-41400-00000-0000-0000-000-000-000-000-000-000','WINDY BAY CREEK 2',pk10r_e$River)
pk10r_e$River=ifelse(pk10r_e$WATERSHED_CDE=="915-486500-05300-00000-0000-0000-000-000-000-000-000-000",'LAGOON CREEK 2',pk10r_e$River)
pk10r_e=pk10r_e[order(factor(pk10r_e$River),pk10r_e$BroodYear),]
rownames(pk10r_e)=seq(1:nrow(pk10r_e))


#normalize ECA 2 - square root transformation (ie. sqrt(x))
pk10r_o$sqrt.ECA=sqrt(pk10r_o$ECA_age_proxy_forested_only)
pk10r_o$sqrt.ECA.std=(pk10r_o$sqrt.ECA-mean(pk10r_o$sqrt.ECA))/sd(pk10r_o$sqrt.ECA)

#normalize CPD 2 - square root transformation (ie. sqrt(x))
pk10r_o$sqrt.CPD=sqrt(pk10r_o$disturbedarea_prct_cs)
pk10r_o$sqrt.CPD.std=(pk10r_o$sqrt.CPD-mean(pk10r_o$sqrt.CPD))/sd(pk10r_o$sqrt.CPD)

#normalize ECA 2 - square root transformation (ie. sqrt(x))
pk10r_e$sqrt.ECA=sqrt(pk10r_e$ECA_age_proxy_forested_only)
pk10r_e$sqrt.ECA.std=(pk10r_e$sqrt.ECA-mean(pk10r_e$sqrt.ECA))/sd(pk10r_e$sqrt.ECA)

#normalize CPD 2 - square root transformation (ie. sqrt(x))
pk10r_e$sqrt.CPD=sqrt(pk10r_e$disturbedarea_prct_cs)
pk10r_e$sqrt.CPD.std=(pk10r_e$sqrt.CPD-mean(pk10r_e$sqrt.CPD))/sd(pk10r_e$sqrt.CPD)


#standardize npgo
pk10r_o$npgo.std=(pk10r_o$npgo-mean(pk10r_o$npgo))/sd(pk10r_o$npgo)
pk10r_e$npgo.std=(pk10r_e$npgo-mean(pk10r_e$npgo))/sd(pk10r_e$npgo)

# pk10r_o$sst.std = (pk10r_o$spring_lighthouse_temperature-mean(pk10r_o$spring_lighthouse_temperature))/sd(pk10r_o$spring_lighthouse_temperature)
# pk10r_e$sst.std = (pk10r_e$spring_lighthouse_temperature-mean(pk10r_e$spring_lighthouse_temperature))/sd(pk10r_e$spring_lighthouse_temperature)

pk10r_o$sst.std = (pk10r_o$spring_ersst-mean(pk10r_o$spring_ersst))/sd(pk10r_o$spring_ersst)
pk10r_e$sst.std = (pk10r_e$spring_ersst-mean(pk10r_e$spring_ersst))/sd(pk10r_e$spring_ersst)


pk10r_o$escapement.t_1=pk10r_e$Spawners[match(paste(pk10r_o$WATERSHED_CDE,pk10r_o$BroodYear-1),paste(pk10r_e$WATERSHED_CDE,pk10r_e$BroodYear))]
pk10r_e$escapement.t_1=pk10r_o$Spawners[match(paste(pk10r_e$WATERSHED_CDE,pk10r_e$BroodYear-1),paste(pk10r_o$WATERSHED_CDE,pk10r_o$BroodYear))]

pk10r_o$Broodline='Odd'
pk10r_e$Broodline='Even'

L_o=pk10r_o%>%group_by(River)%>%summarize(l=n(),by=min(BroodYear),tmin=(min(BroodYear)-min(pk10r_o$BroodYear))/2+1,tmax=(max(BroodYear)-min(pk10r_o$BroodYear))/2)
L_e=pk10r_e%>%group_by(River)%>%summarize(l=n(),by=min(BroodYear),tmin=(min(BroodYear)-min(pk10r_e$BroodYear))/2+1,tmax=(max(BroodYear)-min(pk10r_e$BroodYear))/2)
L_o$River2=paste(L_o$River,'Odd',sep='_')
L_e$River2=paste(L_e$River,'Even',sep='_')
L_all=rbind(L_e,L_o)
L_all=L_all[order(factor(L_all$River2)),]

pk10r_o$ii=as.numeric(factor(pk10r_o$BroodYear))
pk10r_e$ii=as.numeric(factor(pk10r_e$BroodYear))

pk10r=rbind(pk10r_e,pk10r_o)
pk10r$River2=paste(pk10r$River,pk10r$Broodline,sep='_')
pk10r=pk10r[order(factor(pk10r$River2),pk10r$BroodYear),]

#extract max S for priors on capacity & eq. recruitment
smax_prior=pk10r%>%group_by(River2) %>%summarize(m.s=max(Spawners),m.r=max(Recruits))

#ragged start and end points for each SR series
# N_s=rag_n(pk10r$River2)

#cus by stock
cu1=distinct(pk10r,CU,.keep_all = T)
cu2=distinct(pk10r,River,.keep_all = T)
cu3=distinct(pk10r,River2,.keep_all = T)

pk10r$River_n <- as.numeric(factor(pk10r$River))
pk10r$River_n2 <- as.numeric(factor(pk10r$River2))
pk10r$CU_name <- pk10r$CU_NAME

max_eca_pink_df <- pk10r %>% 
  select(River2, River, River_n, CU, ECA_age_proxy_forested_only) %>%
  group_by(River) %>%
  summarize(River = first(River),
            River_n = first(River_n),
            CU = first(CU),
            eca_max = 100*max(ECA_age_proxy_forested_only, na.rm =TRUE)) %>% 
  mutate(eca_level = case_when(eca_max < 12 ~ 'low',
                               eca_max >= 12 & eca_max < 24 ~ 'medium',
                               eca_max >= 24 ~ 'high'))

max_cpd_pink_df <- pk10r %>%
  select(River2, River, River_n,  CU, disturbedarea_prct_cs) %>%
  group_by(River) %>% 
  summarize(River = first(River),
            River_n = first(River_n),
            CU = first(CU),
            cpd_max = max(disturbedarea_prct_cs, na.rm = TRUE))


```

## Beverton Holt Models

```{r fig.width=10, fig.height=12}

#models with coastwide productivity

bh_pk_eca=read.csv(here('stan models',
                        'outs',
                        'posterior',
                        'bh_pk_eca_noac.csv'),check.names=F)


bh_pk_cpd=read.csv(here('stan models',
                        'outs',
                        'posterior',
                        'bh_pk_cpd_noac.csv'),check.names=F)

#models static - no covariates

bh_pk_eca_st=read.csv(here('stan models',
                        'outs',
                        'posterior',
                        'bh_pk_eca_st_noac.csv'),check.names=F)


bh_pk_cpd_st=read.csv(here('stan models',
                        'outs',
                        'posterior',
                        'bh_pk_cpd_st_noac.csv'),check.names=F)

#models with npgo
# 
# bh_pk_eca_npgo=read.csv(here('stan models',
#                         'outs',
#                         'posterior',
#                         'bh_pk_eca_noac_w_npgo.csv'),check.names=F)
# 
# 
# bh_pk_cpd_npgo=read.csv(here('stan models',
#                         'outs',
#                         'posterior',
#                         'bh_pk_cpd_noac_w_npgo.csv'),check.names=F)
# 
# #models with npgo, sst
# 
# bh_pk_eca_sst=read.csv(here('stan models',
#                             'outs',
#                             'posterior',
#                             'bh_pk_eca_noac_w_npgo_lh_sst.csv'),check.names=F)
# 
# 
# 
# bh_pk_cpd_sst=read.csv(here('stan models',
#                             'outs',
#                             'posterior',
#                             'bh_pk_cpd_noac_w_npgo_lh_sst.csv'),check.names=F)
# 
# bh_pk_eca_cobe_sst=read.csv(here('stan models',
#                             'outs',
#                             'posterior',
#                             'bh_pk_eca_noac_w_npgo_cobe_sst.csv'),check.names=F)
# 
# 
# 
# bh_pk_cpd_cobe_sst=read.csv(here('stan models',
#                             'outs',
#                             'posterior',
#                             'bh_pk_cpd_noac_w_npgo_cobe_sst.csv'),check.names=F)
# 
# 

bh_pk_eca_ersst <- read.csv(here('stan models', 'outs', 'posterior',
                                 'bh_pk_eca_noac_w_npgo_ersst.csv'),check.names=F)

bh_pk_cpd_ersst <- read.csv(here('stan models', 'outs', 'posterior',
                                 'bh_pk_cpd_noac_w_npgo_ersst.csv'),check.names=F)



((plot_forestry_effect(posterior = bh_pk_eca_ersst, effect = "eca", species = "pink", model = "BH model with NPGO, ERSST", xlim = c(-0.5,0.5)) +
    plot_forestry_effect(posterior = bh_pk_cpd_ersst, effect = "cpd", species = "pink", model = "BH model with NPGO, ERSST", xlim = c(-0.5,0.5)))/(plot_forestry_effect(posterior = bh_pk_eca_st, effect = "eca", species = "pink", model = "BH model without coastwide productivity", xlim = c(-0.5,0.5)) +
    plot_forestry_effect(posterior = bh_pk_cpd_st, effect = "cpd", species = "pink", model = "BH model without coastwide productivity", xlim = c(-0.5,0.5)))/(plot_forestry_effect(posterior = bh_pk_eca, effect = "eca", species = "pink", model = "BH model with coastwide productivity", xlim = c(-0.5,0.5)) +
    plot_forestry_effect(posterior = bh_pk_cpd, effect = "cpd", species = "pink", model = "BH model with coastwide productivity", xlim = c(-0.5,0.5))))  + plot_layout(guides = "collect")


```


## Corrected Beverton-Holt Models

```{r fig.width=10, fig.height=12}

bh_pk_eca_correct=read.csv(here('stan models',
                        'outs',
                        'posterior',
                        'bh_pk_eca_noac_corrected.csv'),check.names=F)

bh_pk_cpd_correct=read.csv(here('stan models',
                        'outs',
                        'posterior',
                        'bh_pk_cpd_noac_corrected.csv'),check.names=F)

bh_pk_eca_st_correct=read.csv(here('stan models',
                        'outs',
                        'posterior',
                        'bh_pk_eca_st_noac_corrected.csv'),check.names=F)

bh_pk_cpd_st_correct=read.csv(here('stan models',
                        'outs',
                        'posterior',
                        'bh_pk_cpd_st_noac_corrected.csv'),check.names=F)


bh_pk_cpd_ersst_correct = read.csv(here('stan models',
                        'outs',
                        'posterior',
                        'bh_pk_cpd_noac_w_npgo_ersst_corrected.csv'),check.names=F)


bh_pk_eca_ersst_correct = read.csv(here('stan models',
                        'outs',
                        'posterior',
                        'bh_pk_eca_noac_w_npgo_ersst_corrected.csv'),check.names=F)


(plot_forestry_effect(posterior = bh_pk_eca_st_correct, effect = "eca", species = "pink", model = "BH model with ECA", xlim = c(-0.5,0.5)) + plot_forestry_effect(posterior = bh_pk_cpd_st_correct, effect = "cpd", species = "pink", model = "BH model with CPD", xlim = c(-0.5,0.5)))/(plot_forestry_effect(posterior = bh_pk_eca_correct, effect = "eca", species = "pink", model = "BH model with ECA,\ncoastwide productivity", xlim = c(-0.5,0.5)) + plot_forestry_effect(posterior = bh_pk_cpd_correct, effect = "cpd", species = "pink", model = "BH model with CPD,\ncoastwide productivity", xlim = c(-0.5,0.5)))/(plot_forestry_effect(posterior = bh_pk_eca_ersst_correct, effect = "eca", species = "pink", model = "BH model with NPGO, ERSST", xlim = c(-0.5,0.5)) + plot_forestry_effect(posterior = bh_pk_cpd_ersst_correct, effect = "cpd", species = "pink", model = "BH model with NPGO, ERSST", xlim = c(-0.5,0.5))) + plot_layout(guides = "collect")



```




## Ricker models

```{r fig.width=10, fig.height=6}

ric_pk_eca = read.csv(here('stan models',
                        'outs',
                        'posterior',
                        'ric_pk_eca_noac.csv'),check.names=F)


ric_pk_cpd = read.csv(here('stan models',
                        'outs',
                        'posterior',
                        'ric_pk_cpd_noac.csv'),check.names=F)


ric_pk_eca_st = read.csv(here('stan models',
                        'outs',
                        'posterior',
                        'ric_pk_eca_st_noac.csv'),check.names=F)


ric_pk_cpd_st = read.csv(here('stan models',
                        'outs',
                        'posterior',
                        'ric_pk_cpd_st_noac.csv'),check.names=F)

# ric_pk_eca_npgo = read.csv(here('stan models',
#                         'outs',
#                         'posterior',
#                         'ric_pk_eca_st_noac_npgo.csv'),check.names=F)
# 
# 
# ric_pk_cpd_npgo = read.csv(here('stan models',
#                         'outs',
#                         'posterior',
#                         'ric_pk_cpd_st_noac_npgo.csv'),check.names=F)
# 
# 


ric_pk_eca_ersst = read.csv(here('stan models',
                        'outs',
                        'posterior',
                        'ric_pk_eca_st_noac_npgo_ersst.csv'),check.names=F)




ric_pk_cpd_ersst = read.csv(here('stan models',
                        'outs',
                        'posterior',
                        'ric_pk_cpd_st_noac_npgo_ersst.csv'),check.names=F)


(plot_forestry_effect(posterior = ric_pk_eca_ersst, effect = "eca", species = "pink", model = "Ricker model with NPGO, ERSST", xlim = c(-0.5,0.5)) +
    plot_forestry_effect(posterior = ric_pk_cpd_ersst, effect = "cpd", species = "pink", model = "Ricker model with NPGO, ERSST", xlim = c(-0.5,0.5)))/(plot_forestry_effect(posterior = ric_pk_eca, effect = "eca", species = "pink", model = "Ricker model with coastwide productivity", xlim = c(-0.5,0.5)) +
    plot_forestry_effect(posterior = ric_pk_cpd, effect = "cpd", species = "pink", model = "Ricker model with coastwide productivity", xlim = c(-0.5,0.5)))  + plot_layout(guides = "collect")


```

## Productivity Decline

```{r fig.width=10, fig.height=6}

((plot_productivity_decline(posterior = bh_pk_eca_ersst, effect = "eca", species = "pink", model = "BH model with NPGO, ERSST", by_river = FALSE) +
    plot_productivity_decline(posterior = bh_pk_cpd_ersst, effect = "cpd", species = "pink", model = "BH model with NPGO, ERSST", by_river = FALSE) )/(plot_productivity_decline(posterior = ric_pk_eca_ersst, effect = "eca", species = "pink", model = "Ricker model with NPGO, ERSST", by_river = FALSE) +
    plot_productivity_decline(posterior = ric_pk_cpd_ersst, effect = "cpd", species = "pink", model = "Ricker model with NPGO, ERSST", by_river = FALSE))) + plot_layout(guides = "collect")

```

```{r fig.width = 10, fig.height = 3}
(plot_productivity_decline(posterior = bh_pk_eca_ersst, effect = "sst", species = "pink", model = "BH model with NPGO, ERSST", by_river = FALSE) +
    plot_productivity_decline(posterior = ric_pk_cpd_ersst, effect = "sst", species = "pink", model = "Ricker model with NPGO, ERSST", by_river = FALSE)) + plot_layout(guides = "collect")


```

## Effect of SST

```{r fig.width = 12, fig.height = 3}


(plot_sst_effect(posterior = bh_pk_cpd_ersst_correct, effect = "sst", species = "pink", model = "BH model with CPD, NPGO, ERSST") +
  plot_sst_effect(posterior = ric_pk_cpd_ersst, effect = "sst", species = "pink", model = "Ric model with CPD, NPGO, LH SST", color_by = "CU"))


```

## Effect of NPGO

```{r fig.width = 12, fig.height = 3}



plot_npgo_effect(posterior = bh_pk_cpd_ersst_correct, effect = "npgo", species = "pink", model = "BH model with CPD, NPGO, ERSST") +
  plot_npgo_effect(posterior = ric_pk_cpd_ersst, effect = "npgo", species = "pink", model = "Ric model with CPD, NPGO, ERSST")

```


## Residual plots

```{r, residual-plots-pinks, fig.width = 12, fig.height = 8, results="asis"}

# plotting residuals of ricker model vs predicted values of ricker model for all rivers combined

species = "pink"

df <- pk10r
    
posterior <- ric_pk_cpd_ersst
    
posterior_bh <- bh_pk_cpd_ersst

posterior_a_t <- ric_pk_cpd

posterior_a_t_bh <- bh_pk_cpd

rivers <- unique(df$River_n2)

residual_df_full <- data.frame()

residual_bh_df_full <- data.frame()

for(river in rivers){
  
  river_data <- df %>% filter(River_n2 == river)
  
  river_wo_broodline <- river_data$River_n
    river_w_broodline <- river_data$River_n2
    
    posterior_rv_b_for <- posterior %>% 
      select(starts_with('b_for_rv')) %>%
      select(ends_with(paste0("[",river_wo_broodline,"]")))
    
    posterior_rv_b_npgo <- posterior %>% 
      select(starts_with('b_npgo_rv')) %>%
      select(ends_with(paste0("[",river_wo_broodline,"]")))
    
    posterior_rv_b_sst <- posterior %>% 
      select(starts_with('b_sst_rv')) %>%
      select(ends_with(paste0("[",river_wo_broodline,"]")))
    
    posterior_rv_alpha_j <- posterior %>% 
      select(starts_with('alpha_j')) %>%
      select(ends_with(paste0("[",river_w_broodline,"]")))
    
    posterior_rv_S_max <- posterior %>% 
      select(starts_with('Smax')) %>%
      select(ends_with(paste0("[",river_w_broodline,"]")))
    
  posterior_bh_rv_b_for <- posterior_bh %>% 
      select(starts_with('b_for_rv')) %>%
      select(ends_with(paste0("[",river_wo_broodline,"]")))
    
  posterior_bh_rv_b_npgo <- posterior_bh %>%
      select(starts_with('b_npgo_rv')) %>%
      select(ends_with(paste0("[",river_wo_broodline,"]")))
  
  posterior_bh_rv_b_sst <- posterior_bh %>%
      select(starts_with('b_sst_rv')) %>%
      select(ends_with(paste0("[",river_wo_broodline,"]")))
  
  
    posterior_bh_rv_alpha_j <- posterior_bh %>%
      select(starts_with('alpha_j')) %>%
      select(ends_with(paste0("[",river_w_broodline,"]")))
    
    posterior_bh_rv_Rk <- posterior_bh %>%
      select(starts_with('Rk')) %>%
      select(ends_with(paste0("[",river_w_broodline,"]")))
    
  
  residual_df <- data.frame(spawners = river_data$Spawners,
                              recruits = river_data$Recruits,
                              observed_log_RS = river_data$ln_RS,
                              predicted_log_RS = apply((matrix(posterior_rv_alpha_j[,1], ncol = length(river_data$Spawners), nrow = length(posterior_rv_alpha_j[,1])) - as.matrix(1/posterior_rv_S_max)%*%river_data$Spawners + as.matrix(posterior_rv_b_for)%*%river_data$sqrt.CPD.std + as.matrix(posterior_rv_b_npgo)%*%river_data$npgo.std + as.matrix(posterior_rv_b_sst)%*%river_data$sst.std), 2, median),
                              cpd = river_data$disturbedarea_prct_cs,
                            sqrt.CPD.std = river_data$sqrt.CPD.std,
                            forestry_effect = apply(as.matrix(posterior_rv_b_for)%*%river_data$sqrt.CPD.std, 2, median)
    )
    
    residual_df$residuals <- residual_df$observed_log_RS - residual_df$predicted_log_RS
    
    residual_df$partial_residuals <- residual_df$residuals + residual_df$forestry_effect
  
    residual_df_full <- rbind(residual_df_full, residual_df)
    
    
    
    residual_bh_df <- data.frame(spawners = river_data$Spawners,
                              recruits = river_data$Recruits,
                              observed_log_RS = river_data$ln_RS,
                              predicted_log_RS = apply((matrix(posterior_bh_rv_alpha_j[,1], ncol = length(river_data$Spawners), nrow = length(posterior_bh_rv_alpha_j[,1])) - log(1+as.matrix(exp(posterior_bh_rv_alpha_j[,1])/posterior_bh_rv_Rk)%*%river_data$Spawners) + 
                                                          as.matrix(posterior_bh_rv_b_for)%*%river_data$sqrt.CPD.std + 
                                                          as.matrix(posterior_bh_rv_b_npgo)%*%river_data$npgo.std + 
                                                          as.matrix(posterior_bh_rv_b_sst)%*%river_data$sst.std), 2, median),
                              cpd = river_data$disturbedarea_prct_cs,
                              sqrt.CPD.std = river_data$sqrt.CPD.std,
                              forestry_effect = apply(as.matrix(posterior_bh_rv_b_for)%*%river_data$sqrt.CPD.std, 2, median))
    
    residual_bh_df$residuals <- residual_bh_df$observed_log_RS - residual_bh_df$predicted_log_RS
    
    residual_bh_df$partial_residuals <- residual_bh_df$residuals + residual_bh_df$forestry_effect
    
    residual_bh_df_full <- rbind(residual_bh_df_full, residual_bh_df)
    
}


p_pk_ric_residuals <- ggplot(residual_df_full)+
  geom_point(aes(x = predicted_log_RS, y = residuals, color = cpd), alpha = 0.2, size = 2) +
  geom_hline(yintercept = 0, color = 'black', linetype = 'dashed') +
  labs(title = "Ricker model with CPD, NPGO, ERSST", x = TeX(r"(Predicted $\log \left(\frac{Recruits}{Spawners}\right)$)"), y = "Residuals") +
  scale_color_gradient2(name = 'CPD (%)',
                                        low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = 50)+
  ylim(-6, 6) +
  theme_classic() +
  
  theme(legend.position = "right",
        legend.key.width = unit(0.5, "cm"),
        legend.key.height = unit(1, "lines"),
        legend.text = element_text(size = 7),
        legend.spacing.y = unit(0.001, "cm"),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(size = 16, hjust = 0.5)
        )

p_pk_ric_partial_residuals <- ggplot(residual_df_full)+
  geom_point(aes(x = sqrt.CPD.std, y = partial_residuals, color = cpd), alpha = 0.2, size = 2) +
  geom_hline(yintercept = 0, color = 'black', linetype = 'dashed') +
  geom_smooth(aes(x = sqrt.CPD.std, y = partial_residuals), method = 'lm', se = TRUE, color = 'black') +
  labs(title = "Ricker model with CPD, NPGO, ERSST", x = TeX(r"($standardized\ \sqrt{CPD}$)"), 
       y = TeX(r"(Residuals + $\beta_{forestry, river} \times standardized\ \sqrt{CPD}$)")) +
  scale_color_gradient2(name = 'CPD (%)',
                                        low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = 50)+
  ylim(-6, 6) +
  theme_classic() +
  
  theme(legend.position = "right",
        legend.key.width = unit(0.5, "cm"),
        legend.key.height = unit(1, "lines"),
        legend.text = element_text(size = 7),
        legend.spacing.y = unit(0.001, "cm"),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(size = 16, hjust = 0.5)
        )



p_pk_bh_residuals <- ggplot(residual_bh_df_full)+
  geom_point(aes(x = predicted_log_RS, y = residuals, color = cpd), alpha = 0.2, size = 2) +
  geom_hline(yintercept = 0, color = 'black', linetype = 'dashed') +
  labs(title = "BH model with CPD, NPGO, ERSST", x = TeX(r"(Predicted $\log \left(\frac{Recruits}{Spawners}\right)$)"), y = "Residuals") +
  scale_color_gradient2(name = 'CPD (%)',
                                        low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = 50)+
  ylim(-6, 6) +
  theme_classic() +
  theme(legend.position = "right",
        legend.key.width = unit(0.5, "cm"),
        legend.key.height = unit(1, "lines"),
        legend.text = element_text(size = 7),
        legend.spacing.y = unit(0.001, "cm"),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(size = 16, hjust = 0.5)
        )



p_bh_pk_ric_partial_residuals <- ggplot(residual_bh_df_full)+
  geom_point(aes(x = sqrt.CPD.std, y = partial_residuals, color = cpd), alpha = 0.2, size = 2) +
  geom_hline(yintercept = 0, color = 'black', linetype = 'dashed') +
  geom_smooth(aes(x = sqrt.CPD.std, y = partial_residuals), method = 'lm', se = TRUE, color = 'black') +
  labs(title = "BH model with CPD, NPGO, ERSST", x = TeX(r"($standardized\ \sqrt{CPD}$)"), 
       y = TeX(r"(Residuals + $\beta_{forestry, river} \times standardized\ \sqrt{CPD}$)")) +
  scale_color_gradient2(name = 'CPD (%)',
                                        low = '#35978f', mid = 'gray', high = '#bf812d', midpoint = 50)+
  ylim(-6, 6) +
  theme_classic() +
  
  theme(legend.position = "right",
        legend.key.width = unit(0.5, "cm"),
        legend.key.height = unit(1, "lines"),
        legend.text = element_text(size = 7),
        legend.spacing.y = unit(0.001, "cm"),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(size = 16, hjust = 0.5)
        )


print(((p_pk_ric_residuals + p_pk_bh_residuals)/
       (p_pk_ric_partial_residuals + p_bh_pk_ric_partial_residuals)
         ) + plot_layout(guides = "collect"))


```

\newpage

## Spawner-Recruit fits


```{r, spawner-recruit-pink, fig.width = 10, fig.height = 8, results="asis"}

species = "pink"

df <- pk10r
    
posterior <- ric_pk_cpd_ersst
    
posterior_bh <- bh_pk_cpd_ersst

posterior_a_t <- ric_pk_cpd

posterior_a_t_bh <- bh_pk_cpd

rivers <- unique(df$River_n2)



for(river in rivers){
  
  river_data <- df %>% filter(River_n2 == river)
  cat('\n')  
  cat("### ", river_data$River2[1], "\n")
    
  plot_recruit_spawner(data = df, species = species, river = river, river_data,  posterior = posterior, posterior_bh = posterior_bh)
  
}
# river = 639
# river_data <- df %>% filter(River_n2 == river)
# plot_recruit_spawner(data = df, species = species, river = 639, river_data, posterior = posterior, posterior_bh = posterior_bh, 
#                      posterior_a_t, posterior_a_t_bh)

```




