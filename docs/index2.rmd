### Ricker

Here are the results for the alternative Ricker model forms.

#### CU-level varying effects for ECA and CPD

```{r, cum model fits,echo=FALSE}
f1bh_chm_eca= readRDS(here('stan models','outs','fits','fit1bh_chm_eca.RDS'))
f1bh_chm_cpd= readRDS(here('stan models','outs','fits','fit1bh_chm_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit are outputted below. The plot shows density of effect sizes among CUs and the red line indicates the global effect:
  
  ```{r, chm fitset 1 bh}
d1eca=f1bh_chm_eca$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d1eca[,1],bw=0.02)
for(j in 2:ncol(d1eca)){
  d=density(d1eca[,j],bw=0.02)
  lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

d1cpd=f1bh_chm_cpd$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d1cpd[,1],bw=0.02)
for(j in 2:ncol(d1cpd)){
  d=density(d1cpd[,j],bw=0.02)
  lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d1eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='n',type='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 2:ncol(d1eca)){
  ps=d1eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)
lines(m_pred~eca_n,lwd=3,col='darkred')

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d1cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~cpd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 2:ncol(d1cpd)){
  ps=d1cpd[,j]%*%x_n
  lines(apply(ps,2,median)~pcd_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~cpd_n,lty=5)
lines(u_pred~pcd_n,lty=5)
lines(m_pred~cpd_n,lwd=3,col='darkred')

```


#### River-level varying effects of ECA and CPD

```{r, cum model fits,echo=FALSE}
f2bh_chm_eca= readRDS(here('stan models','outs','fits','fit2bh_chm_eca.RDS'))
f2bh_chm_cpd= readRDS(here('stan models','outs','fits','fit2bh_chm_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit.

This plot shows density of effect sizes among CUs and the red line indicates the global effect:
  
  ```{r, chm fitset 2 bh}
d2eca=f2bh_chm_eca$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')
d2cpd=f2bh_chm_cpd$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d2_eca[,1],bw=0.02)
for(j in 2:ncol(d2_eca)){ #22 cus
  d=density(d2_eca[,j],bw=0.02)
  lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d2_cpd[,1],bw=0.02)
for(j in 2:ncol(d2_cpd)){ #22 cus
  d=density(d2_cpd[,j],bw=0.02)
  lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d2eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),type='n')
for(j in 2:ncol(d2eca)){
  ps=d2eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~eca_n,lwd=3,col='darkred')
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d2cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~pcd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2))
for(j in 2:ncol(d2cpd)){
  ps=d2cpd[,j]%*%x_n
  lines(apply(ps,2,median)~pcd_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~cpd_n,lwd=3,col='darkred')
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)

```

#### Non-linear effects for ECA and CPD

To explore if there were any signs of strong non-linear patterns in how ECA affects forestry we implemented an approach equivalent to a Generalized Additive Model (GAM). We use a matrix of B-splines with 6 knots that subdivide the predictor (ECA/CPD), the resulting estimated effect of ECA at any given point is the sum of these smoothed functions. The global function of ECA effects on productivity fit to all rivers/CUs is: 
  
  ```{r, chm gam bh}
fit_bh_chm_eca_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_eca_gam.RDS'))
fit_bh_chm_cpd_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_cpd_gam.RDS'))

d=fit_bh_chm_eca_gam$draws(variables='RS_pred_ECA',format='draws_matrix')
plot(apply(d,2,median)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),xlab='ECA',ylab='Marginal effect on productivity',type='l',lwd=3,bty='l',ylim=c(-1.5,-0.2))
lines(apply(d,2,quantile,0.025)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)
lines(apply(d,2,quantile,0.975)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)

```


#### Watershed area as a mediator

Posterior estimates of the interaction between watershed area and the effect of ECA (median in red):
  
  ```{r, areaxeca chm}
f3bh_chm_eca=readRDS(here('stan models','outs','fits','fit3bh_chm_eca.RDS'))

d3chm=f3bh_chm_eca$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

Posterior estimates of the interaction between watershed area and the effect of CPD (median in red):
  
  ```{r, areaxcpd chm}
f3bh_chm_cpd=readRDS(here('stan models','outs','fits','fit3bh_chm_cpd.RDS'))

d3chm=f3bh_chm_cpd$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

### Ricker

Here are the results for the alternative Ricker model forms.

#### CU-level varying effects for ECA and CPD

```{r, cum model fits,echo=FALSE}
f1bh_chm_eca= readRDS(here('stan models','outs','fits','fit1bh_chm_eca.RDS'))
f1bh_chm_cpd= readRDS(here('stan models','outs','fits','fit1bh_chm_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit are outputted below. The plot shows density of effect sizes among CUs and the red line indicates the global effect:
  
  ```{r, chm fitset 1 bh}
d1eca=f1bh_chm_eca$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d1eca[,1],bw=0.02)
for(j in 2:ncol(d1eca)){
  d=density(d1eca[,j],bw=0.02)
  lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

d1cpd=f1bh_chm_cpd$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d1cpd[,1],bw=0.02)
for(j in 2:ncol(d1cpd)){
  d=density(d1cpd[,j],bw=0.02)
  lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d1eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='n',type='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 2:ncol(d1eca)){
  ps=d1eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)
lines(m_pred~eca_n,lwd=3,col='darkred')

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d1cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~cpd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 2:ncol(d1cpd)){
  ps=d1cpd[,j]%*%x_n
  lines(apply(ps,2,median)~pcd_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~cpd_n,lty=5)
lines(u_pred~pcd_n,lty=5)
lines(m_pred~cpd_n,lwd=3,col='darkred')

```


#### River-level varying effects of ECA and CPD

```{r, cum model fits,echo=FALSE}
f2bh_chm_eca= readRDS(here('stan models','outs','fits','fit2bh_chm_eca.RDS'))
f2bh_chm_cpd= readRDS(here('stan models','outs','fits','fit2bh_chm_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit.

This plot shows density of effect sizes among CUs and the red line indicates the global effect:
  
  ```{r, chm fitset 2 bh}
d2eca=f2bh_chm_eca$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')
d2cpd=f2bh_chm_cpd$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d2_eca[,1],bw=0.02)
for(j in 2:ncol(d2_eca)){ #22 cus
  d=density(d2_eca[,j],bw=0.02)
  lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d2_cpd[,1],bw=0.02)
for(j in 2:ncol(d2_cpd)){ #22 cus
  d=density(d2_cpd[,j],bw=0.02)
  lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d2eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),type='n')
for(j in 2:ncol(d2eca)){
  ps=d2eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~eca_n,lwd=3,col='darkred')
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d2cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~pcd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2))
for(j in 2:ncol(d2cpd)){
  ps=d2cpd[,j]%*%x_n
  lines(apply(ps,2,median)~pcd_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~cpd_n,lwd=3,col='darkred')
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)

```

#### Non-linear effects for ECA and CPD

To explore if there were any signs of strong non-linear patterns in how ECA affects forestry we implemented an approach equivalent to a Generalized Additive Model (GAM). We use a matrix of B-splines with 6 knots that subdivide the predictor (ECA/CPD), the resulting estimated effect of ECA at any given point is the sum of these smoothed functions. The global function of ECA effects on productivity fit to all rivers/CUs is: 
  
  ```{r, chm gam bh}
fit_bh_chm_eca_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_eca_gam.RDS'))
fit_bh_chm_cpd_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_cpd_gam.RDS'))

d=fit_bh_chm_eca_gam$draws(variables='RS_pred_ECA',format='draws_matrix')
plot(apply(d,2,median)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),xlab='ECA',ylab='Marginal effect on productivity',type='l',lwd=3,bty='l',ylim=c(-1.5,-0.2))
lines(apply(d,2,quantile,0.025)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)
lines(apply(d,2,quantile,0.975)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)

```


#### Watershed area as a mediator

Posterior estimates of the interaction between watershed area and the effect of ECA (median in red):
  
  ```{r, areaxeca chm}
f3bh_chm_eca=readRDS(here('stan models','outs','fits','fit3bh_chm_eca.RDS'))

d3chm=f3bh_chm_eca$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

Posterior estimates of the interaction between watershed area and the effect of CPD (median in red):
  
  ```{r, areaxcpd chm}
f3bh_chm_cpd=readRDS(here('stan models','outs','fits','fit3bh_chm_cpd.RDS'))

d3chm=f3bh_chm_cpd$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

### Ricker

Here are the results for the alternative Ricker model forms.

#### CU-level varying effects for ECA and CPD

```{r, cum model fits,echo=FALSE}
f1bh_chm_eca= readRDS(here('stan models','outs','fits','fit1bh_chm_eca.RDS'))
f1bh_chm_cpd= readRDS(here('stan models','outs','fits','fit1bh_chm_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit are outputted below. The plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, chm fitset 1 bh}
d1eca=f1bh_chm_eca$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d1eca[,1],bw=0.02)
for(j in 2:ncol(d1eca)){
d=density(d1eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

d1cpd=f1bh_chm_cpd$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d1cpd[,1],bw=0.02)
for(j in 2:ncol(d1cpd)){
d=density(d1cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n_eca=seq(min(ch20r$ECA_age_proxy_forested_only_std),max(ch20r$ECA_age_proxy_forested_only_std),length.out=100)
eca_n=x_n_eca*sd(ch20r$ECA_age_proxy_forested_only)+mean(ch20r$ECA_age_proxy_forested_only)

x_n_eca=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n_eca*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

x_n_eca=seq(min(ch20r$sqrt.ECA.std),max(ch20r$sqrt.ECA.std),length.out=100)
eca_n=(x_n_eca*sd(ch20r$sqrt.ECA)+mean(ch20r$sqrt.ECA))^2



pRS=d1eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='n',type='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 2:ncol(d1eca)){
  ps=d1eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)
lines(m_pred~eca_n,lwd=3,col='darkred')

x_n=seq(min(ch20r$sqrt.CPD.std),max(ch20r$sqrt.CPD.std),length.out=100)
cpd_n=(x_n*sd(ch20r$sqrt.CPD)+mean(ch20r$sqrt.CPD))^2

pRS=d1cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~cpd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 2:ncol(d1cpd)){
  ps=d1cpd[,j]%*%x_n
  lines(apply(ps,2,median)~pcd_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)
lines(m_pred~cpd_n,lwd=3,col='darkred')

```


#### River-level varying effects of ECA and CPD

```{r, cum model fits,echo=FALSE}
f2bh_chm_eca= readRDS(here('stan models','outs','fits','fit2bh_chm_eca.RDS'))
f2bh_chm_cpd= readRDS(here('stan models','outs','fits','fit2bh_chm_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit.

This plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, chm fitset 2 bh}
d2eca=f2bh_chm_eca$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')
d2cpd=f2bh_chm_cpd$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d2_eca[,1],bw=0.02)
for(j in 2:ncol(d2_eca)){ #22 cus
d=density(d2_eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d2_cpd[,1],bw=0.02)
for(j in 2:ncol(d2_cpd)){ #22 cus
d=density(d2_cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d2eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),type='n')
for(j in 2:ncol(d2eca)){
  ps=d2eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~eca_n,lwd=3,col='darkred')
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d2cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~pcd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2))
for(j in 2:ncol(d2cpd)){
  ps=d2cpd[,j]%*%x_n
  lines(apply(ps,2,median)~pcd_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~cpd_n,lwd=3,col='darkred')
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)

```

#### Non-linear effects for ECA and CPD

To explore if there were any signs of strong non-linear patterns in how ECA affects forestry we implemented an approach equivalent to a Generalized Additive Model (GAM). We use a matrix of B-splines with 6 knots that subdivide the predictor (ECA/CPD), the resulting estimated effect of ECA at any given point is the sum of these smoothed functions. The global function of ECA effects on productivity fit to all rivers/CUs is: 

```{r, chm gam bh}
fit_bh_chm_eca_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_eca_gam.RDS'))
fit_bh_chm_cpd_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_cpd_gam.RDS'))

d=fit_bh_chm_eca_gam$draws(variables='RS_pred_ECA',format='draws_matrix')
plot(apply(d,2,median)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),xlab='ECA',ylab='Marginal effect on productivity',type='l',lwd=3,bty='l',ylim=c(-1.5,-0.2))
lines(apply(d,2,quantile,0.025)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)
lines(apply(d,2,quantile,0.975)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)

```


#### Watershed area as a mediator

Posterior estimates of the interaction between watershed area and the effect of ECA (median in red):

```{r, areaxeca chm}
f3bh_chm_eca=readRDS(here('stan models','outs','fits','fit3bh_chm_eca.RDS'))

d3chm=f3bh_chm_eca$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

Posterior estimates of the interaction between watershed area and the effect of CPD (median in red):

```{r, areaxcpd chm}
f3bh_chm_cpd=readRDS(here('stan models','outs','fits','fit3bh_chm_cpd.RDS'))

d3chm=f3bh_chm_cpd$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

### Ricker

```{r, sr time-series, fig.width=12,fig.height=8, results="asis"}
ch20r$cuid=as.numeric(factor(ch20r$CU))

d_ric1_chm=f1ric_chm_eca$draws(variables=c('alpha_j','Smax','b_ECA_cu'),form='draws_matrix')

for(c in 1:length(unique(ch20r$River))){
  cat('\n')  
  cat("## ", levels(factor(ch20r$River))[c], "\n")
  #CU header
  rv=subset(ch20r,River==levels(factor(ch20r$River))[c])
   cols= rev(RColorBrewer::brewer.pal(9,'BrBG'));
   br=quantile(rv$ECA_age_proxy_forested_only,probs=seq(0,1,length.out=8))
   col_points=adjustcolor(cols[findInterval(rv$ECA_age_proxy_forested_only,br)],alpha.f=0.8)
   
  
  par(mfrow=c(2,2))
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(BH)',sep=' '))
  
  alpha_j=d_bh1[,colnames(d_bh1) %in% paste('alpha_j[',c,']',sep='')]
  Rk_j=d_bh1[,colnames(d_bh1) %in% paste('Rk[',c,']',sep='')]
  b_ECA=d_bh1[,colnames(d_bh1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.95))*s_pred
  
    RS_pred_eca_t=exp(apply(matrix(alpha_j,ncol=length(rv$Spawners),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%rv$Spawners)+matrix(b_ECA%*%(rv$logit.ECA.std),ncol=length(rv$Spawners),nrow=nrow(alpha_j)),2,median))*rv$Spawners
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*min(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*max(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points,pch=21,cex=1.5) 
  
  #CPD
   br=quantile(rv$disturbedarea_prct_cs,probs=seq(0,1,length.out=8))
   col_points=adjustcolor(cols[findInterval(rv$disturbedarea_prct_cs,br)],alpha.f=0.8)
   
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(Ricker)',sep=' '))
  
  alpha_j=d_ric1[,colnames(d_ric1) %in% paste('alpha_j[',c,']',sep='')]
  Smax=d_ric1[,colnames(d_ric1) %in% paste('Smax[',c,']',sep='')]
  b_ECA=d_ric1[,colnames(d_ric1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred+matrix(b_ECA*min(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred+matrix(b_ECA*max(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col='darkgreen',lwd=3)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points,pch=21,cex=1.5) 
  
   plot(rv$ECA_age_proxy_forested_only~rv$BroodYear,bty='l',type='n',xlab='Brood Year',ylab='ECA')
   lines(ECA_age_proxy_forested_only~BroodYear,data=rv)
    points(ECA_age_proxy_forested_only~BroodYear,data=rv,bg=col_points,pch=21,cex=1.5) 
  
  bh_effect=d_bh1[,colnames(d_bh1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
  bh_effect_m=apply(bh_effect,2,median)
  
  
  ric_effect=d_ric1[,colnames(d_ric1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
  ric_effect_m=apply(ric_effect,2,median)
    
   plot(ric_effect_m~rv$BroodYear,bty='l',type='n',ylim=c(min(c(bh_effect_m,ric_effect_m)),max(c(bh_effect_m,ric_effect_m))),ylab='Marginal effect on productivity through time',xlab='Brood Year')
   lines(bh_effect_m~BroodYear,data=rv,col='navy',lwd=2)
    points(bh_effect_m~BroodYear,data=rv,bg='navy',pch=21,cex=1.5) 
  
    lines(ric_effect_m~BroodYear,data=rv,col='tan2',lwd=2)
    points(ric_effect_m~BroodYear,data=rv,bg='tan2',pch=21,cex=1.5) 
    text(x=par('usr')[2]-5,y=bh_effect_m[length(bh_effect_m)]*1.05,'Beverton-Holt',col='navy')
    text(x=par('usr')[2]-5,y=ric_effect_m[length(ric_effect_m)]*1.05,'Ricker',col='tan2')

   cat('\n')  
}
```

## Density dependence form comparison - each species

First we assessed the general form of density dependence (model 1: Ricker, model 2: BH, model 3: Cushing) for each species, based on approximate leave-one-out cross-validation.

Chum:

```{r, loo chm}
loo_comp=readRDS(here('stan models','outs','loo','loo_results_chm_fitset1.RDS'))
loo_comp[,1:6]
```

Pink (even):

```{r, loo pke}
loo_comp=readRDS(here('stan models','outs','loo','loo_results_pke_fitset1.RDS'))
loo_comp[,1:6]
```

Pink (odd):

```{r, loo pko}
loo_comp=readRDS(here('stan models','outs','loo','loo_results_pko_fitset1.RDS'))
loo_comp[,1:6]
```

In each case the Beverton-Holt model had substantially higher likelihoods than the Ricker or Cushing model forms. We will proceed with results for both BH and Ricker however.


## Pink - Even

### Beverton-Holt

```{r, pke bh sr time-series, fig.width=12,fig.height=8, results="asis"}
pk10r_e$cuid=as.numeric(factor(pk10r_e$CU))
f1bh_pke_eca=readRDS(here('stan models','outs','fits','fit1bh_pke_eca.RDS'))
f1bh_pke_cpd=readRDS(here('stan models','outs','fits','fit1bh_pke_cpd.RDS'))

dbh1_pke_eca=f1bh_pke_eca$draws(variables=c('alpha_j','Rk','b_ECA_cu'),form='draws_matrix')
dbh1_pke_cpd=f1bh_pke_cpd$draws(variables=c('alpha_j','Rk','b_ECA_cu'),form='draws_matrix')

for(c in 1:length(unique(pk10r_e$River))){
 cat('\n')  
  cat("## ", levels(factor(pk10r_e$River))[c], "\n")
  #CU header
  rv=subset(pk10r_e,River==levels(factor(pk10r_e$River))[c])
   cols= rev(RColorBrewer::brewer.pal(9,'BrBG'));
   br1=quantile(rv$ECA_age_proxy_forested_only,probs=seq(0,1,length.out=8))
   col_points1=adjustcolor(cols[findInterval(rv$ECA_age_proxy_forested_only,br1)],alpha.f=0.8)
   br2=quantile(rv$disturbedarea_prct_cs,probs=seq(0,1,length.out=8))
   col_points2=adjustcolor(cols[findInterval(rv$disturbedarea_prct_cs,br2)],alpha.f=0.8)
   
  par(mfrow=c(2,2))
  
  #ECA
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(ECA)',sep=' '))
  
  alpha_j=dbh1_pke_eca[,colnames(dbh1_pke_eca) %in% paste('alpha_j[',c,']',sep='')]
  Rk_j=dbh1_pke_eca[,colnames(dbh1_pke_eca) %in% paste('Rk[',c,']',sep='')]
  b_ECA=dbh1_pke_eca[,colnames(dbh1_pke_eca) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*min(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*max(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points1,pch=21,cex=1.5) 
  
  #CPD
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(CPD)',sep=' '))
  
  alpha_j=dbh1_pke_cpd[,colnames(dbh1_pke_cpd) %in% paste('alpha_j[',c,']',sep='')]
  Rk_j=dbh1_pke_cpd[,colnames(dbh1_pke_cpd) %in% paste('Rk[',c,']',sep='')]
  b_ECA=dbh1_pke_cpd[,colnames(dbh1_pke_cpd) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*min(rv$logit.pdisturb.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*max(rv$logit.pdisturb.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points2,pch=21,cex=1.5) 
  
  
   plot(rv$ECA_age_proxy_forested_only~rv$BroodYear,bty='l',type='n',xlab='Brood Year',ylab='Forest loss metric',ylim=c(0,1))
   lines(ECA_age_proxy_forested_only~BroodYear,data=rv,col='navy',lwd=2)
    points(ECA_age_proxy_forested_only~BroodYear,data=rv,bg=col_points1,pch=21,cex=1.5,col='navy') 
   lines(rv$disturbedarea_prct_cs/100~BroodYear,data=rv,col='tan2',lwd=2)
    points(rv$disturbedarea_prct_cs/100~BroodYear,data=rv,bg=col_points2,pch=21,cex=1.5,col='tan2')
    text(x=par('usr')[2]-4,y=par('usr')[4]*0.95,'ECA',col='navy')
    text(x=par('usr')[2]-4,y=par('usr')[4]*0.88,'CPD',col='tan2')
  
  realized_eca=dbh1_pke_eca[,colnames(dbh1_pke_eca) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
 realized_eca_m=apply(realized_eca,2,median)
  
   realized_cpd=dbh1_pke_cpd[,colnames(dbh1_pke_cpd) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
 realized_cpd_m=apply(realized_cpd,2,median)
    
   plot(realized_eca_m~rv$BroodYear,bty='l',type='n',ylim=c(min(c(realized_eca_m,realized_cpd_m)),max(c(realized_eca_m,realized_cpd_m))*1.1),ylab='Marginal effect on productivity through time',xlab='Brood Year')
   lines(realized_eca_m~BroodYear,data=rv,col='navy',lwd=2)
    points(realized_eca_m~BroodYear,data=rv,bg='navy',pch=21,cex=1.5) 
  
   lines(realized_cpd_m~BroodYear,data=rv,col='tan2',lwd=2)
    points(realized_cpd_m~BroodYear,data=rv,bg='tan2',pch=21,cex=1.5) 
   
    
    text(x=par('usr')[2]-5,y=realized_eca_m[length(realized_eca_m)]+(par('usr')[4]-par('usr')[3])*0.03,'ECA',col='navy')
    text(x=par('usr')[2]-5,y=realized_cpd_m[length(realized_cpd_m)]+(par('usr')[4]-par('usr')[3])*0.03,'CPD',col='tan2')

   cat('\n')  
}
```

## Pink - Odd

```{r, pko bh sr time-series, fig.width=12,fig.height=8, results="asis"}
pk10r_o$cuid=as.numeric(factor(pk10r_o$CU))

f1bh_pko_eca=readRDS(here('stan models','outs','fits','fit1bh_pko_eca.RDS'))
f1bh_pko_cpd=readRDS(here('stan models','outs','fits','fit1bh_pko_cpd.RDS'))

dbh1_pko_eca=f1bh_pko_eca$draws(variables=c('alpha_j','Rk','b_ECA_cu'),form='draws_matrix')
dbh1_pko_cpd=f1bh_pko_cpd$draws(variables=c('alpha_j','Rk','b_ECA_cu'),form='draws_matrix')

for(c in 1:length(unique(pk10r_o$River))){
 cat('\n')  
  cat("### ", levels(factor(pk10r_o$River))[c], "\n")
  #CU header
  rv=subset(pk10r_o,River==levels(factor(pk10r_o$River))[c])
   cols= rev(RColorBrewer::brewer.pal(9,'BrBG'));
   br1=quantile(rv$ECA_age_proxy_forested_only,probs=seq(0,1,length.out=8))
   col_points1=adjustcolor(cols[findInterval(rv$ECA_age_proxy_forested_only,br1)],alpha.f=0.8)
   br2=quantile(rv$disturbedarea_prct_cs,probs=seq(0,1,length.out=8))
   col_points2=adjustcolor(cols[findInterval(rv$disturbedarea_prct_cs,br2)],alpha.f=0.8)
   
  par(mfrow=c(2,2))
  
  #ECA
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(ECA)',sep=' '))
  
  alpha_j=dbh1_pko_eca[,colnames(dbh1_pko_eca) %in% paste('alpha_j[',c,']',sep='')]
  Rk_j=dbh1_pko_eca[,colnames(dbh1_pko_eca) %in% paste('Rk[',c,']',sep='')]
  b_ECA=dbh1_pko_eca[,colnames(dbh1_pko_eca) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*min(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*max(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points1,pch=21,cex=1.5) 
  
  #CPD
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(CPD)',sep=' '))
  
  alpha_j=dbh1_pko_cpd[,colnames(dbh1_pko_cpd) %in% paste('alpha_j[',c,']',sep='')]
  Rk_j=dbh1_pko_cpd[,colnames(dbh1_pko_cpd) %in% paste('Rk[',c,']',sep='')]
  b_ECA=dbh1_pko_cpd[,colnames(dbh1_pko_cpd) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*min(rv$logit.pdisturb.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*max(rv$logit.pdisturb.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points2,pch=21,cex=1.5) 
  
  
   plot(rv$ECA_age_proxy_forested_only~rv$BroodYear,bty='l',type='n',xlab='Brood Year',ylab='Forest loss metric',ylim=c(0,1))
   lines(ECA_age_proxy_forested_only~BroodYear,data=rv,col='navy',lwd=2)
    points(ECA_age_proxy_forested_only~BroodYear,data=rv,bg=col_points1,pch=21,cex=1.5,col='navy') 
   lines(rv$disturbedarea_prct_cs/100~BroodYear,data=rv,col='tan2',lwd=2)
    points(rv$disturbedarea_prct_cs/100~BroodYear,data=rv,bg=col_points2,pch=21,cex=1.5,col='tan2')
    text(x=par('usr')[2]-4,y=par('usr')[4]*0.95,'ECA',col='navy')
    text(x=par('usr')[2]-4,y=par('usr')[4]*0.88,'CPD',col='tan2')
  
  realized_eca=dbh1_pko_eca[,colnames(dbh1_pko_eca) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
 realized_eca_m=apply(realized_eca,2,median)
  
   realized_cpd=dbh1_pko_cpd[,colnames(dbh1_pko_cpd) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
 realized_cpd_m=apply(realized_cpd,2,median)
    
   plot(realized_eca_m~rv$BroodYear,bty='l',type='n',ylim=c(min(c(realized_eca_m,realized_cpd_m)),max(c(realized_eca_m,realized_cpd_m))*1.1),ylab='Marginal effect on productivity through time',xlab='Brood Year')
   lines(realized_eca_m~BroodYear,data=rv,col='navy',lwd=2)
    points(realized_eca_m~BroodYear,data=rv,bg='navy',pch=21,cex=1.5) 
  
   lines(realized_cpd_m~BroodYear,data=rv,col='tan2',lwd=2)
    points(realized_cpd_m~BroodYear,data=rv,bg='tan2',pch=21,cex=1.5) 
   
    
    text(x=par('usr')[2]-5,y=realized_eca_m[length(realized_eca_m)]+(par('usr')[4]-par('usr')[3])*0.03,'ECA',col='navy')
    text(x=par('usr')[2]-5,y=realized_cpd_m[length(realized_cpd_m)]+(par('usr')[4]-par('usr')[3])*0.03,'CPD',col='tan2')

   cat('\n')  
}
```


