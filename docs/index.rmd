---
title: "Coastwide analysis of forestry impacts on BC Pacific Salmon"
author: ''
date: "Apr. 2024"
output:
  html_document:
    collapsed: no
    fig_caption: yes
    highlight: espresso
    number_sections: yes
    smooth_scroll: yes
    theme: sandstone
    toc: yes
    toc_float: yes
---

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 13px;
  }
td {  /* Table  */
  font-size: 13px;
}
h1.title {
  font-size: 24px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 19px;
  color: Black;
}
h2 { /* Header 2 */
    font-size: 15px;
  color: Black;
}
h3 { /* Header 3 */
    font-size: 15px;
  color: Black;
}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
library(cmdstanr)
```

# Overview

This short document provides some details on initial models fit and inferential outputs. It can be treated as a living appendix of sorts, and can be added to and polished over time.

Code and data to reproduce the analyses summarized in this document can be found in [**this repository**](https://github.com/Pacific-salmon-assess/coastwide-salmon-forestry).

The first set of models we fit includes a covariate for ECA alone (logit transformed and standardized) which is modeled hierarchically down to CU-level for ECA effects and to the individual river (subscript $r$) level for productivity. We test 3 models for the structure of density dependence: either a Ricker (model 1), Beverton-Holt (model 2), or Cushing type (model 3) spawner-recruitment relationship. The stan models themselves are in the github repo as m1_ricker.stan, m1_bh.stan, m1_cush.stan.

The second set of models fit includes a finer-level of variation in stock responses to ECA - where the effect now varies at the river-level.

The third set of models fit includes an interaction of watershed area with the ECA effect - where the effect now varies according to watershed size.

# Models

## Ricker

The Ricker formulation of the model (with River-level varying effects for ECA) took the form:

$log(R_{t,r}/S_{t,r}) = \alpha_r - \beta_r*S_{t,r} + \beta_{eca,r}*ECA_{t,r} + w_{t,r}$

Where residual productivity is autocorrelated by 1-year:

$w_{1,r} \sim N(0,\sigma_r)$

$w_{t,r} \sim N(\rho_r*w_{t-1,r},\sigma_r*\sqrt(1-\rho_r^2))$

$\rho \sim U(-1,1)$

And stock-specific parameters are drawn hierarchically at the River-level for productivity and CU-level for forestry effects:

$\alpha_r \sim N(\alpha_{c}, \sigma_{ar}^2)$

$\alpha_{c} \sim N(\alpha, \sigma_{ac}^2)$

$\alpha \sim N(1.5,2)$

$\beta_{eca,r} \sim N(\beta_{eca,c}, \sigma_{eca,c})$

$\beta_{eca,c} \sim N(\beta_{eca}, \sigma_{eca})$

$\beta_{eca} \sim N(0,1)$

$\sigma_{eca} \sim N[0,0.5)$

$\sigma_r \sim N(\sigma_c,\sigma_{\sigma,r})$

$\sigma_c \sim N(\sigma,\sigma_{\sigma,c})$

$\sigma \sim N[0.5,0.5)$

Stock-specific within brood year density-dependence is estimated independently at the river level, but with informative priors for $S_{max}$ (=$1/\beta$; density where total predicted recruitment is maximized) based on observed spawner counts ($S_r$):

$\beta \sim lognormal(0.5*max(S_r),max(S_r))$

## Beverton-Holt

The Beverton Holt form of this model was linearized as:

$log(R_{t,r}/S_{t,r}) = \alpha_r - log(1+(e^{\alpha_r})/R_{k,r})*S_{t,r}) + \beta_{eca,c}*ECA_{t,r} + w_{t,r}$

Where the new parameter $R_{k,r}$ is the stock-specific equilibrium recruitment, sampled with informative priors based on observed recruitment ($R$):

$R_{k,r} \sim lognormal(0.75*max(R_r),max(R_r))$

## Cushing

For the Cushing model, the linearized form is:

$log(R_t,r/S_{t,r}) = \alpha_r + \beta_r*log(S_{t,r}) + \beta_{eca,c}*ECA_{t,r} + w_{t,r}$

A version of each model was fit to the Chum, Even-year Pink, and Odd-year Pink datasets.

```{r prep data,  include=FALSE}
 library(here);library(cmdstanr);library(dplyr)

ch20r <- read.csv("./origional-ecofish-data-models/Data/Processed/chum_SR_20_hat_yr_reduced_VRI90.csv")

#even year pinks
pk10r_e <- read.csv("./origional-ecofish-data-models/Data/Processed/pke_SR_10_hat_yr_reduced_VRI90.csv")

#odd year pinks
pk10r_o <- read.csv("./origional-ecofish-data-models/Data/Processed/pko_SR_10_hat_yr_reduced_VRI90.csv")

#two rivers named salmon river... recode
ch20r$River=ifelse(ch20r$WATERSHED_CDE=='950-169400-00000-00000-0000-0000-000-000-000-000-000-000','SALMON RIVER 2',ch20r$River)
ch20r$River=ifelse(ch20r$WATERSHED_CDE=="915-486500-05300-00000-0000-0000-000-000-000-000-000-000",'LAGOON CREEK 2',ch20r$River)
pk10r_e$River=ifelse(pk10r_e$WATERSHED_CDE=='950-169400-00000-00000-0000-0000-000-000-000-000-000-000','SALMON RIVER 2',pk10r_e$River)
pk10r_e$River=ifelse(pk10r_e$WATERSHED_CDE=='915-765500-18600-00000-0000-0000-000-000-000-000-000-000','HEAD CREEK 2',pk10r_e$River)
pk10r_e$River=ifelse(pk10r_e$WATERSHED_CDE=='915-488000-41400-00000-0000-0000-000-000-000-000-000-000','WINDY BAY CREEK 2',pk10r_e$River)
pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=='950-169400-00000-00000-0000-0000-000-000-000-000-000-000','SALMON RIVER 2',pk10r_o$River)
pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=='915-765500-18600-00000-0000-0000-000-000-000-000-000-000','HEAD CREEK 2',pk10r_o$River)
pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=='915-488000-41400-00000-0000-0000-000-000-000-000-000-000','WINDY BAY CREEK 2',pk10r_o$River)
#create logit transformed and standardized ECA:
ch20r$logit.ECA=qlogis(ch20r$ECA_age_proxy_forested_only+0.005)
ch20r$logit.ECA.std=(ch20r$logit.ECA-mean(ch20r$logit.ECA))/sd(ch20r$logit.ECA)
pk10r_e$logit.ECA=qlogis(pk10r_e$ECA_age_proxy_forested_only+0.005)
pk10r_e$logit.ECA.std=(pk10r_e$logit.ECA-mean(pk10r_e$logit.ECA))/sd(pk10r_e$logit.ECA)
pk10r_o$logit.ECA=qlogis(pk10r_o$ECA_age_proxy_forested_only+0.005)
pk10r_o$logit.ECA.std=(pk10r_o$logit.ECA-mean(pk10r_o$logit.ECA))/sd(pk10r_o$logit.ECA)

#create logit transformed and standardized CPD:
ch20r$disturbedarea_prct_cs2=ifelse(ch20r$disturbedarea_prct_cs<1,0.5,ch20r$disturbedarea_prct_cs)
ch20r$disturbedarea_prct_cs2=ifelse(ch20r$disturbedarea_prct_cs2>99,99.5,ch20r$disturbedarea_prct_cs2)
ch20r$logit.pdisturb=qlogis(ch20r$disturbedarea_prct_cs2/100)
ch20r$logit.pdisturb.std=(ch20r$logit.pdisturb-mean(ch20r$logit.pdisturb))/sd(ch20r$logit.pdisturb)

pk10r_e$disturbedarea_prct_cs2=ifelse(pk10r_e$disturbedarea_prct_cs<1,0.5,pk10r_e$disturbedarea_prct_cs)
pk10r_e$disturbedarea_prct_cs2=ifelse(pk10r_e$disturbedarea_prct_cs2>99,99.5,pk10r_e$disturbedarea_prct_cs2)
pk10r_e$logit.pdisturb=qlogis(pk10r_e$disturbedarea_prct_cs2/100)
pk10r_e$logit.pdisturb.std=(pk10r_e$logit.pdisturb-mean(pk10r_e$logit.pdisturb))/sd(pk10r_e$logit.pdisturb)

pk10r_o$disturbedarea_prct_cs2=ifelse(pk10r_o$disturbedarea_prct_cs<1,0.5,pk10r_o$disturbedarea_prct_cs)
pk10r_o$disturbedarea_prct_cs2=ifelse(pk10r_o$disturbedarea_prct_cs2>99,99.5,pk10r_o$disturbedarea_prct_cs2)
pk10r_o$logit.pdisturb=qlogis(pk10r_o$disturbedarea_prct_cs2/100)
pk10r_o$logit.pdisturb.std=(pk10r_o$logit.pdisturb-mean(pk10r_o$logit.pdisturb))/sd(pk10r_o$logit.pdisturb)
```

## Density dependence form comparison - each species

First we assessed the general form of density dependence (model 1: Ricker, model 2: BH, model 3: Cushing) for each species, based on approximate leave-one-out cross-validation.

Chum:

```{r, loo chm}
loo_comp=readRDS(here('stan models','outs','loo','loo_results_chm_fitset1.RDS'))
loo_comp[,1:6]
```

Pink (even):

```{r, loo pke}
loo_comp=readRDS(here('stan models','outs','loo','loo_results_pke_fitset1.RDS'))
loo_comp[,1:6]
```

Pink (odd):

```{r, loo pko}
loo_comp=readRDS(here('stan models','outs','loo','loo_results_pko_fitset1.RDS'))
loo_comp[,1:6]
```

In each case the Beverton-Holt model had substantially higher likelihoods tahn the Ricker or Cushing model forms. We will proceed with results for both BH and Ricker however.

# Forestry metrics by river, CU, and watershed area

The third set of models includes watershed area as a mediator of the effect of ECA on productivity:

$log(R_{t,r}/S_{t,r}) = \alpha_r - \beta_r*S_{t,r} + \beta_{eca,c}*ECA_{t,r} + \beta_{eca-x-area,c}*ECA_{t,r}*Area_{r} + w_{t,r}$

## Chum

This is the distribution of watershed area among 295 rivers with Chum surveys:

```{r, watershed area}
par(mfrow=c(1,1))
da=distinct(ch20r,River,.keep_all = T)
hist(log10(da$area_km2),xlab='Watershed area (km2)',xaxt='n',main='',breaks=30,xlim=c(0,log10(1e4)))
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

#da=da[order(da$area_km2),]
```

The range of observed ECAs can vary substantially by rivers and CUs:

```{r, chm eca range}
plot(rep(1,nrow(da))~seq(1,295),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(ch20r,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}

cu=distinct(ch20r,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,22),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(ch20r,CU==cu$CU[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(ch20r,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

The same plots for the Cumulative % Disturbed metric:

```{r, chm cpd range}
plot(rep(1,nrow(da))~seq(1,295),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(ch20r,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}

cu=distinct(ch20r,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,22),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(ch20r,CU==cu$CU[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(ch20r,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

## Pink Even

This is the distribution of watershed area among 336 rivers with Pink surveys:

```{r, watershed area}
da=distinct(pk10r_e,River,.keep_all = T)
hist(log10(da$area_km2),xlab='Watershed area (km2)',xaxt='n',main='',breaks=30,xlim=c(0,log10(1e4)))
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

#da=da[order(da$area_km2),]
```

The range of observed ECAs can vary substantially by rivers and CUs:

```{r, chm eca range}
plot(rep(1,nrow(da))~seq(1,336),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(pk10r_e,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}

cu=distinct(pk10r_e,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,9),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(pk10r_e,CU==cu$CU[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(pk10r_e,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

The same plots for the Cumulative % Disturbed metric:

```{r, chm cpd range}
plot(rep(1,nrow(da))~seq(1,336),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(pk10r_e,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}

cu=distinct(pk10r_e,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,9),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(pk10r_e,CU==cu$CU[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(pk10r_e,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

## Pink Odd

This is the distribution of watershed area among 251 rivers with Pink (odd) surveys:

```{r, watershed area}
da=distinct(pk10r_o,River,.keep_all = T)
hist(log10(da$area_km2),xlab='Watershed area (km2)',xaxt='n',main='',breaks=30,xlim=c(0,log10(1e4)))
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

#da=da[order(da$area_km2),]
```

The range of observed ECAs can vary substantially by rivers and CUs:

```{r, chm eca range}
plot(rep(1,nrow(da))~seq(1,251),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}

cu=distinct(pk10r_o,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,12),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(pk10r_o,CU==cu$CU[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

The same plots for the Cumulative % Disturbed metric:

```{r, chm cpd range}
plot(rep(1,nrow(da))~seq(1,251),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}

cu=distinct(pk10r_o,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,12),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(pk10r_o,CU==cu$CU[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

\newpage

# Forestry effects by species

This section will compare the productivity responses to two measures of forestry activity in watersheds: equivalent clearcut area (ECA) and the cumulative % of disturbed watershed area (CPD).

## Chum


### Beverton-Holt

The Beverton-Holt model formulation had the highest support amongst the considered density-dependence model forms for Chum.

#### CU-level varying effects for ECA and CPD

```{r, cum model fits,echo=FALSE}
f1bh_chm_eca= readRDS(here('stan models','outs','fits','fit1bh_chm_eca.RDS'))
f1bh_chm_cpd= readRDS(here('stan models','outs','fits','fit1bh_chm_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit are outputted below. The plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, chm fitset 1 bh}
d1eca=f1bh_chm_eca$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d1eca[,1],bw=0.02)
for(j in 2:ncol(d1eca)){
d=density(d1eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

d1cpd=f1bh_chm_cpd$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d1cpd[,1],bw=0.02)
for(j in 2:ncol(d1cpd)){
d=density(d1cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d1eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='n',type='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 2:ncol(d1eca)){
  ps=d1eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)
lines(m_pred~eca_n,lwd=3,col='darkred')

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d1cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~cpd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 2:ncol(d1cpd)){
  ps=d1cpd[,j]%*%x_n
  lines(apply(ps,2,median)~cpd_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)
lines(m_pred~cpd_n,lwd=3,col='darkred')

```


#### River-level varying effects of ECA and CPD

```{r, cum model fits,echo=FALSE}
f2bh_chm_eca= readRDS(here('stan models','outs','fits','fit2bh_chm_eca.RDS'))
f2bh_chm_cpd= readRDS(here('stan models','outs','fits','fit2bh_chm_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit.

This plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, chm fitset 2 bh}
d2eca=f2bh_chm_eca$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')
d2cpd=f2bh_chm_cpd$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d2_eca[,1],bw=0.02)
for(j in 2:ncol(d2_eca)){ #22 cus
d=density(d2_eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d2_cpd[,1],bw=0.02)
for(j in 2:ncol(d2_cpd)){ #22 cus
d=density(d2_cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d2eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),type='n')
for(j in 2:ncol(d2eca)){
  ps=d2eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~eca_n,lwd=3,col='darkred')
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d2cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~pcd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2))
for(j in 2:ncol(d2cpd)){
  ps=d2cpd[,j]%*%x_n
  lines(apply(ps,2,median)~pcd_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~cpd_n,lwd=3,col='darkred')
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)

```

#### Non-linear effects for ECA and CPD

To explore if there were any signs of strong non-linear patterns in how ECA affects forestry we implemented an approach equivalent to a Generalized Additive Model (GAM). We use a matrix of B-splines with 6 knots that subdivide the predictor (ECA/CPD), the resulting estimated effect of ECA at any given point is the sum of these smoothed functions. The global function of ECA effects on productivity fit to all rivers/CUs is: 

```{r, chm gam bh}
fit_bh_chm_eca_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_eca_gam.RDS'))
fit_bh_chm_cpd_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_cpd_gam.RDS'))

d=fit_bh_chm_eca_gam$draws(variables='RS_pred_ECA',format='draws_matrix')
plot(apply(d,2,median)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),xlab='ECA',ylab='Marginal effect on productivity',type='l',lwd=3,bty='l',ylim=c(-1.5,-0.2))
lines(apply(d,2,quantile,0.025)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)
lines(apply(d,2,quantile,0.975)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)

```


#### Watershed area as a mediator

Posterior estimates of the interaction between watershed area and the effect of ECA (median in red):

```{r, areaxeca chm}
f3bh_chm_eca=readRDS(here('stan models','outs','fits','fit3bh_chm_eca.RDS'))

d3chm=f3bh_chm_eca$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

Posterior estimates of the interaction between watershed area and the effect of CPD (median in red):

```{r, areaxcpd chm}
f3bh_chm_cpd=readRDS(here('stan models','outs','fits','fit3bh_chm_cpd.RDS'))

d3chm=f3bh_chm_cpd$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

### Ricker

Here are the results for the alternative Ricker model forms.

#### CU-level varying effects for ECA and CPD

```{r, cum model fits,echo=FALSE}
f1bh_chm_eca= readRDS(here('stan models','outs','fits','fit1bh_chm_eca.RDS'))
f1bh_chm_cpd= readRDS(here('stan models','outs','fits','fit1bh_chm_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit are outputted below. The plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, chm fitset 1 bh}
d1eca=f1bh_chm_eca$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d1eca[,1],bw=0.02)
for(j in 2:ncol(d1eca)){
d=density(d1eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

d1cpd=f1bh_chm_cpd$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d1cpd[,1],bw=0.02)
for(j in 2:ncol(d1cpd)){
d=density(d1cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d1eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='n',type='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 2:ncol(d1eca)){
  ps=d1eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)
lines(m_pred~eca_n,lwd=3,col='darkred')

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d1cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~cpd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 2:ncol(d1cpd)){
  ps=d1cpd[,j]%*%x_n
  lines(apply(ps,2,median)~pcd_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~cpd_n,lty=5)
lines(u_pred~pcd_n,lty=5)
lines(m_pred~cpd_n,lwd=3,col='darkred')

```


#### River-level varying effects of ECA and CPD

```{r, cum model fits,echo=FALSE}
f2bh_chm_eca= readRDS(here('stan models','outs','fits','fit2bh_chm_eca.RDS'))
f2bh_chm_cpd= readRDS(here('stan models','outs','fits','fit2bh_chm_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit.

This plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, chm fitset 2 bh}
d2eca=f2bh_chm_eca$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')
d2cpd=f2bh_chm_cpd$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d2_eca[,1],bw=0.02)
for(j in 2:ncol(d2_eca)){ #22 cus
d=density(d2_eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d2_cpd[,1],bw=0.02)
for(j in 2:ncol(d2_cpd)){ #22 cus
d=density(d2_cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d2eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),type='n')
for(j in 2:ncol(d2eca)){
  ps=d2eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~eca_n,lwd=3,col='darkred')
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d2cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~pcd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2))
for(j in 2:ncol(d2cpd)){
  ps=d2cpd[,j]%*%x_n
  lines(apply(ps,2,median)~pcd_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~cpd_n,lwd=3,col='darkred')
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)

```

#### Non-linear effects for ECA and CPD

To explore if there were any signs of strong non-linear patterns in how ECA affects forestry we implemented an approach equivalent to a Generalized Additive Model (GAM). We use a matrix of B-splines with 6 knots that subdivide the predictor (ECA/CPD), the resulting estimated effect of ECA at any given point is the sum of these smoothed functions. The global function of ECA effects on productivity fit to all rivers/CUs is: 

```{r, chm gam bh}
fit_bh_chm_eca_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_eca_gam.RDS'))
fit_bh_chm_cpd_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_cpd_gam.RDS'))

d=fit_bh_chm_eca_gam$draws(variables='RS_pred_ECA',format='draws_matrix')
plot(apply(d,2,median)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),xlab='ECA',ylab='Marginal effect on productivity',type='l',lwd=3,bty='l',ylim=c(-1.5,-0.2))
lines(apply(d,2,quantile,0.025)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)
lines(apply(d,2,quantile,0.975)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)

```


#### Watershed area as a mediator

Posterior estimates of the interaction between watershed area and the effect of ECA (median in red):

```{r, areaxeca chm}
f3bh_chm_eca=readRDS(here('stan models','outs','fits','fit3bh_chm_eca.RDS'))

d3chm=f3bh_chm_eca$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

Posterior estimates of the interaction between watershed area and the effect of CPD (median in red):

```{r, areaxcpd chm}
f3bh_chm_cpd=readRDS(here('stan models','outs','fits','fit3bh_chm_cpd.RDS'))

d3chm=f3bh_chm_cpd$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```


## Pink - Even broodlines

### Beverton-Holt

The Beverton-Holt model formulation had the highest support amongst the considered density-dependence model forms for Chum.

#### CU-level varying effects for ECA and CPD

```{r, cum model fits,echo=FALSE}
f1bh_pke_eca= readRDS(here('stan models','outs','fits','fit1bh_pke_eca.RDS'))
f1bh_pke_cpd= readRDS(here('stan models','outs','fits','fit1bh_pke_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit are outputted below. The plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, chm fitset 1 bh}
d1eca=f1bh_pke_eca$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-1,1),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d1eca[,1],bw=0.02)
for(j in 2:ncol(d1eca)){
d=density(d1eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

d1cpd=f1bh_pke_cpd$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

plot(c(0,10)~c(-1,1),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d1cpd[,1],bw=0.02)
for(j in 2:ncol(d1cpd)){
d=density(d1cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d1eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='n',type='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-1,1),col='darkred',lwd=3)
for(j in 2:ncol(d1eca)){
  ps=d1eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)
lines(m_pred~eca_n,lwd=3,col='darkred')

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d1cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~cpd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-1,1),col='darkred',lwd=3)
for(j in 2:ncol(d1cpd)){
  ps=d1cpd[,j]%*%x_n
  lines(apply(ps,2,median)~cpd_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)
lines(m_pred~cpd_n,lwd=3,col='darkred')

```


#### River-level varying effects of ECA and CPD

```{r, cum model fits,echo=FALSE}
f2bh_chm_eca= readRDS(here('stan models','outs','fits','fit2bh_chm_eca.RDS'))
f2bh_chm_cpd= readRDS(here('stan models','outs','fits','fit2bh_chm_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit.

This plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, chm fitset 2 bh}
d2eca=f2bh_chm_eca$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')
d2cpd=f2bh_chm_cpd$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d2_eca[,1],bw=0.02)
for(j in 2:ncol(d2_eca)){ #22 cus
d=density(d2_eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d2_cpd[,1],bw=0.02)
for(j in 2:ncol(d2_cpd)){ #22 cus
d=density(d2_cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d2eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),type='n')
for(j in 2:ncol(d2eca)){
  ps=d2eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~eca_n,lwd=3,col='darkred')
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d2cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~pcd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2))
for(j in 2:ncol(d2cpd)){
  ps=d2cpd[,j]%*%x_n
  lines(apply(ps,2,median)~pcd_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~cpd_n,lwd=3,col='darkred')
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)

```

#### Non-linear effects for ECA and CPD

To explore if there were any signs of strong non-linear patterns in how ECA affects forestry we implemented an approach equivalent to a Generalized Additive Model (GAM). We use a matrix of B-splines with 6 knots that subdivide the predictor (ECA/CPD), the resulting estimated effect of ECA at any given point is the sum of these smoothed functions. The global function of ECA effects on productivity fit to all rivers/CUs is: 

```{r, chm gam bh}
fit_bh_chm_eca_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_eca_gam.RDS'))
fit_bh_chm_cpd_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_cpd_gam.RDS'))

d=fit_bh_chm_eca_gam$draws(variables='RS_pred_ECA',format='draws_matrix')
plot(apply(d,2,median)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),xlab='ECA',ylab='Marginal effect on productivity',type='l',lwd=3,bty='l',ylim=c(-1.5,-0.2))
lines(apply(d,2,quantile,0.025)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)
lines(apply(d,2,quantile,0.975)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)

```


#### Watershed area as a mediator

Posterior estimates of the interaction between watershed area and the effect of ECA (median in red):

```{r, areaxeca chm}
f3bh_chm_eca=readRDS(here('stan models','outs','fits','fit3bh_chm_eca.RDS'))

d3chm=f3bh_chm_eca$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

Posterior estimates of the interaction between watershed area and the effect of CPD (median in red):

```{r, areaxcpd chm}
f3bh_chm_cpd=readRDS(here('stan models','outs','fits','fit3bh_chm_cpd.RDS'))

d3chm=f3bh_chm_cpd$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

### Ricker

Here are the results for the alternative Ricker model forms.

#### CU-level varying effects for ECA and CPD

```{r, cum model fits,echo=FALSE}
f1bh_chm_eca= readRDS(here('stan models','outs','fits','fit1bh_chm_eca.RDS'))
f1bh_chm_cpd= readRDS(here('stan models','outs','fits','fit1bh_chm_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit are outputted below. The plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, chm fitset 1 bh}
d1eca=f1bh_chm_eca$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d1eca[,1],bw=0.02)
for(j in 2:ncol(d1eca)){
d=density(d1eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

d1cpd=f1bh_chm_cpd$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d1cpd[,1],bw=0.02)
for(j in 2:ncol(d1cpd)){
d=density(d1cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d1eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='n',type='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 2:ncol(d1eca)){
  ps=d1eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)
lines(m_pred~eca_n,lwd=3,col='darkred')

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d1cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~cpd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 2:ncol(d1cpd)){
  ps=d1cpd[,j]%*%x_n
  lines(apply(ps,2,median)~pcd_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~cpd_n,lty=5)
lines(u_pred~pcd_n,lty=5)
lines(m_pred~cpd_n,lwd=3,col='darkred')

```


#### River-level varying effects of ECA and CPD

```{r, cum model fits,echo=FALSE}
f2bh_chm_eca= readRDS(here('stan models','outs','fits','fit2bh_chm_eca.RDS'))
f2bh_chm_cpd= readRDS(here('stan models','outs','fits','fit2bh_chm_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit.

This plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, chm fitset 2 bh}
d2eca=f2bh_chm_eca$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')
d2cpd=f2bh_chm_cpd$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d2_eca[,1],bw=0.02)
for(j in 2:ncol(d2_eca)){ #22 cus
d=density(d2_eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d2_cpd[,1],bw=0.02)
for(j in 2:ncol(d2_cpd)){ #22 cus
d=density(d2_cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d2eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),type='n')
for(j in 2:ncol(d2eca)){
  ps=d2eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~eca_n,lwd=3,col='darkred')
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d2cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~pcd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2))
for(j in 2:ncol(d2cpd)){
  ps=d2cpd[,j]%*%x_n
  lines(apply(ps,2,median)~pcd_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~cpd_n,lwd=3,col='darkred')
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)

```

#### Non-linear effects for ECA and CPD

To explore if there were any signs of strong non-linear patterns in how ECA affects forestry we implemented an approach equivalent to a Generalized Additive Model (GAM). We use a matrix of B-splines with 6 knots that subdivide the predictor (ECA/CPD), the resulting estimated effect of ECA at any given point is the sum of these smoothed functions. The global function of ECA effects on productivity fit to all rivers/CUs is: 

```{r, chm gam bh}
fit_bh_chm_eca_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_eca_gam.RDS'))
fit_bh_chm_cpd_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_cpd_gam.RDS'))

d=fit_bh_chm_eca_gam$draws(variables='RS_pred_ECA',format='draws_matrix')
plot(apply(d,2,median)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),xlab='ECA',ylab='Marginal effect on productivity',type='l',lwd=3,bty='l',ylim=c(-1.5,-0.2))
lines(apply(d,2,quantile,0.025)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)
lines(apply(d,2,quantile,0.975)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)

```


#### Watershed area as a mediator

Posterior estimates of the interaction between watershed area and the effect of ECA (median in red):

```{r, areaxeca chm}
f3bh_chm_eca=readRDS(here('stan models','outs','fits','fit3bh_chm_eca.RDS'))

d3chm=f3bh_chm_eca$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

Posterior estimates of the interaction between watershed area and the effect of CPD (median in red):

```{r, areaxcpd chm}
f3bh_chm_cpd=readRDS(here('stan models','outs','fits','fit3bh_chm_cpd.RDS'))

d3chm=f3bh_chm_cpd$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```


## Pink - Even broodlines

### Beverton-Holt

The Beverton-Holt model formulation had the highest support amongst the considered density-dependence model forms for Chum.

#### CU-level varying effects for ECA and CPD

```{r, cum model fits,echo=FALSE}
f1bh_pke_eca= readRDS(here('stan models','outs','fits','fit1bh_pke_eca.RDS'))
f1bh_pke_cpd= readRDS(here('stan models','outs','fits','fit1bh_pke_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit are outputted below. The plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, chm fitset 1 bh}
d1eca=f1bh_pke_eca$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-1,1),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d1eca[,1],bw=0.02)
for(j in 2:ncol(d1eca)){
d=density(d1eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

d1cpd=f1bh_pke_cpd$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

plot(c(0,10)~c(-1,1),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d1cpd[,1],bw=0.02)
for(j in 2:ncol(d1cpd)){
d=density(d1cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d1eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='n',type='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-1,1),col='darkred',lwd=3)
for(j in 2:ncol(d1eca)){
  ps=d1eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)
lines(m_pred~eca_n,lwd=3,col='darkred')

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d1cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~cpd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-1,1),col='darkred',lwd=3)
for(j in 2:ncol(d1cpd)){
  ps=d1cpd[,j]%*%x_n
  lines(apply(ps,2,median)~cpd_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)
lines(m_pred~cpd_n,lwd=3,col='darkred')

```


#### River-level varying effects of ECA and CPD

```{r, cum model fits,echo=FALSE}
f2bh_chm_eca= readRDS(here('stan models','outs','fits','fit2bh_chm_eca.RDS'))
f2bh_chm_cpd= readRDS(here('stan models','outs','fits','fit2bh_chm_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit.

This plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, chm fitset 2 bh}
d2eca=f2bh_chm_eca$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')
d2cpd=f2bh_chm_cpd$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d2_eca[,1],bw=0.02)
for(j in 2:ncol(d2_eca)){ #22 cus
d=density(d2_eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d2_cpd[,1],bw=0.02)
for(j in 2:ncol(d2_cpd)){ #22 cus
d=density(d2_cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d2eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),type='n')
for(j in 2:ncol(d2eca)){
  ps=d2eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~eca_n,lwd=3,col='darkred')
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d2cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~pcd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2))
for(j in 2:ncol(d2cpd)){
  ps=d2cpd[,j]%*%x_n
  lines(apply(ps,2,median)~pcd_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~cpd_n,lwd=3,col='darkred')
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)

```

#### Non-linear effects for ECA and CPD

To explore if there were any signs of strong non-linear patterns in how ECA affects forestry we implemented an approach equivalent to a Generalized Additive Model (GAM). We use a matrix of B-splines with 6 knots that subdivide the predictor (ECA/CPD), the resulting estimated effect of ECA at any given point is the sum of these smoothed functions. The global function of ECA effects on productivity fit to all rivers/CUs is: 

```{r, chm gam bh}
fit_bh_chm_eca_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_eca_gam.RDS'))
fit_bh_chm_cpd_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_cpd_gam.RDS'))

d=fit_bh_chm_eca_gam$draws(variables='RS_pred_ECA',format='draws_matrix')
plot(apply(d,2,median)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),xlab='ECA',ylab='Marginal effect on productivity',type='l',lwd=3,bty='l',ylim=c(-1.5,-0.2))
lines(apply(d,2,quantile,0.025)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)
lines(apply(d,2,quantile,0.975)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)

```


#### Watershed area as a mediator

Posterior estimates of the interaction between watershed area and the effect of ECA (median in red):

```{r, areaxeca chm}
f3bh_chm_eca=readRDS(here('stan models','outs','fits','fit3bh_chm_eca.RDS'))

d3chm=f3bh_chm_eca$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

Posterior estimates of the interaction between watershed area and the effect of CPD (median in red):

```{r, areaxcpd chm}
f3bh_chm_cpd=readRDS(here('stan models','outs','fits','fit3bh_chm_cpd.RDS'))

d3chm=f3bh_chm_cpd$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

### Ricker

Here are the results for the alternative Ricker model forms.

#### CU-level varying effects for ECA and CPD

```{r, cum model fits,echo=FALSE}
f1bh_chm_eca= readRDS(here('stan models','outs','fits','fit1bh_chm_eca.RDS'))
f1bh_chm_cpd= readRDS(here('stan models','outs','fits','fit1bh_chm_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit are outputted below. The plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, chm fitset 1 bh}
d1eca=f1bh_chm_eca$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d1eca[,1],bw=0.02)
for(j in 2:ncol(d1eca)){
d=density(d1eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

d1cpd=f1bh_chm_cpd$draws(variables=c('b_ECA','b_ECA_cu'),format='draws_matrix')

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d1cpd[,1],bw=0.02)
for(j in 2:ncol(d1cpd)){
d=density(d1cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d1eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='n',type='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 2:ncol(d1eca)){
  ps=d1eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)
lines(m_pred~eca_n,lwd=3,col='darkred')

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d1cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~cpd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 2:ncol(d1cpd)){
  ps=d1cpd[,j]%*%x_n
  lines(apply(ps,2,median)~pcd_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~cpd_n,lty=5)
lines(u_pred~pcd_n,lty=5)
lines(m_pred~cpd_n,lwd=3,col='darkred')

```


#### River-level varying effects of ECA and CPD

```{r, cum model fits,echo=FALSE}
f2bh_chm_eca= readRDS(here('stan models','outs','fits','fit2bh_chm_eca.RDS'))
f2bh_chm_cpd= readRDS(here('stan models','outs','fits','fit2bh_chm_cpd.RDS'))
```

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit.

This plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, chm fitset 2 bh}
d2eca=f2bh_chm_eca$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')
d2cpd=f2bh_chm_cpd$draws(variables=c('b_ECA','b_ECA_j'),format='draws_matrix')

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d2_eca[,1],bw=0.02)
for(j in 2:ncol(d2_eca)){ #22 cus
d=density(d2_eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d2_cpd[,1],bw=0.02)
for(j in 2:ncol(d2_cpd)){ #22 cus
d=density(d2_cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(ch20r$logit.ECA.std),max(ch20r$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(ch20r$logit.ECA)+mean(ch20r$logit.ECA))

pRS=d2eca[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),type='n')
for(j in 2:ncol(d2eca)){
  ps=d2eca[,j]%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~eca_n,lwd=3,col='darkred')
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)

x_n=seq(min(ch20r$logit.pdisturb.std),max(ch20r$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(ch20r$logit.pdisturb)+mean(ch20r$logit.pdisturb))*100

pRS=d2cpd[,1]%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~pcd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2))
for(j in 2:ncol(d2cpd)){
  ps=d2cpd[,j]%*%x_n
  lines(apply(ps,2,median)~pcd_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~cpd_n,lwd=3,col='darkred')
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)

```

#### Non-linear effects for ECA and CPD

To explore if there were any signs of strong non-linear patterns in how ECA affects forestry we implemented an approach equivalent to a Generalized Additive Model (GAM). We use a matrix of B-splines with 6 knots that subdivide the predictor (ECA/CPD), the resulting estimated effect of ECA at any given point is the sum of these smoothed functions. The global function of ECA effects on productivity fit to all rivers/CUs is: 

```{r, chm gam bh}
fit_bh_chm_eca_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_eca_gam.RDS'))
fit_bh_chm_cpd_gam= readRDS(here('stan models','outs','fits','fit_bh_chm_cpd_gam.RDS'))

d=fit_bh_chm_eca_gam$draws(variables='RS_pred_ECA',format='draws_matrix')
plot(apply(d,2,median)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),xlab='ECA',ylab='Marginal effect on productivity',type='l',lwd=3,bty='l',ylim=c(-1.5,-0.2))
lines(apply(d,2,quantile,0.025)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)
lines(apply(d,2,quantile,0.975)~seq(min(ch20r$ECA_age_proxy_forested_only),max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)

```


#### Watershed area as a mediator

Posterior estimates of the interaction between watershed area and the effect of ECA (median in red):

```{r, areaxeca chm}
f3bh_chm_eca=readRDS(here('stan models','outs','fits','fit3bh_chm_eca.RDS'))

d3chm=f3bh_chm_eca$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

Posterior estimates of the interaction between watershed area and the effect of CPD (median in red):

```{r, areaxcpd chm}
f3bh_chm_cpd=readRDS(here('stan models','outs','fits','fit3bh_chm_cpd.RDS'))

d3chm=f3bh_chm_cpd$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```


# River-level Spawner-Recruit fits
Here is each river-level stock-recruitment curve in both Beverton-Holt and Ricker forms. The observations are shaded according to their ECA level (brown = higher ECA, green = lower ECA; scaled to each S-R series). The median expected recruits and their 90% credible intervals are displayed as black solid and dashed lines. The expected recruits at minimum and maximum observed ECA values for that river are shown in brown and green lines, respectively. The time-series for ECA (bottom-left) is shown with the realized effect on productivity under each model (Ricker = orange; BH = blue; bottom-right).


## Chum

### Beverton-Holt

```{r, sr time-series, fig.width=12,fig.height=8, results="asis"}
ch20r$cuid=as.numeric(factor(ch20r$CU))

dbh1_chm_eca=f1bh_chm_eca$draws(variables=c('alpha_j','Rk','b_ECA_cu'),form='draws_matrix')
dbh1_chm_cpd=f1bh_chm_cpd$draws(variables=c('alpha_j','Rk','b_ECA_cu'),form='draws_matrix')

for(c in 1:length(unique(ch20r$River))){
  cat('\n')  
  cat("## ", levels(factor(ch20r$River))[c], "\n")
  #CU header
  rv=subset(ch20r,River==levels(factor(ch20r$River))[c])
   cols= rev(RColorBrewer::brewer.pal(9,'BrBG'));
   br=quantile(rv$ECA_age_proxy_forested_only,probs=seq(0,1,length.out=8))
   col_points=adjustcolor(cols[findInterval(rv$ECA_age_proxy_forested_only,br)],alpha.f=0.8)
   
  par(mfrow=c(2,2))
  
  #ECA
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(ECA)',sep=' '))
  
  alpha_j=dbh1_chm_eca[,colnames(dbh1_chm_eca) %in% paste('alpha_j[',c,']',sep='')]
  Rk_j=dbh1_chm_eca[,colnames(dbh1_chm_eca) %in% paste('Rk[',c,']',sep='')]
  b_ECA=dbh1_chm_eca[,colnames(dbh1_chm_eca) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*min(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*max(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points,pch=21,cex=1.5) 
  
  #CPD
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(CPD)',sep=' '))
  
  alpha_j=dbh1_chm_cpd[,colnames(dbh1_chm_cpd) %in% paste('alpha_j[',c,']',sep='')]
  Rk_j=dbh1_chm_cpd[,colnames(dbh1_chm_cpd) %in% paste('Rk[',c,']',sep='')]
  b_ECA=dbh1_chm_cpd[,colnames(dbh1_chm_cpd) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*min(rv$logit.pdisturb.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*max(rv$logit.pdisturb.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points,pch=21,cex=1.5) 
  
  
   plot(rv$ECA_age_proxy_forested_only~rv$BroodYear,bty='l',type='n',xlab='Brood Year',ylab='Forest loss metric',ylim=c(0,1))
   lines(ECA_age_proxy_forested_only~BroodYear,data=rv,col='navy',lwd=2)
    points(ECA_age_proxy_forested_only~BroodYear,data=rv,bg=col_points,pch=21,cex=1.5,col='navy') 
   lines(rv$disturbedarea_prct_cs/100~BroodYear,data=rv,col='tan2',lwd=2)
    points(rv$disturbedarea_prct_cs/100~BroodYear,data=rv,bg=col_points,pch=21,cex=1.5,col='tan2')
    text(x=par('usr')[2]-4,y=par('usr')[4]*0.95,'ECA',col='navy')
    text(x=par('usr')[2]-4,y=par('usr')[4]*0.88,'CPD',col='tan2')
  
  realized_eca=dbh1_chm_eca[,colnames(dbh1_chm_eca) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
 realized_eca_m=apply(realized_eca,2,median)
  
   realized_cpd=dbh1_chm_cpd[,colnames(dbh1_chm_cpd) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
 realized_cpd_m=apply(realized_cpd,2,median)
    
   plot(realized_eca_m~rv$BroodYear,bty='l',type='n',ylim=c(min(c(realized_eca_m,realized_cpd_m)),max(c(realized_eca_m,realized_cpd_m))*1.1),ylab='Marginal effect on productivity through time',xlab='Brood Year')
   lines(realized_eca_m~BroodYear,data=rv,col='navy',lwd=2)
    points(realized_eca_m~BroodYear,data=rv,bg='navy',pch=21,cex=1.5) 
  
   lines(realized_cpd_m~BroodYear,data=rv,col='tan2',lwd=2)
    points(realized_cpd_m~BroodYear,data=rv,bg='tan2',pch=21,cex=1.5) 
   
    
    text(x=par('usr')[2]-5,y=realized_eca_m[length(realized_eca_m)]+(par('usr')[4]-par('usr')[3])*0.03,'ECA',col='navy')
    text(x=par('usr')[2]-5,y=realized_cpd_m[length(realized_cpd_m)]+(par('usr')[4]-par('usr')[3])*0.03,'CPD',col='tan2')

   cat('\n')  
}
```

### Ricker

```{r, sr time-series, fig.width=12,fig.height=8, results="asis"}
ch20r$cuid=as.numeric(factor(ch20r$CU))

d_ric1_chm=f1ric_chm_eca$draws(variables=c('alpha_j','Smax','b_ECA_cu'),form='draws_matrix')

for(c in 1:length(unique(ch20r$River))){
  cat('\n')  
  cat("## ", levels(factor(ch20r$River))[c], "\n")
  #CU header
  rv=subset(ch20r,River==levels(factor(ch20r$River))[c])
   cols= rev(RColorBrewer::brewer.pal(9,'BrBG'));
   br=quantile(rv$ECA_age_proxy_forested_only,probs=seq(0,1,length.out=8))
   col_points=adjustcolor(cols[findInterval(rv$ECA_age_proxy_forested_only,br)],alpha.f=0.8)
   
  
  par(mfrow=c(2,2))
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(BH)',sep=' '))
  
  alpha_j=d_bh1[,colnames(d_bh1) %in% paste('alpha_j[',c,']',sep='')]
  Rk_j=d_bh1[,colnames(d_bh1) %in% paste('Rk[',c,']',sep='')]
  b_ECA=d_bh1[,colnames(d_bh1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*min(rv$log),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*max(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points,pch=21,cex=1.5) 
  
  #Ricker
    plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(Ricker)',sep=' '))
  
  alpha_j=d_ric1[,colnames(d_ric1) %in% paste('alpha_j[',c,']',sep='')]
  Smax=d_ric1[,colnames(d_ric1) %in% paste('Smax[',c,']',sep='')]
  b_ECA=d_ric1[,colnames(d_ric1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred+matrix(b_ECA*min(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred+matrix(b_ECA*max(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col='darkgreen',lwd=3)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points,pch=21,cex=1.5) 
  
   plot(rv$ECA_age_proxy_forested_only~rv$BroodYear,bty='l',type='n',xlab='Brood Year',ylab='ECA')
   lines(ECA_age_proxy_forested_only~BroodYear,data=rv)
    points(ECA_age_proxy_forested_only~BroodYear,data=rv,bg=col_points,pch=21,cex=1.5) 
  
  bh_effect=d_bh1[,colnames(d_bh1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
  bh_effect_m=apply(bh_effect,2,median)
  
  
  ric_effect=d_ric1[,colnames(d_ric1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
  ric_effect_m=apply(ric_effect,2,median)
    
   plot(ric_effect_m~rv$BroodYear,bty='l',type='n',ylim=c(min(c(bh_effect_m,ric_effect_m)),max(c(bh_effect_m,ric_effect_m))),ylab='Marginal effect on productivity through time',xlab='Brood Year')
   lines(bh_effect_m~BroodYear,data=rv,col='navy',lwd=2)
    points(bh_effect_m~BroodYear,data=rv,bg='navy',pch=21,cex=1.5) 
  
    lines(ric_effect_m~BroodYear,data=rv,col='tan2',lwd=2)
    points(ric_effect_m~BroodYear,data=rv,bg='tan2',pch=21,cex=1.5) 
    text(x=par('usr')[2]-5,y=bh_effect_m[length(bh_effect_m)]*1.05,'Beverton-Holt',col='navy')
    text(x=par('usr')[2]-5,y=ric_effect_m[length(ric_effect_m)]*1.05,'Ricker',col='tan2')

   cat('\n')  
}
```

## Pink Even - ECA
```{r, sr time-series, fig.width=12,fig.height=8, results="asis"}
ch20r$cuid=as.numeric(factor(ch20r$CU))

d_bh1=f1bh$draws(variables=c('alpha_j','Rk','b_ECA_cu'),form='draws_matrix')
d_ric1=f1ric$draws(variables=c('alpha_j','Smax','b_ECA_cu'),form='draws_matrix')

for(c in 1:length(unique(ch20r$River))){
  cat('\n')  
  cat("## ", levels(factor(ch20r$River))[c], "\n")
  #CU header
  rv=subset(ch20r,River==levels(factor(ch20r$River))[c])
   cols= rev(RColorBrewer::brewer.pal(9,'BrBG'));
   br=quantile(rv$ECA_age_proxy_forested_only,probs=seq(0,1,length.out=8))
   col_points=adjustcolor(cols[findInterval(rv$ECA_age_proxy_forested_only,br)],alpha.f=0.8)
   
  
  par(mfrow=c(2,2))
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(BH)',sep=' '))
  
  alpha_j=d_bh1[,colnames(d_bh1) %in% paste('alpha_j[',c,']',sep='')]
  Rk_j=d_bh1[,colnames(d_bh1) %in% paste('Rk[',c,']',sep='')]
  b_ECA=d_bh1[,colnames(d_bh1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*min(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*max(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points,pch=21,cex=1.5) 
  
  #Ricker
    plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(Ricker)',sep=' '))
  
  alpha_j=d_ric1[,colnames(d_ric1) %in% paste('alpha_j[',c,']',sep='')]
  Smax=d_ric1[,colnames(d_ric1) %in% paste('Smax[',c,']',sep='')]
  b_ECA=d_ric1[,colnames(d_ric1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred+matrix(b_ECA*min(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred+matrix(b_ECA*max(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col='darkgreen',lwd=3)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points,pch=21,cex=1.5) 
  
   plot(rv$ECA_age_proxy_forested_only~rv$BroodYear,bty='l',type='n',xlab='Brood Year',ylab='ECA')
   lines(ECA_age_proxy_forested_only~BroodYear,data=rv)
    points(ECA_age_proxy_forested_only~BroodYear,data=rv,bg=col_points,pch=21,cex=1.5) 
  
  bh_effect=d_bh1[,colnames(d_bh1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
  bh_effect_m=apply(bh_effect,2,median)
  
  
  ric_effect=d_ric1[,colnames(d_ric1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
  ric_effect_m=apply(ric_effect,2,median)
    
   plot(ric_effect_m~rv$BroodYear,bty='l',type='n',ylim=c(min(c(bh_effect_m,ric_effect_m)),max(c(bh_effect_m,ric_effect_m))),ylab='Marginal effect on productivity through time',xlab='Brood Year')
   lines(bh_effect_m~BroodYear,data=rv,col='navy',lwd=2)
    points(bh_effect_m~BroodYear,data=rv,bg='navy',pch=21,cex=1.5) 
  
    lines(ric_effect_m~BroodYear,data=rv,col='tan2',lwd=2)
    points(ric_effect_m~BroodYear,data=rv,bg='tan2',pch=21,cex=1.5) 
    text(x=par('usr')[2]-5,y=bh_effect_m[length(bh_effect_m)]*1.05,'Beverton-Holt',col='navy')
    text(x=par('usr')[2]-5,y=ric_effect_m[length(ric_effect_m)]*1.05,'Ricker',col='tan2')

   cat('\n')  
}
```

## Pink Even - Cumulative % Disturbed

```{r, sr time-series, fig.width=12,fig.height=8, results="asis"}
ch20r$cuid=as.numeric(factor(ch20r$CU))

d_bh1=f1bh_cpd$draws(variables=c('alpha_j','Rk','b_ECA_cu'),form='draws_matrix')
d_ric1=f1ric_cpd$draws(variables=c('alpha_j','Smax','b_ECA_cu'),form='draws_matrix')

for(c in 1:length(unique(ch20r$River))){
  cat('\n')  
  cat("## ", levels(factor(ch20r$River))[c], "\n")
  #CU header
  rv=subset(ch20r,River==levels(factor(ch20r$River))[c])
   cols= rev(RColorBrewer::brewer.pal(9,'BrBG'));
   br=quantile(rv$ECA_age_proxy_forested_only,probs=seq(0,1,length.out=8))
   col_points=adjustcolor(cols[findInterval(rv$ECA_age_proxy_forested_only,br)],alpha.f=0.8)
   
  
  par(mfrow=c(2,2))
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(BH)',sep=' '))
  
  alpha_j=d_bh1[,colnames(d_bh1) %in% paste('alpha_j[',c,']',sep='')]
  Rk_j=d_bh1[,colnames(d_bh1) %in% paste('Rk[',c,']',sep='')]
  b_ECA=d_bh1[,colnames(d_bh1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*min(rv$log),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*max(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points,pch=21,cex=1.5) 
  
  #Ricker
    plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(Ricker)',sep=' '))
  
  alpha_j=d_ric1[,colnames(d_ric1) %in% paste('alpha_j[',c,']',sep='')]
  Smax=d_ric1[,colnames(d_ric1) %in% paste('Smax[',c,']',sep='')]
  b_ECA=d_ric1[,colnames(d_ric1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred+matrix(b_ECA*min(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred+matrix(b_ECA*max(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col='darkgreen',lwd=3)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points,pch=21,cex=1.5) 
  
   plot(rv$ECA_age_proxy_forested_only~rv$BroodYear,bty='l',type='n',xlab='Brood Year',ylab='ECA')
   lines(ECA_age_proxy_forested_only~BroodYear,data=rv)
    points(ECA_age_proxy_forested_only~BroodYear,data=rv,bg=col_points,pch=21,cex=1.5) 
  
  bh_effect=d_bh1[,colnames(d_bh1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
  bh_effect_m=apply(bh_effect,2,median)
  
  
  ric_effect=d_ric1[,colnames(d_ric1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
  ric_effect_m=apply(ric_effect,2,median)
    
   plot(ric_effect_m~rv$BroodYear,bty='l',type='n',ylim=c(min(c(bh_effect_m,ric_effect_m)),max(c(bh_effect_m,ric_effect_m))),ylab='Marginal effect on productivity through time',xlab='Brood Year')
   lines(bh_effect_m~BroodYear,data=rv,col='navy',lwd=2)
    points(bh_effect_m~BroodYear,data=rv,bg='navy',pch=21,cex=1.5) 
  
    lines(ric_effect_m~BroodYear,data=rv,col='tan2',lwd=2)
    points(ric_effect_m~BroodYear,data=rv,bg='tan2',pch=21,cex=1.5) 
    text(x=par('usr')[2]-5,y=bh_effect_m[length(bh_effect_m)]*1.05,'Beverton-Holt',col='navy')
    text(x=par('usr')[2]-5,y=ric_effect_m[length(ric_effect_m)]*1.05,'Ricker',col='tan2')

   cat('\n')  
}
```

## Pink Odd - ECA
```{r, sr time-series, fig.width=12,fig.height=8, results="asis"}
ch20r$cuid=as.numeric(factor(ch20r$CU))

d_bh1=f1bh$draws(variables=c('alpha_j','Rk','b_ECA_cu'),form='draws_matrix')
d_ric1=f1ric$draws(variables=c('alpha_j','Smax','b_ECA_cu'),form='draws_matrix')

for(c in 1:length(unique(ch20r$River))){
  cat('\n')  
  cat("## ", levels(factor(ch20r$River))[c], "\n")
  #CU header
  rv=subset(ch20r,River==levels(factor(ch20r$River))[c])
   cols= rev(RColorBrewer::brewer.pal(9,'BrBG'));
   br=quantile(rv$ECA_age_proxy_forested_only,probs=seq(0,1,length.out=8))
   col_points=adjustcolor(cols[findInterval(rv$ECA_age_proxy_forested_only,br)],alpha.f=0.8)
   
  
  par(mfrow=c(2,2))
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(BH)',sep=' '))
  
  alpha_j=d_bh1[,colnames(d_bh1) %in% paste('alpha_j[',c,']',sep='')]
  Rk_j=d_bh1[,colnames(d_bh1) %in% paste('Rk[',c,']',sep='')]
  b_ECA=d_bh1[,colnames(d_bh1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*min(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*max(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points,pch=21,cex=1.5) 
  
  #Ricker
    plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(Ricker)',sep=' '))
  
  alpha_j=d_ric1[,colnames(d_ric1) %in% paste('alpha_j[',c,']',sep='')]
  Smax=d_ric1[,colnames(d_ric1) %in% paste('Smax[',c,']',sep='')]
  b_ECA=d_ric1[,colnames(d_ric1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred+matrix(b_ECA*min(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred+matrix(b_ECA*max(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col='darkgreen',lwd=3)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points,pch=21,cex=1.5) 
  
   plot(rv$ECA_age_proxy_forested_only~rv$BroodYear,bty='l',type='n',xlab='Brood Year',ylab='ECA')
   lines(ECA_age_proxy_forested_only~BroodYear,data=rv)
    points(ECA_age_proxy_forested_only~BroodYear,data=rv,bg=col_points,pch=21,cex=1.5) 
  
  bh_effect=d_bh1[,colnames(d_bh1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
  bh_effect_m=apply(bh_effect,2,median)
  
  
  ric_effect=d_ric1[,colnames(d_ric1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
  ric_effect_m=apply(ric_effect,2,median)
    
   plot(ric_effect_m~rv$BroodYear,bty='l',type='n',ylim=c(min(c(bh_effect_m,ric_effect_m)),max(c(bh_effect_m,ric_effect_m))),ylab='Marginal effect on productivity through time',xlab='Brood Year')
   lines(bh_effect_m~BroodYear,data=rv,col='navy',lwd=2)
    points(bh_effect_m~BroodYear,data=rv,bg='navy',pch=21,cex=1.5) 
  
    lines(ric_effect_m~BroodYear,data=rv,col='tan2',lwd=2)
    points(ric_effect_m~BroodYear,data=rv,bg='tan2',pch=21,cex=1.5) 
    text(x=par('usr')[2]-5,y=bh_effect_m[length(bh_effect_m)]*1.05,'Beverton-Holt',col='navy')
    text(x=par('usr')[2]-5,y=ric_effect_m[length(ric_effect_m)]*1.05,'Ricker',col='tan2')

   cat('\n')  
}
```

## Pink Odd - Cumulative % Disturbed

```{r, sr time-series, fig.width=12,fig.height=8, results="asis"}
ch20r$cuid=as.numeric(factor(ch20r$CU))

d_bh1=f1bh_cpd$draws(variables=c('alpha_j','Rk','b_ECA_cu'),form='draws_matrix')
d_ric1=f1ric_cpd$draws(variables=c('alpha_j','Smax','b_ECA_cu'),form='draws_matrix')

for(c in 1:length(unique(ch20r$River))){
  cat('\n')  
  cat("## ", levels(factor(ch20r$River))[c], "\n")
  #CU header
  rv=subset(ch20r,River==levels(factor(ch20r$River))[c])
   cols= rev(RColorBrewer::brewer.pal(9,'BrBG'));
   br=quantile(rv$ECA_age_proxy_forested_only,probs=seq(0,1,length.out=8))
   col_points=adjustcolor(cols[findInterval(rv$ECA_age_proxy_forested_only,br)],alpha.f=0.8)
   
  
  par(mfrow=c(2,2))
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(BH)',sep=' '))
  
  alpha_j=d_bh1[,colnames(d_bh1) %in% paste('alpha_j[',c,']',sep='')]
  Rk_j=d_bh1[,colnames(d_bh1) %in% paste('Rk[',c,']',sep='')]
  b_ECA=d_bh1[,colnames(d_bh1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*min(rv$log),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-log(1+(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*max(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points,pch=21,cex=1.5) 
  
  #Ricker
    plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(Ricker)',sep=' '))
  
  alpha_j=d_ric1[,colnames(d_ric1) %in% paste('alpha_j[',c,']',sep='')]
  Smax=d_ric1[,colnames(d_ric1) %in% paste('Smax[',c,']',sep='')]
  b_ECA=d_ric1[,colnames(d_ric1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred,2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred+matrix(b_ECA*min(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=nrow(alpha_j))-(1/Smax)%*%s_pred+matrix(b_ECA*max(rv$logit.ECA.std),ncol=length(s_pred),nrow=nrow(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col='darkgreen',lwd=3)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points,pch=21,cex=1.5) 
  
   plot(rv$ECA_age_proxy_forested_only~rv$BroodYear,bty='l',type='n',xlab='Brood Year',ylab='ECA')
   lines(ECA_age_proxy_forested_only~BroodYear,data=rv)
    points(ECA_age_proxy_forested_only~BroodYear,data=rv,bg=col_points,pch=21,cex=1.5) 
  
  bh_effect=d_bh1[,colnames(d_bh1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
  bh_effect_m=apply(bh_effect,2,median)
  
  
  ric_effect=d_ric1[,colnames(d_ric1) %in% paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]%*%rv$logit.ECA.std
  ric_effect_m=apply(ric_effect,2,median)
    
   plot(ric_effect_m~rv$BroodYear,bty='l',type='n',ylim=c(min(c(bh_effect_m,ric_effect_m)),max(c(bh_effect_m,ric_effect_m))),ylab='Marginal effect on productivity through time',xlab='Brood Year')
   lines(bh_effect_m~BroodYear,data=rv,col='navy',lwd=2)
    points(bh_effect_m~BroodYear,data=rv,bg='navy',pch=21,cex=1.5) 
  
    lines(ric_effect_m~BroodYear,data=rv,col='tan2',lwd=2)
    points(ric_effect_m~BroodYear,data=rv,bg='tan2',pch=21,cex=1.5) 
    text(x=par('usr')[2]-5,y=bh_effect_m[length(bh_effect_m)]*1.05,'Beverton-Holt',col='navy')
    text(x=par('usr')[2]-5,y=ric_effect_m[length(ric_effect_m)]*1.05,'Ricker',col='tan2')

   cat('\n')  
}
```