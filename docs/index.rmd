---
title: "Coastwide analysis of forestry impacts on BC Pacific Salmon"
author: ''
date: "Apr. 2024"
output:
  html_document:
    collapsed: no
    fig_caption: yes
    highlight: espresso
    number_sections: yes
    smooth_scroll: yes
    theme: sandstone
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 13px;
  }
td {  /* Table  */
  font-size: 13px;
}
h1.title {
  font-size: 24px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 19px;
  color: Black;
}
h2 { /* Header 2 */
    font-size: 15px;
  color: Black;
}
h3 { /* Header 3 */
    font-size: 15px;
  color: Black;
}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
library(cmdstanr)
```

# Overview

This short document provides some details on initial models fit and inferential outputs. It can be treated as a living appendix of sorts, and can be added to and polished over time.

Code and data to reproduce the analyses summarized in this document can be found in [**this repository**](https://github.com/Pacific-salmon-assess/coastwide-salmon-forestry).

The first set of models we fit includes a covariate for ECA alone (logit transformed and standardized) which is modeled hierarchically down to CU-level for ECA effects and to the individual river (subscript $r$) level for productivity. We test 3 models for the structure of density dependence: either a Ricker (model 1), Beverton-Holt (model 2), or Cushing type (model 3) spawner-recruitment relationship. The stan models themselves are in the github repo as m1_ricker.stan, m1_bh.stan, m1_cush.stan.

The second set of models fit includes a finer-level of variation in stock responses to ECA - where the effect now varies at the river-level.

The third set of models fit includes an interaction of watershed area with the ECA effect - where the effect now varies according to watershed size.

# Models

## Ricker

The Ricker formulation of the model (with River-level varying effects for ECA) took the form:

$log(R_{t,r}/S_{t,r}) = \alpha_r - \beta_r*S_{t,r} + \beta_{eca,r}*ECA_{t,r} + w_{t,r}$

Where residual productivity is autocorrelated by 1-year:

$w_{1,r} \sim N(0,\sigma_r)$

$w_{t,r} \sim N(\rho_r*w_{t-1,r},\sigma_r*\sqrt(1-\rho_r^2))$

$\rho \sim U(-1,1)$

And stock-specific parameters are drawn hierarchically at the River-level for productivity and CU-level for forestry effects:

$\alpha_r \sim N(\alpha_{c}, \sigma_{ar}^2)$

$\alpha_{c} \sim N(\alpha, \sigma_{ac}^2)$

$\alpha \sim N(1.5,2)$

$\beta_{eca,r} \sim N(\beta_{eca,c}, \sigma_{eca,c})$

$\beta_{eca,c} \sim N(\beta_{eca}, \sigma_{eca})$

$\beta_{eca} \sim N(0,1)$

$\sigma_{eca} \sim N[0,0.5)$

$\sigma_r \sim N(\sigma_c,\sigma_{\sigma,r})$

$\sigma_c \sim N(\sigma,\sigma_{\sigma,c})$

$\sigma \sim N[0.5,0.5)$

Stock-specific within brood year density-dependence is estimated independently at the river level, but with informative priors for $S_{max}$ (=$1/\beta$; density where total predicted recruitment is maximized) based on observed spawner counts ($S_r$):

$\beta \sim lognormal(0.5*max(S_r),max(S_r))$

## Beverton-Holt

The Beverton Holt form of this model was linearized as:

$log(R_{t,r}/S_{t,r}) = \alpha_r - log(1+(e^{\alpha_r})/R_{k,r})*S_{t,r}) + \beta_{eca,c}*ECA_{t,r} + w_{t,r}$

Where the new parameter $R_{k,r}$ is the stock-specific equilibrium recruitment, sampled with informative priors based on observed recruitment ($R$):

$R_{k,r} \sim lognormal(0.75*max(R_r),max(R_r))$

## Cushing

For the Cushing model, the linearized form is:

$log(R_t,r/S_{t,r}) = \alpha_r + \beta_r*log(S_{t,r}) + \beta_{eca,c}*ECA_{t,r} + w_{t,r}$

A version of each model was fit to the Chum, Even-year Pink, and Odd-year Pink datasets.

```{r prep data,  include=FALSE}
library(here);library(cmdstanr);library(dplyr)

ch20r <- read.csv("../origional-ecofish-data-models/Data/Processed/chum_SR_20_hat_yr_reduced_VRI90.csv")
ch20r$cuid=as.numeric(factor(ch20r$CU))
#even year pinks
pk10r_e <- read.csv("../origional-ecofish-data-models/Data/Processed/pke_SR_10_hat_yr_reduced_VRI90.csv")
pk10r_e$cuid=as.numeric(factor(pk10r_e$CU))

#odd year pinks
pk10r_o <- read.csv("../origional-ecofish-data-models/Data/Processed/pko_SR_10_hat_yr_reduced_VRI90.csv")
pk10r_o$cuid=as.numeric(factor(pk10r_o$CU))

#two rivers named salmon river... recode
ch20r$River=ifelse(ch20r$WATERSHED_CDE=='950-169400-00000-00000-0000-0000-000-000-000-000-000-000','SALMON RIVER 2',ch20r$River)
ch20r$River=ifelse(ch20r$WATERSHED_CDE=="915-486500-05300-00000-0000-0000-000-000-000-000-000-000",'LAGOON CREEK 2',ch20r$River)
pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=='950-169400-00000-00000-0000-0000-000-000-000-000-000-000','SALMON RIVER 2',pk10r_o$River)
pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=='915-765500-18600-00000-0000-0000-000-000-000-000-000-000','HEAD CREEK 2',pk10r_o$River)
pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=='915-488000-41400-00000-0000-0000-000-000-000-000-000-000','WINDY BAY CREEK 2',pk10r_o$River)
pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=='950-169400-00000-00000-0000-0000-000-000-000-000-000-000','SALMON RIVER 2',pk10r_o$River)
pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=='915-765500-18600-00000-0000-0000-000-000-000-000-000-000','HEAD CREEK 2',pk10r_o$River)
pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=='915-488000-41400-00000-0000-0000-000-000-000-000-000-000','WINDY BAY CREEK 2',pk10r_o$River)

#
ch20r$disturbedarea_prct_cs.std=scale(ch20r$disturbedarea_prct_cs)

#normalize ECA 2 - square root transformation (ie. sqrt(x))
ch20r$sqrt.ECA=sqrt(ch20r$ECA_age_proxy_forested_only)
ch20r$sqrt.ECA.std=(ch20r$sqrt.ECA-mean(ch20r$sqrt.ECA))/sd(ch20r$sqrt.ECA)

#normalize CPD 2 - square root transformation (ie. sqrt(x))
ch20r$sqrt.CPD=sqrt(ch20r$disturbedarea_prct_cs)
ch20r$sqrt.CPD.std=(ch20r$sqrt.CPD-mean(ch20r$sqrt.CPD))/sd(ch20r$sqrt.CPD)

```


# Forestry metrics by river, CU, and watershed area

The third set of models includes watershed area as a mediator of the effect of ECA on productivity:

$log(R_{t,r}/S_{t,r}) = \alpha_r - \beta_r*S_{t,r} + \beta_{eca,c}*ECA_{t,r} + \beta_{eca-x-area,c}*ECA_{t,r}*Area_{r} + w_{t,r}$

## Chum

This is the distribution of watershed area among 295 rivers with Chum surveys:

```{r, watershed area chm}
par(mfrow=c(1,1))
da=distinct(ch20r,River,.keep_all = T)
hist(log10(da$area_km2),xlab='Watershed area (km2)',xaxt='n',main='',breaks=30,xlim=c(0,log10(1e4)))
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

#da=da[order(da$area_km2),]
```

The range of observed ECAs can vary substantially by rivers and CUs:

```{r, chm eca range}
plot(rep(1,nrow(da))~seq(1,295),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(ch20r,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}

cu=distinct(ch20r,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,22),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(ch20r,CU==cu$CU[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(ch20r,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

The same plots for the Cumulative % Disturbed metric:

```{r, chm cpd range}
plot(rep(1,nrow(da))~seq(1,295),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(ch20r,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}

cu=distinct(ch20r,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,22),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(ch20r,CU==cu$CU[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(ch20r,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

## Pink Even

This is the distribution of watershed area among 336 rivers with Pink surveys:

```{r, watershed area pke}
da=distinct(pk10r_o,River,.keep_all = T)
hist(log10(da$area_km2),xlab='Watershed area (km2)',xaxt='n',main='',breaks=30,xlim=c(0,log10(1e4)))
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

#da=da[order(da$area_km2),]
```

The range of observed ECAs can vary substantially by rivers and CUs:

```{r, pke eca range}
plot(rep(1,nrow(da))~seq(1,nrow(da)),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}

cu=distinct(pk10r_o,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,nrow(cu)),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(pk10r_o,CU==cu$CU[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

The same plots for the Cumulative % Disturbed metric:

```{r, pke cpd range}
plot(rep(1,nrow(da))~seq(1,nrow(da)),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}

cu=distinct(pk10r_o,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,nrow(cu)),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(pk10r_o,CU==cu$CU[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

## Pink Odd

This is the distribution of watershed area among 251 rivers with Pink (odd) surveys:

```{r, watershed area pko}
da=distinct(pk10r_o,River,.keep_all = T)
hist(log10(da$area_km2),xlab='Watershed area (km2)',xaxt='n',main='',breaks=30,xlim=c(0,log10(1e4)))
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

#da=da[order(da$area_km2),]
```

The range of observed ECAs can vary substantially by rivers and CUs:

```{r, pko eca range}
plot(rep(1,nrow(da))~seq(1,nrow(da)),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}

cu=distinct(pk10r_o,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,nrow(cu)),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(pk10r_o,CU==cu$CU[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

The same plots for the Cumulative % Disturbed metric:

```{r, pko cpd range}
plot(rep(1,nrow(da))~seq(1,nrow(da)),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}

cu=distinct(pk10r_o,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,nrow(cu)),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(pk10r_o,CU==cu$CU[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

\newpage

# Forestry effects by species

This section will compare the productivity responses to two measures of forestry activity in watersheds: equivalent clearcut area (ECA) and the cumulative % of disturbed watershed area (CPD).

## Chum

### CU-level varying effects for ECA and CPD

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit are outputted below. The plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, chm fitset 1 bh, fig.width=12,fig.height=12}
d1eca=read.csv(here('stan models','outs','fits','posterior','fit1bh_chm_eca_linear.csv'),check.names=F)

cu=distinct(ch20r,River,.keep_all = T)
cu.nrv=summary(factor(cu$CU))

par(mfrow=c(3,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='',main='ECA effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
mtext(side=2,'Posterior density',line=0.5)
d0eca=density(d1eca[,2],bw=0.02)
for(j in 3:24){
d=density(d1eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

d1cpd=read.csv(here('stan models','outs','fits','posterior','fit1bh_chm_cpd_linear.csv'),check.names=F)

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='',main='CPD effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
mtext(side=2,'Posterior density',line=0.5)
d0cpd=density(d1cpd[,2],bw=0.02)
for(j in 3:24){
d=density(d1cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_ne=seq(min(ch20r$ECA_age_proxy_forested_only_std),max(ch20r$ECA_age_proxy_forested_only_std),length.out=100)
eca_n=x_ne*sd(ch20r$ECA_age_proxy_forested_only)+mean(ch20r$ECA_age_proxy_forested_only)

pRSe=exp(matrix(d1eca[,colnames(d1eca)=='alpha_0'],ncol=100,nrow=nrow(d1eca))+as.matrix(d1eca[,2])%*%x_ne)/exp(matrix(d1eca[,colnames(d1eca)=='alpha_0'],ncol=100,nrow=nrow(d1eca))+matrix(as.matrix(d1eca[,2])%*%x_ne[1],ncol=100,nrow=nrow(d1eca)))
m_prede=apply(pRSe,2,median)

plot(m_prede*100-100~eca_n,bty='l',type='n',ylab='Change in intrinsic productivity (recruits/spawner, %)',xlab='Equivalent clear cut area',ylim=c(-90,30),col='darkred',lwd=3,yaxt='n',xlim=c(min(eca_n),max(eca_n)))
axis(side=2,at=seq(-90,30,by=10))
abline(h=100,lwd=0.5,lty=5)
for(i in 1:nrow(d1eca)){
  lines(pRSe[i,]*100-100~eca_n,col=adjustcolor('darkgray',alpha.f = 0.01))
}
lines(m_prede*100-100~eca_n,lwd=3,col='darkred')
#abline(v=0)

ch20r$disturbedarea_prct_cs.std=scale(ch20r$disturbedarea_prct_cs)
x_ncpd=seq(min(ch20r$disturbedarea_prct_cs.std),max(ch20r$disturbedarea_prct_cs.std),length.out=100)
cpd_n=x_ncpd*sd(ch20r$disturbedarea_prct_cs)+mean(ch20r$disturbedarea_prct_cs)

pRSc=exp(matrix(d1cpd[,colnames(d1cpd)=='alpha_0'],ncol=100,nrow=nrow(d1cpd))+as.matrix(d1cpd[,2])%*%x_ncpd)/exp(matrix(d1cpd[,colnames(d1cpd)=='alpha_0'],ncol=100,nrow=nrow(d1cpd))+matrix(as.matrix(d1cpd[,2])%*%x_ncpd[1],ncol=100,nrow=nrow(d1cpd)))
m_predc=apply(pRSc,2,median)

plot(m_predc*100-100~cpd_n,bty='l',type='n',ylab='Change in intrinsic productivity (recruits/spawner, %)',xlab='Cumulative disturbed area (%)',ylim=c(-90,30),col='darkred',lwd=3,yaxt='n',xlim=c(min(cpd_n),max(cpd_n)))
axis(side=2,at=seq(-90,30,by=10))
abline(h=100,lwd=0.5,lty=5)
for(i in 1:nrow(d1cpd)){
  lines(pRSc[i,]*100-100~cpd_n,col=adjustcolor('darkgray',alpha.f = 0.01))
}
lines(m_predc*100-100~cpd_n,lwd=3,col='darkred')

cols=RColorBrewer::brewer.pal(7,'Blues');
cols=cols[-1] #remove first colour - too pale to see
br1=quantile(cu.nrv,seq(0,1,by=0.2))
col_lines1=cols[findInterval(cu.nrv,br1)]


plot(m_prede*100-100~eca_n,bty='l',type='n',ylab='Change in intrinsic productivity (recruits/spawner, %)',xlab='Cumulative disturbed area (%)',ylim=c(-100,200),col='darkred',lwd=3,yaxt='n')
axis(side=2,at=seq(-100,200,by=50))
abline(h=0,lwd=0.5,lty=5)
for(c in 1:22){
  cc=subset(ch20r,CU==levels(factor(ch20r$CU))[c])
  x_neca=seq(min(cc$ECA_age_proxy_forested_only_std),max(cc$ECA_age_proxy_forested_only_std),length.out=100)
  eca_nc=x_neca*sd(ch20r$ECA_age_proxy_forested_only)+mean(ch20r$ECA_age_proxy_forested_only)
  
#  x_nc=seq(min(cc$disturbedarea_prct_cs.std),max(cc$disturbedarea_prct_cs.std),length.out=100)
 # cpd_nc=x_nc*sd(ch20r$disturbedarea_prct_cs)+mean(ch20r$disturbedarea_prct_cs)
  pRSe=exp(matrix(d1eca[,colnames(d1eca)==paste('alpha_cu[',c,']',sep='')],ncol=100,nrow=nrow(d1eca))+matrix(as.matrix(d1eca[,colnames(d1eca)==paste('b_ECA_cu[',c,']',sep='')])%*%x_neca,nrow=nrow(d1eca),ncol=100))/exp(matrix(d1eca[,colnames(d1eca)==paste('alpha_cu[',c,']',sep='')],ncol=100,nrow=nrow(d1eca))+matrix(as.matrix(d1eca[,colnames(d1eca)==paste('b_ECA_cu[',c,']',sep='')])%*%x_ne[1],ncol=100,nrow=nrow(d1eca)))
  lines(apply(pRSe,2,median)*100-100~eca_nc,col=col_lines1[c],lwd= log(cu.nrv[c]+1))
}
for(i in 1:6){
  lines(rep(par('usr')[4]-(par('usr')[4]-par('usr')[3])*0.05*i,2)~c((par('usr')[2]-(par('usr')[2]-par('usr')[1])*0.05),(par('usr')[2]-(par('usr')[2]-par('usr')[1])*0.1)),lwd=log(quantile(cu.nrv,seq(0,1,by=0.2))[i]+1),col=cols[i])
  text(x=(par('usr')[2]-(par('usr')[2]-par('usr')[1])*0.15),y=par('usr')[4]-(par('usr')[4]-par('usr')[3])*0.05*i,round(quantile(cu.nrv,seq(0,1,by=0.2))[i]))
}
text(x=(par('usr')[2]-(par('usr')[2]-par('usr')[1])*0.075),y=par('usr')[4]-(par('usr')[4]-par('usr')[3])*0.005,'No. of rivers')
lines(m_prede*100~eca_n,lwd=3,col='darkred')


plot(m_predc*100-100~cpd_n,bty='l',type='n',ylab='Change in intrinsic productivity (recruits/spawner, %)',xlab='Cumulative disturbed area (%)',ylim=c(-100,200),col='darkred',lwd=3,yaxt='n')
axis(side=2,at=seq(-100,200,by=50))
abline(h=0,lwd=0.5,lty=5)
for(c in 1:22){
  cc=subset(ch20r,CU==levels(factor(ch20r$CU))[c])
  x_nc=seq(min(cc$disturbedarea_prct_cs.std),max(cc$disturbedarea_prct_cs.std),length.out=100)
  cpd_nc=x_nc*sd(ch20r$disturbedarea_prct_cs)+mean(ch20r$disturbedarea_prct_cs)
  
#  x_nc=seq(min(cc$disturbedarea_prct_cs.std),max(cc$disturbedarea_prct_cs.std),length.out=100)
 # cpd_nc=x_nc*sd(ch20r$disturbedarea_prct_cs)+mean(ch20r$disturbedarea_prct_cs)
  pRSc=exp(matrix(d1cpd[,colnames(d1cpd)==paste('alpha_cu[',c,']',sep='')],ncol=100,nrow=nrow(d1cpd))+matrix(as.matrix(d1cpd[,colnames(d1cpd)==paste('b_ECA_cu[',c,']',sep='')])%*%x_nc,nrow=nrow(d1cpd),ncol=100))/exp(matrix(d1cpd[,colnames(d1cpd)==paste('alpha_cu[',c,']',sep='')],ncol=100,nrow=nrow(d1cpd))+matrix(as.matrix(d1cpd[,colnames(d1cpd)==paste('b_ECA_cu[',c,']',sep='')])%*%x_ncpd[1],ncol=100,nrow=nrow(d1cpd)))
  lines(apply(pRSc,2,median)*100-100~cpd_nc,col=col_lines1[c],lwd= log(cu.nrv[c]+1))
}
#
for(i in 1:6){
  lines(rep(par('usr')[4]-(par('usr')[4]-par('usr')[3])*0.05*i,2)~c((par('usr')[2]-(par('usr')[2]-par('usr')[1])*0.05),(par('usr')[2]-(par('usr')[2]-par('usr')[1])*0.1)),lwd=log(quantile(cu.nrv,seq(0,1,by=0.2))[i]+1),col=cols[i])
  text(x=(par('usr')[2]-(par('usr')[2]-par('usr')[1])*0.15),y=par('usr')[4]-(par('usr')[4]-par('usr')[3])*0.05*i,round(quantile(cu.nrv,seq(0,1,by=0.2))[i]))
}
text(x=(par('usr')[2]-(par('usr')[2]-par('usr')[1])*0.075),y=par('usr')[4]-(par('usr')[4]-par('usr')[3])*0.005,'No. of rivers')
lines(m_predc*100-100~cpd_n,lwd=3,col='darkred')

```


### River-level varying effects of ECA and CPD

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit.

This plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, chm fitset 2 bh, fig.width=12,fig.height=8}
d2eca=read.csv(here('stan models','outs','fits','posterior','fit2bh_chm_eca_sqrt.csv'),check.names=F)
d2cpd=read.csv(here('stan models','outs','fits','posterior','fit2bh_chm_cpd_sqrt.csv'),check.names=F)

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='',main='ECA effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d2eca[,2],bw=0.02)
mtext(side=2,'Posterior density',line=0.5)
for(j in 3:ncol(d2eca)){ #22 cus
d=density(d2eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='',main='CPD effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d2cpd[,2],bw=0.02)
mtext(side=2,'Posterior density',line=0.5)
for(j in 3:ncol(d2cpd)){ #22 cus
d=density(d2cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_ne=seq(min(ch20r$sqrt.ECA.std),max(ch20r$sqrt.ECA.std),length.out=100)
eca_n=(x_ne*sd(ch20r$sqrt.ECA)+mean(ch20r$sqrt.ECA))^2

pRSe=exp(matrix(d2eca[,colnames(d2eca)=='alpha_0'],ncol=100,nrow=nrow(d2eca))+as.matrix(d2eca[,2])%*%x_ne)/exp(matrix(d2eca[,colnames(d2eca)=='alpha_0'],ncol=100,nrow=nrow(d2eca))+matrix(as.matrix(d2eca[,2])%*%x_ne[1],ncol=100,nrow=nrow(d2eca)))
m_prede=apply(pRSe,2,median)


plot(m_prede*100~eca_n,bty='l',type='n',ylab='Change in intrinsic productivity (recruits/spawner, %)',xlab='Equivalent clearcut area',ylim=c(-100,300),col='darkred',lwd=3,yaxt='n')
axis(side=2,at=seq(-100,300,by=50))
abline(h=0,lwd=0.5,lty=5)
for(c in 1:length(unique(ch20r$River))){
  jj=subset(ch20r,River==levels(factor(ch20r$River))[c])
  x_nc=seq(min(jj$sqrt.ECA.std),max(jj$sqrt.ECA.std),length.out=100)
  eca_nc=(x_nc*sd(ch20r$sqrt.ECA)+mean(ch20r$sqrt.ECA))^2
  pRSce=exp(matrix(d2eca[,colnames(d2eca)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d2eca))+as.matrix(d2eca[,colnames(d2eca)==paste('b_ECA_j[',c,']',sep='')])%*%x_nc)/exp(matrix(d2eca[,colnames(d2eca)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d2eca))+matrix(as.matrix(d2eca[,colnames(d2eca)==paste('b_ECA_j[',c,']',sep='')])%*%x_ne[1],ncol=100,nrow=nrow(d2eca)))
  lines(apply(pRSce,2,median)*100-100~eca_nc,col=adjustcolor('black',alpha.f=0.5))

  }
lines(m_prede*100-100~eca_n,lwd=3,col='darkred')


x_nc=seq(min(ch20r$sqrt.CPD.std),max(ch20r$sqrt.CPD.std),length.out=100)
cpd_n=(x_nc*sd(ch20r$sqrt.CPD)+mean(ch20r$sqrt.CPD))^2

pRSc=exp(matrix(d2cpd[,colnames(d2cpd)=='alpha_0'],ncol=100,nrow=nrow(d2cpd))+as.matrix(d2cpd[,2])%*%x_nc)/exp(matrix(d2cpd[,colnames(d2cpd)=='alpha_0'],ncol=100,nrow=nrow(d2cpd))+matrix(as.matrix(d2cpd[,2])%*%x_nc[1],ncol=100,nrow=nrow(d2cpd)))
m_predc=apply(pRSc,2,median)

plot(m_predc*100~cpd_n,bty='l',type='n',ylab='Change in intrinsic productivity (recruits/spawner, %)',xlab='Equivalent clearcut area',ylim=c(-100,300),col='darkred',lwd=3,yaxt='n')
axis(side=2,at=seq(-100,300,by=50))
abline(h=0,lwd=0.5,lty=5)
for(c in 1:length(unique(ch20r$River))){
  jj=subset(ch20r,River==levels(factor(ch20r$River))[c])
  x_nc=seq(min(jj$sqrt.CPD.std),max(jj$sqrt.CPD.std),length.out=100)
  cpd_nc=(x_nc*sd(ch20r$sqrt.CPD)+mean(ch20r$sqrt.CPD))^2
  pRScc=exp(matrix(d2cpd[,colnames(d2cpd)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d2cpd))+as.matrix(d2cpd[,colnames(d2cpd)==paste('b_ECA_j[',c,']',sep='')])%*%x_nc)/exp(matrix(d2cpd[,colnames(d2cpd)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d2cpd))+matrix(d2cpd[,colnames(d2cpd)==paste('b_ECA_j[',c,']',sep='')],ncol=100,nrow=nrow(d2cpd))*x_nc[1])
  lines(apply(pRScc,2,median)*100-100~cpd_nc,col=adjustcolor('black',alpha.f=0.5))

  }
lines(m_predc*100-100~cpd_n,lwd=3,col='darkred')


```


### Accounting for broad-scale drivers of productivity

Productivity responses to forestry may be an artifact of broad-scale oceanic drivers that are known to shape marine survival. To account for this, we implement a shared time-varying coastwide productivity model - where the global productivity $\alpha$ evolves through time according to a random walk model:

$\alpha_t = \alpha_{t-1} + w_t$

$w_t ~ N(0, \sigma_{\alpha,t}$

This term, $alpha_t$ adjusts the productivity for all stocks at each time-step, capturing potential synchronous increases and decreases in productivity from latent common drivers (e.g. Sea surface temperatures, Pacific Decadal Oscillation Index, North Pacific Gyre Oscillation Index, etc.) and accounts for these patterns while jointly estimating the effect of forestry metrics.

```{r, cpd tv, fig.width=12,fig.height=8}
d4cpd=read.csv(here('stan models','outs','fits','posterior','fit4bh_chm_cpd_sqrt.csv'),check.names=F)

d_alpha=data.frame(d4cpd[,grepl('alpha_t',colnames(d4cpd))])

par(mfrow=c(2,2))
plot(c(-1.5,2.5)~c(min(ch20r$BroodYear),max(ch20r$BroodYear)),type='n',xlab='Brood cohort year',ylab='Coastwide productivity estimate',bty='l')
for(i in 1:nrow(d_alpha)){
lines(unlist(d_alpha[i,])~seq(min(ch20r$BroodYear),max(ch20r$BroodYear)),col=adjustcolor('darkgray',alpha.f=0.2))  
}
lines(apply(d_alpha,2,median)~seq(min(ch20r$BroodYear),max(ch20r$BroodYear)),lwd=2,col='darkred')
points(apply(d_alpha,2,median)~seq(min(ch20r$BroodYear),max(ch20r$BroodYear)),lwd=2,bg='darkred',pch=21)


plot(c(0,13)~c(-1,1),bty='l',type='n',ylab='',ylim=c(0,13),yaxt='n',xlab='Standardized coefficients')
mtext(side=2,'Posterior density',line=0.5)
d0eca=density(d4cpd[,2],bw=0.02)
for(j in 3:24){ #22 cus
d=density(d4cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)


x_n=seq(min(ch20r$sqrt.CPD.std),max(ch20r$sqrt.CPD.std),length.out=100)
cpd_n=(x_n*sd(ch20r$sqrt.CPD)+mean(ch20r$sqrt.CPD))^2

dalpha0=apply(d_alpha,1,median)

pRS=exp(matrix(dalpha0,ncol=100,nrow=nrow(d4cpd))+as.matrix(d4cpd[,2])%*%x_n)/exp(matrix(dalpha0,ncol=100,nrow=nrow(d4cpd))+matrix(as.matrix(d4cpd[,2])%*%x_n[1],ncol=100,nrow=nrow(d4cpd)))
m_pred=apply(pRS,2,median)

plot(m_pred*100-100~cpd_n,bty='l',type='n',ylab='Change in intrinsic productivity (recruits/spawner, %)',xlab='Cumulative disturbed area (%)',ylim=c(-60,0),col='darkred',lwd=3,yaxt='n',xlim=c(min(cpd_n),max(cpd_n)))
axis(side=2,at=seq(-60,0,by=10))
abline(h=100,lwd=0.5,lty=5)
for(i in 1:nrow(d4cpd)){
  lines(pRS[i,]*100-100~cpd_n,col=adjustcolor('darkgray',alpha.f = 0.01))
}
lines(m_pred*100-100~cpd_n,lwd=3,col='darkred')
#abline(v=0)

cu=distinct(ch20r,River,.keep_all = T)
cu$CU2=as.numeric(factor(cu$CU))

plot(m_pred*100-100~cpd_n,bty='l',type='n',ylab='Change in intrinsic productivity (recruits/spawner, %)',xlab='Cumulative disturbed area (%)',ylim=c(-60,0),col='darkred',lwd=3,yaxt='n')
axis(side=2,at=seq(-60,0,by=10))
abline(h=100,lwd=0.5,lty=5)
for(c in 1:length(unique(ch20r$River))){
  jj=subset(ch20r,River==levels(factor(ch20r$River))[c])
  x_nc=seq(min(jj$sqrt.CPD.std),max(jj$sqrt.CPD.std),length.out=100)
  cpd_nc=(x_nc*sd(ch20r$sqrt.CPD)+mean(ch20r$sqrt.CPD))^2

   pRSc=exp(matrix(dalpha0,ncol=100,nrow=nrow(d4cpd))+matrix(d4cpd[,colnames(d4cpd)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d4cpd))+matrix(d4cpd[,colnames(d4cpd)==paste('b_ECA_cu[',cu$CU2[c],']',sep='')])%*%x_nc)/exp(matrix(dalpha0,ncol=100,nrow=nrow(d4cpd))+matrix(d4cpd[,colnames(d4cpd)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d4cpd))+matrix(d4cpd[,colnames(d4cpd)==paste('b_ECA_cu[',cu$CU2[c],']',sep='')],ncol=100,nrow=nrow(d4cpd))*x_n[1])
 
  lines(apply(pRSc,2,median)*100-100~cpd_nc,col=adjustcolor('black',alpha.f=0.5))
  
}
lines(m_pred*100-100~cpd_n,lwd=3,col='darkred')




```


### Shape of the relationship for ECA and CPD

We can treat the data on ECA/CPD in a variety of ways, that come with their own trade-offs, and influence the shape of their relationship with productivity. In the prior sections we transformed both predictors with the logit (p/(1-p)), partly to help normalize the data. We wanted to compare how these assumptions may change our inferences on the strength of effects, however. 

Here, we compare a linear form (untransformed ECA/CPD), a square-root transformation, and the logit transformation to get a sense of how they may change pointwise leverage. The red lines on the untransformed predictor show where internal knots were constructed for the Generalized Additive Model.

ECA:

```{r, hist eca trans, fig.width=12,fig.height=8}
ch20r$sqrt.ECA=sqrt(ch20r$ECA_age_proxy_forested_only)
ch20r$sqrt.ECA.std=(ch20r$sqrt.ECA-mean(ch20r$sqrt.ECA))/sd(ch20r$sqrt.ECA)


par(mfrow=c(2,2))
hist(ch20r$ECA_age_proxy_forested_only,breaks=30,xlab='ECA',main='')
abline(v=c(0.05,0.1,0.15,0.2,0.3,0.4),col='darkred',lty=3)
hist(sqrt(ch20r$ECA_age_proxy_forested_only),breaks=30,xlab='sqrt(ECA)',main='')
```

CPD:

```{r, hist cpd trans, fig.width=12,fig.height=8}
ch20r$sqrt.CPD=sqrt(ch20r$disturbedarea_prct_cs)
ch20r$sqrt.CPD.std=(ch20r$sqrt.CPD-mean(ch20r$sqrt.CPD))/sd(ch20r$sqrt.CPD)

par(mfrow=c(2,2))
hist(ch20r$disturbedarea_prct_cs,breaks=30,xlab='CPD',main='')
abline(v=c(10,20,30,40,60,80),col='darkred',lty=3)
hist(sqrt(ch20r$disturbedarea_prct_cs),breaks=30,xlab='sqrt(CPD)',main='')
```


This is how the responses to ECA/CPD compare across these metrics for Chum, alongside an estimate using the Generalized Additive Model (GAM) with a B-spline matrix consisting of 6 internals knots that subdivide the predictor at set intervals (ECA/CPD, as above). 

ECA:

```{r, eca form comp, fig.width=12,fig.height=8}
par(mfrow=c(2,2))

d_linear=read.csv(here('stan models','outs','fits','posterior','d_cpd_linear.csv'))
x_n=seq(min(ch20r$ECA_age_proxy_forested_only_std),max(ch20r$ECA_age_proxy_forested_only_std),length.out=100)
eca_n=x_n*sd(ch20r$ECA_age_proxy_forested_only)+mean(ch20r$ECA_age_proxy_forested_only)

pRS=as.matrix(d_linear[,2])%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),col='darkred',lwd=3,main='linear ECA')
for(j in 3:ncol(d_linear)){
  ps=as.matrix(d_linear[,j])%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)
lines(m_pred~eca_n,lwd=3,col='darkred')

d_sqrt=read.csv(here('stan models','outs','fits','posterior','d_cpd_sqrt.csv'))
ch20r$sqrt.CPD=sqrt(ch20r$disturbedarea_prct_cs)
ch20r$sqrt.CPD.std=(ch20r$sqrt.CPD-mean(ch20r$sqrt.CPD))/sd(ch20r$sqrt.CPD)

x_n=seq(min(ch20r$sqrt.ECA.std),max(ch20r$sqrt.ECA.std),length.out=100)
eca_n=(x_n*sd(ch20r$sqrt.ECA)+mean(ch20r$sqrt.ECA))^2

pRS=as.matrix(d_sqrt[,2])%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),col='darkred',lwd=3,main='sqrt ECA')
for(j in 3:ncol(d_sqrt)){
  ps=as.matrix(d_sqrt[,j])%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)
lines(m_pred~eca_n,lwd=3,col='darkred')


d_gam=read.csv(here('stan models','outs','fits','posterior','d_eca_gam.csv'))
plot(apply(d_gam[2:101],2,median)~seq(0,max(ch20r$ECA_age_proxy_forested_only),length.out=100),xlab='Equivalent clearcut area',ylab='Marginal effect on productivity',type='l',lwd=3,bty='l',ylim=c(-2,2),main='GAM ECA')
d_gamc=read.csv(here('stan models','outs','fits','posterior','d_eca_gam_cu.csv'),header=T,check.names=F)
for(i in 1:22){
  d2=d_gamc[,grepl(paste(',',i,']',sep=''),colnames(d_gamc))]
  lines(apply(d2,2,median)~seq(0,max(ch20r$ECA_age_proxy_forested_only),length.out=100),col=adjustcolor('darkgray',alpha.f = 0.6))
}
lines(apply(d_gam[2:101],2,median)~seq(0,max(ch20r$ECA_age_proxy_forested_only),length.out=100),col='darkred',lwd=2)
lines(apply(d_gam[2:101],2,quantile,0.025)~seq(0,max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)
lines(apply(d_gam[2:101],2,quantile,0.975)~seq(0,max(ch20r$ECA_age_proxy_forested_only),length.out=100),lty=5)
### Ricker model sets####


```

CPD:

```{r, cpd form comp, fig.width=12,fig.height=8}
par(mfrow=c(2,2))

d_linear=read.csv(here('stan models','outs','fits','posterior','d_cpd_linear.csv'))
x_n=seq(min(scale(ch20r$disturbedarea_prct_cs)),max(scale(ch20r$disturbedarea_prct_cs)),length.out=100)
cpd_n=x_n*sd(ch20r$disturbedarea_prct_cs)+mean(ch20r$disturbedarea_prct_cs)

pRS=as.matrix(d_linear[,2])%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~cpd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed',ylim=c(-2,2),col='darkred',lwd=3,main='linear CPD')
for(j in 3:ncol(d_linear)){
  ps=as.matrix(d_linear[,j])%*%x_n
  lines(apply(ps,2,median)~cpd_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)
lines(m_pred~cpd_n,lwd=3,col='darkred')

d_sqrt=read.csv(here('stan models','outs','fits','posterior','d_cpd_sqrt.csv'))
ch20r$sqrt.CPD=sqrt(ch20r$disturbedarea_prct_cs)
ch20r$sqrt.CPD.std=(ch20r$sqrt.CPD-mean(ch20r$sqrt.CPD))/sd(ch20r$sqrt.CPD)

x_n=seq(min(ch20r$sqrt.CPD.std),max(ch20r$sqrt.CPD.std),length.out=100)
cpd_n=(x_n*sd(ch20r$sqrt.CPD)+mean(ch20r$sqrt.CPD))^2

pRS=as.matrix(d_sqrt[,2])%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~cpd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed',ylim=c(-2,2),col='darkred',lwd=3,main='sqrt CPD')
for(j in 3:ncol(d_sqrt)){
  ps=as.matrix(d_sqrt[,j])%*%x_n
  lines(apply(ps,2,median)~cpd_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)
lines(m_pred~cpd_n,lwd=3,col='darkred')

d_gam=read.csv(here('stan models','outs','fits','posterior','d_cpd_gam.csv'))
plot(apply(d_gam[2:101],2,median)~seq(0,max(ch20r$disturbedarea_prct_cs),length.out=100),xlab='Cumulative % disturbed',ylab='Marginal effect on productivity',type='l',lwd=3,bty='l',ylim=c(-2,2),main='GAM CPD')
d_gamc=read.csv(here('stan models','outs','fits','posterior','d_cpd_gam_cu.csv'),header=T,check.names=F)
for(i in 1:22){
  d2=d_gamc[,grepl(paste(',',i,']',sep=''),colnames(d_gamc))]
  lines(apply(d2,2,median)~seq(0,max(ch20r$disturbedarea_prct_cs),length.out=100),col=adjustcolor('darkgray',alpha.f = 0.6))
}
lines(apply(d_gam[2:101],2,median)~seq(0,max(ch20r$disturbedarea_prct_cs),length.out=100),col='darkred',lwd=2)
lines(apply(d_gam[2:101],2,quantile,0.025)~seq(0,max(ch20r$disturbedarea_prct_cs),length.out=100),lty=5)
lines(apply(d_gam[2:101],2,quantile,0.975)~seq(0,max(ch20r$disturbedarea_prct_cs),length.out=100),lty=5)
### Ricker model sets####

```

### Watershed area as a mediator

Posterior estimates of the interaction between watershed area and the effect of ECA (median in red):

```{r, areaxeca chm}
par(mfrow=c(1,1))
f3bh_chm_eca=readRDS(here('stan models','outs','fits','fit3bh_chm_eca.RDS'))

d3chm=f3bh_chm_eca$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

Posterior estimates of the interaction between watershed area and the effect of CPD (median in red):

```{r, areaxcpd chm}
par(mfrow=c(1,1))
f3bh_chm_cpd=readRDS(here('stan models','outs','fits','fit3bh_chm_cpd.RDS'))

d3chm=f3bh_chm_cpd$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3chm, breaks=30,main='',xlab='Effect size')
abline(v=median(d3chm),lwd=3,col='darkred')
abline(v=0,lwd=2)
```


## Pink - Even broodlines

### CU-level varying effects for ECA and CPD

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit are outputted below. The plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, pke fitset 1 bh, fig.width=12,fig.height=8}
d1eca=read.csv(here('stan models','outs','fits','posterior','d1eca_pke.csv'))

pk10r_e$logit.ECA=qlogis(pk10r_e$ECA_age_proxy_forested_only+0.005)
pk10r_e$logit.ECA.std=(pk10r_e$logit.ECA-mean(pk10r_e$logit.ECA))/sd(pk10r_e$logit.ECA)

#normalize cumulative % disturbed
pk10r_e$disturbedarea_prct_cs2=ifelse(pk10r_e$disturbedarea_prct_cs<1,1,pk10r_e$disturbedarea_prct_cs)
pk10r_e$disturbedarea_prct_cs2=ifelse(pk10r_e$disturbedarea_prct_cs2>99,99,pk10r_e$disturbedarea_prct_cs2)

pk10r_e$logit.pdisturb=qlogis(pk10r_e$disturbedarea_prct_cs2/100)
pk10r_e$logit.pdisturb.std=(pk10r_e$logit.pdisturb-mean(pk10r_e$logit.pdisturb))/sd(pk10r_e$logit.pdisturb)


par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d1eca[,2],bw=0.02)
for(j in 3:ncol(d1eca)){
d=density(d1eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

d1cpd=read.csv(here('stan models','outs','fits','posterior','d1cpd_pke.csv'))

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d1cpd[,2],bw=0.02)
for(j in 3:ncol(d1cpd)){
d=density(d1cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(pk10r_e$logit.ECA.std),max(pk10r_e$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(pk10r_e$logit.ECA)+mean(pk10r_e$logit.ECA))

pRS=as.matrix(d1eca[,2])%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='n',type='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 3:ncol(d1eca)){
  ps=as.matrix(d1eca[,j])%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)
lines(m_pred~eca_n,lwd=3,col='darkred')

x_n=seq(min(pk10r_e$logit.pdisturb.std),max(pk10r_e$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(pk10r_e$logit.pdisturb)+mean(pk10r_e$logit.pdisturb))*100

pRS=as.matrix(d1cpd[,2])%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~cpd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 2:ncol(d1cpd)){
  ps=as.matrix(d1cpd[,j])%*%x_n
  lines(apply(ps,2,median)~cpd_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)
lines(m_pred~cpd_n,lwd=3,col='darkred')


```


### River-level varying effects of ECA and CPD

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit.

This plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, pke fitset 2 bh, fig.width=12,fig.height=8}

d2eca=read.csv(here('stan models','outs','fits','posterior','d2eca_pke.csv'))
d2cpd=read.csv(here('stan models','outs','fits','posterior','d2cpd_pke.csv'))

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d2eca[,2],bw=0.02)
for(j in 3:ncol(d2eca)){ #22 cus
d=density(d2eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d2cpd[,2],bw=0.02)
for(j in 3:ncol(d2cpd)){ #22 cus
d=density(d2cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(pk10r_e$logit.ECA.std),max(pk10r_e$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(pk10r_e$logit.ECA)+mean(pk10r_e$logit.ECA))

pRS=as.matrix(d2eca[,2])%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),type='n')
for(j in 3:ncol(d2eca)){
  ps=as.matrix(d2eca[,j])%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~eca_n,lwd=3,col='darkred')
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)

x_n=seq(min(pk10r_e$logit.pdisturb.std),max(pk10r_e$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(pk10r_e$logit.pdisturb)+mean(pk10r_e$logit.pdisturb))*100

pRS=as.matrix(d2cpd[,2])%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~cpd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2))
for(j in 3:ncol(d2cpd)){
  ps=as.matrix(d2cpd[,j])%*%x_n
  lines(apply(ps,2,median)~cpd_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~cpd_n,lwd=3,col='darkred')
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)

```



### Watershed area as a mediator

Posterior estimates of the interaction between watershed area and the effect of ECA (median in red):

```{r, areaxeca pke}
par(mfrow=c(1,1))
f3bh_pke_eca=readRDS(here('stan models','outs','fits','fit3bh_pke_eca.RDS'))

d3pke=f3bh_pke_eca$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3pke, breaks=30,main='',xlab='Effect size')
abline(v=median(d3pke),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

Posterior estimates of the interaction between watershed area and the effect of CPD (median in red):

```{r, areaxcpd pke}
f3bh_pke_cpd=readRDS(here('stan models','outs','fits','fit3bh_pke_cpd.RDS'))

d3pke=f3bh_pke_cpd$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3pke, breaks=30,main='',xlab='Effect size')
abline(v=median(d3pke),lwd=3,col='darkred')
abline(v=0,lwd=2)
```


## Pink - Odd broodlines

### CU-level varying effects for ECA and CPD

The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit are outputted below. The plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, pko fitset 1 bh, fig.width=12,fig.height=8}
d1eca=read.csv(here('stan models','outs','fits','posterior','d1eca_pko.csv'))

#normalize ECA - logit transformation (ie. log(x/(1-x)))
pk10r_o$logit.ECA=qlogis(pk10r_o$ECA_age_proxy_forested_only+0.005)
pk10r_o$logit.ECA.std=(pk10r_o$logit.ECA-mean(pk10r_o$logit.ECA))/sd(pk10r_o$logit.ECA)

#normalize cumulative % disturbed
pk10r_o$disturbedarea_prct_cs2=ifelse(pk10r_o$disturbedarea_prct_cs<1,1,pk10r_o$disturbedarea_prct_cs)
pk10r_o$disturbedarea_prct_cs2=ifelse(pk10r_o$disturbedarea_prct_cs2>99,99,pk10r_o$disturbedarea_prct_cs2)

pk10r_o$logit.pdisturb=qlogis(pk10r_o$disturbedarea_prct_cs2/100)
pk10r_o$logit.pdisturb.std=(pk10r_o$logit.pdisturb-mean(pk10r_o$logit.pdisturb))/sd(pk10r_o$logit.pdisturb)


par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d1eca[,2],bw=0.02)
for(j in 3:ncol(d1eca)){
d=density(d1eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

d1cpd=read.csv(here('stan models','outs','fits','posterior','d1cpd_pko.csv'))

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by CU (BH)',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d1cpd[,2],bw=0.02)
for(j in 3:ncol(d1cpd)){
d=density(d1cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(pk10r_o$logit.ECA.std),max(pk10r_o$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(pk10r_o$logit.ECA)+mean(pk10r_o$logit.ECA))

pRS=as.matrix(d1eca[,2])%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='n',type='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 3:ncol(d1eca)){
  ps=as.matrix(d1eca[,j])%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)
lines(m_pred~eca_n,lwd=3,col='darkred')

x_n=seq(min(pk10r_o$logit.pdisturb.std),max(pk10r_o$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(pk10r_o$logit.pdisturb)+mean(pk10r_o$logit.pdisturb))*100

pRS=as.matrix(d1cpd[,2])%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~cpd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2),col='darkred',lwd=3)
for(j in 2:ncol(d1cpd)){
  ps=as.matrix(d1cpd[,j])%*%x_n
  lines(apply(ps,2,median)~cpd_n,col=adjustcolor('darkgray',alpha.f=0.6))
}
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)
lines(m_pred~cpd_n,lwd=3,col='darkred')

```


### River-level varying effects of ECA and CPD
The overall among population effect size (b_ECA) for ECA, and varying effects of ECA by CU (b_ECA_cu), from the Beverton-Holt fit.

This plot shows density of effect sizes among CUs and the red line indicates the global effect:

```{r, pko fitset 2 bh, fig.width=12,fig.height=8}
d2eca=read.csv(here('stan models','outs','fits','posterior','d2eca_pko.csv'))
d2cpd=read.csv(here('stan models','outs','fits','posterior','d2cpd_pko.csv'))

par(mfrow=c(2,2))
plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d2eca[,2],bw=0.02)
for(j in 3:ncol(d2eca)){ #22 cus
d=density(d2eca[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0cpd=density(d2cpd[,2],bw=0.02)
for(j in 3:ncol(d2cpd)){ #22 cus
d=density(d2cpd[,j],bw=0.02)
lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0cpd$y~d0cpd$x,col='darkred',lwd=3)
abline(v=0,lwd=2)

x_n=seq(min(pk10r_o$logit.ECA.std),max(pk10r_o$logit.ECA.std),length.out=100)
eca_n=plogis(x_n*sd(pk10r_o$logit.ECA)+mean(pk10r_o$logit.ECA))

pRS=as.matrix(d2eca[,2])%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~eca_n,bty='l',ylab='change in log(R/S)',xlab='Equivalent clearcut area',ylim=c(-2,2),type='n')
for(j in 3:ncol(d2eca)){
  ps=as.matrix(d2eca[,j])%*%x_n
  lines(apply(ps,2,median)~eca_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~eca_n,lwd=3,col='darkred')
lines(l_pred~eca_n,lty=5)
lines(u_pred~eca_n,lty=5)

x_n=seq(min(pk10r_o$logit.pdisturb.std),max(pk10r_o$logit.pdisturb.std),length.out=100)
cpd_n=plogis(x_n*sd(pk10r_o$logit.pdisturb)+mean(pk10r_o$logit.pdisturb))*100

pRS=as.matrix(d2cpd[,2])%*%x_n
m_pred=apply(pRS,2,median)
l_pred=apply(pRS,2,quantile,0.05)
u_pred=apply(pRS,2,quantile,0.95)

plot(m_pred~cpd_n,bty='l',type='n',ylab='change in log(R/S)',xlab='Cumulative % disturbed area',ylim=c(-2,2))
for(j in 3:ncol(d2cpd)){
  ps=as.matrix(d2cpd[,j])%*%x_n
  lines(apply(ps,2,median)~cpd_n,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(m_pred~cpd_n,lwd=3,col='darkred')
lines(l_pred~cpd_n,lty=5)
lines(u_pred~cpd_n,lty=5)
```


### Watershed area as a mediator

Posterior estimates of the interaction between watershed area and the effect of ECA (median in red):

```{r, areaxeca pko}
par(mfrow=c(1,1))
f3bh_pko_eca=readRDS(here('stan models','outs','fits','fit3bh_pko_eca.RDS'))

d3pko=f3bh_pko_eca$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3pko, breaks=30,main='',xlab='Effect size')
abline(v=median(d3pko),lwd=3,col='darkred')
abline(v=0,lwd=2)
```

Posterior estimates of the interaction between watershed area and the effect of CPD (median in red):

```{r, areaxcpd pko}
f3bh_pko_cpd=readRDS(here('stan models','outs','fits','fit3bh_pko_cpd.RDS'))

d3chm=f3bh_pko_cpd$draws(variables=c('b_ECA_Area'),format='draws_matrix')

hist(d3pko, breaks=30,main='',xlab='Effect size')
abline(v=median(d3pko),lwd=3,col='darkred')
abline(v=0,lwd=2)
```


# River-level Spawner-Recruit fits
Here is each river-level stock-recruitment curve comparing estimates with ECA or CPD. The observations are shaded according to their ECA/CPD level (brown = higher ECA, green = lower ECA; scaled to each S-R series). The median expected recruits and their 90% credible intervals are displayed as black solid and dashed lines. The expected recruits at minimum and maximum observed ECA/CPD values for that river are shown in brown and green lines, respectively. The time-series for ECA (bottom-left) is shown with the realized effect on productivity under each model (ECA = blue; CPD = orange; bottom-right).


## Chum

```{r, sr time-series chm, fig.width=12,fig.height=8, results="asis"}
ch20r$cuid=as.numeric(factor(ch20r$CU))

f1bh_chm_eca=readRDS(here('stan models','outs','fits','fit1bh_chm_eca.RDS'))
f1bh_chm_cpd=readRDS(here('stan models','outs','fits','fit1bh_chm_cpd.RDS'))

d1eca=f1bh_chm_eca$draws(variables=c('alpha_j','Rk','b_ECA_cu'),form='draws_matrix')
d1cpd=f1bh_chm_cpd$draws(variables=c('alpha_j','Rk','b_ECA_cu'),form='draws_matrix')

for(c in 1:length(unique(ch20r$River))){
  cat('\n')  
  cat("### ", levels(factor(ch20r$River))[c], "\n")
  #CU header
  rv=subset(ch20r,River==levels(factor(ch20r$River))[c])
   cols= rev(RColorBrewer::brewer.pal(9,'BrBG'));
   br1=quantile(rv$ECA_age_proxy_forested_only,probs=seq(0,1,length.out=8))
   col_points1=adjustcolor(cols[findInterval(rv$ECA_age_proxy_forested_only,br1)],alpha.f=0.8)
   br2=quantile(rv$disturbedarea_prct_cs,probs=seq(0,1,length.out=8))
   col_points2=adjustcolor(cols[findInterval(rv$disturbedarea_prct_cs,br2)],alpha.f=0.8)
   
  par(mfrow=c(2,2))
  
  #ECA
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(ECA)',sep=' '))
  
  alpha_j=d1eca[,colnames(d1eca)== paste('alpha_j[',c,']',sep='')]
  Rk_j=d1eca[,colnames(d1eca)== paste('Rk[',c,']',sep='')]
  b_ECA=d1eca[,colnames(d1eca)== paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j)/Rk_j)%*%s_pred),2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*min(rv$ECA_age_proxy_forested_only_std),ncol=length(s_pred),nrow=length(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*max(rv$ECA_age_proxy_forested_only_std),ncol=length(s_pred),nrow=length(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points1,pch=21,cex=1.5) 
  
  #CPD
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(CPD)',sep=' '))
  
  alpha_j=d1cpd[,colnames(d1cpd)== paste('alpha_j[',c,']',sep='')]
  Rk_j=d1cpd[,colnames(d1cpd)== paste('Rk[',c,']',sep='')]
  b_ECA=d1cpd[,colnames(d1cpd)==paste('b_ECA_cu[',unique(rv$cuid),']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j)/Rk_j)%*%s_pred),2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j)/Rk_j)%*%s_pred),2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*min(rv$disturbedarea_prct_cs.std),ncol=length(s_pred),nrow=length(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j)/Rk_j)%*%s_pred)+matrix(b_ECA*max(rv$disturbedarea_prct_cs.std),ncol=length(s_pred),nrow=length(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points2,pch=21,cex=1.5) 
  
  
   plot(rv$ECA_age_proxy_forested_only~rv$BroodYear,bty='l',type='n',xlab='Brood Year',ylab='Forest loss metric',ylim=c(0,1))
   lines(ECA_age_proxy_forested_only~BroodYear,data=rv,col='navy',lwd=2)
    points(ECA_age_proxy_forested_only~BroodYear,data=rv,bg=col_points1,pch=21,cex=1.5,col='navy') 
   lines(rv$disturbedarea_prct_cs/100~BroodYear,data=rv,col='tan2',lwd=2)
    points(rv$disturbedarea_prct_cs/100~BroodYear,data=rv,bg=col_points2,pch=21,cex=1.5,col='tan2')
    text(x=par('usr')[2]-4,y=par('usr')[4]*0.95,'ECA',col='navy')
    text(x=par('usr')[2]-4,y=par('usr')[4]*0.88,'CPD',col='tan2')
  
  realized_eca=as.matrix(d1eca[,colnames(d1eca)==paste('b_ECA_cu[',unique(rv$cuid),']',sep='')])%*%rv$ECA_age_proxy_forested_only_std
 realized_eca_m=apply(realized_eca,2,median)
  
   realized_cpd=as.matrix(d1cpd[,colnames(d1cpd)==paste('b_ECA_cu[',unique(rv$cuid),']',sep='')])%*%as.vector(rv$disturbedarea_prct_cs.std)
 realized_cpd_m=apply(realized_cpd,2,median)
    
   plot(realized_eca_m~rv$BroodYear,bty='l',type='n',ylim=c(min(c(realized_eca_m,realized_cpd_m)),max(c(realized_eca_m,realized_cpd_m))*1.2),ylab='Marginal effect on productivity through time',xlab='Brood Year')
   lines(realized_eca_m~BroodYear,data=rv,col='navy',lwd=2)
    points(realized_eca_m~BroodYear,data=rv,col='navy',bg=col_points1,pch=21,cex=1.5) 
  
   lines(realized_cpd_m~BroodYear,data=rv,col='tan2',lwd=2)
    points(realized_cpd_m~BroodYear,data=rv,col='tan2',bg=col_points2,pch=21,cex=1.5) 
   
    
    text(x=par('usr')[2]-5,y=realized_eca_m[length(realized_eca_m)]+(par('usr')[4]-par('usr')[3])*0.03,'ECA',col='navy')
    text(x=par('usr')[2]-5,y=realized_cpd_m[length(realized_cpd_m)]+(par('usr')[4]-par('usr')[3])*0.03,'CPD',col='tan2')

   cat('\n')  
}
```

