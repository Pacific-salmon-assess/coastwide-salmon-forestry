---
title: "Coastwide analysis of forestry impacts on BC Pacific Salmon"
author: ''
date: "Apr. 2024"
output:
  html_document:
    collapsed: no
    fig_caption: yes
    highlight: espresso
    number_sections: yes
    smooth_scroll: yes
    theme: sandstone
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 13px;
  }
td {  /* Table  */
  font-size: 13px;
}
h1.title {
  font-size: 24px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 19px;
  color: Black;
}
h2 { /* Header 2 */
    font-size: 15px;
  color: Black;
}
h3 { /* Header 3 */
    font-size: 15px;
  color: Black;
}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
library(cmdstanr)
```

# Overview

This documents is for developing the results and supporting figures.

Code and data to reproduce the analyses summarized in this document can be found in [**this repository**](https://github.com/Pacific-salmon-assess/coastwide-salmon-forestry).

The overall modelling effort is to capture how variation in recruits throughout the time-series of ~300 salmon-bearing rivers for 2 species (Chum and pinks) may be influenced by forestry activity throughout the 60y period.

# Model

Two different model forms were used corresponding to each species (Chum and Pink salmon), both based on a linearized version of the Beverton-Holt stock-recruit model:

For chum, log(recruits/spawner) was measured for each river $r$ as:

$log(R_{t,r}/S_{t,r}) = \alpha_t + \alpha_r - log(1+(e^{\alpha_t+\alpha_r})/R_{k,r})*S_{t,r}) + \beta_{for,r}*X{t,r} + \epsilon_{t,r}$


Where a coastwide time-varying productivity term ($\alpha_t$) accounts for common changes in stock productivity throughout the time-series:

$\alpha_{t=1} \sim N(4,5)$

$\alpha_{t=2,..,T} = \alpha_{t-1} + w_t$

$w_t \sim N(0,\sigma_w)$

$\sigma_w \sim N[0,1)$

Density-dependence is quantified by the parameter $R_{k,r}$, the stock-specific equilibrium recruitment, which was sampled with informative priors based on observed recruitment ($R$):

$R_{k,r} \sim lognormal(0.75*max(R_r),max(R_r))$


And stock-specific parameters are drawn hierarchically at the River-level for time-invariant productivity ($\alpha_r$
) and for the effect of different forestry metrics ($b_{for,r}$, ie. either equivalent clearcut area or cumulative disturbed area):

$\alpha_r \sim N(\alpha_{c}, \sigma_{ar}^2)$

$\alpha_{c} \sim N(\alpha, \sigma_{ac}^2)$

$\beta_{for,r} \sim N(\beta_{for,c}, \sigma_{for,c})$

$\beta_{for,c} \sim N(\beta_{for}, \sigma_{for})$

$\beta_{for} \sim N(0,1)$

$\sigma_{for} \sim N[0,1)$

$\sigma_r \sim N(\sigma_c,\sigma_{\sigma,r})$

$\sigma_c \sim N(\sigma,\sigma_{\sigma,c})$

$\sigma \sim N[0.5,1)$

The Ricker formulation of the model only differs by the density-dependence term, which is now captured by $Smax_r$:

$log(R_{t,r}/S_{t,r}) = \alpha_t + \alpha_r - S_{t,r}/Smax_r + \beta_{for,r}*X{t,r} + \epsilon_{t,r}$

Stock-specific capacity parameter ($\Smax_r$) is estimated independently at the river level, but with informative priors based on observed spawner counts ($S_r$):

$\Smax_r \sim lognormal(log(0.5*max(S_{t,r})),log(max(S_{t,r}))$

For Pinks, the 


```{r prep data,  include=FALSE}
library(here);library(cmdstanr);library(dplyr)

ch20r <- read.csv("../origional-ecofish-data-models/Data/Processed/chum_SR_20_hat_yr_reduced_VRI90.csv")
ch20r$cuid=as.numeric(factor(ch20r$CU))
#even year pinks
pk10r_e <- read.csv("../origional-ecofish-data-models/Data/Processed/pke_SR_10_hat_yr_reduced_VRI90.csv")
pk10r_e$cuid=as.numeric(factor(pk10r_e$CU))

#odd year pinks
pk10r_o <- read.csv("../origional-ecofish-data-models/Data/Processed/pko_SR_10_hat_yr_reduced_VRI90.csv")
pk10r_o$cuid=as.numeric(factor(pk10r_o$CU))

#two rivers named salmon river... recode
ch20r$River=ifelse(ch20r$WATERSHED_CDE=='950-169400-00000-00000-0000-0000-000-000-000-000-000-000','SALMON RIVER 2',ch20r$River)
ch20r$River=ifelse(ch20r$WATERSHED_CDE=="915-486500-05300-00000-0000-0000-000-000-000-000-000-000",'LAGOON CREEK 2',ch20r$River)


ch20r$disturbedarea_prct_cs.std=scale(ch20r$disturbedarea_prct_cs)

#normalize ECA 2 - square root transformation (ie. sqrt(x))
ch20r$sqrt.ECA=sqrt(ch20r$ECA_age_proxy_forested_only)
ch20r$sqrt.ECA.std=(ch20r$sqrt.ECA-mean(ch20r$sqrt.ECA))/sd(ch20r$sqrt.ECA)

#normalize CPD 2 - square root transformation (ie. sqrt(x))
ch20r$sqrt.CPD=sqrt(ch20r$disturbedarea_prct_cs)
ch20r$sqrt.CPD.std=(ch20r$sqrt.CPD-mean(ch20r$sqrt.CPD))/sd(ch20r$sqrt.CPD)

pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=='950-169400-00000-00000-0000-0000-000-000-000-000-000-000','SALMON RIVER 2',pk10r_o$River)
pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=='915-765500-18600-00000-0000-0000-000-000-000-000-000-000','HEAD CREEK 2',pk10r_o$River)
pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=='915-488000-41400-00000-0000-0000-000-000-000-000-000-000','WINDY BAY CREEK 2',pk10r_o$River)
pk10r_o$River=ifelse(pk10r_o$WATERSHED_CDE=="915-486500-05300-00000-0000-0000-000-000-000-000-000-000",'LAGOON CREEK 2',pk10r_o$River)
pk10r_o=pk10r_o[order(factor(pk10r_o$River),pk10r_o$BroodYear),]
rownames(pk10r_o)=seq(1:nrow(pk10r_o))

pk10r_e$River=ifelse(pk10r_e$WATERSHED_CDE=='950-169400-00000-00000-0000-0000-000-000-000-000-000-000','SALMON RIVER 2',pk10r_e$River)
pk10r_e$River=ifelse(pk10r_e$WATERSHED_CDE=='915-765500-18600-00000-0000-0000-000-000-000-000-000-000','HEAD CREEK 2',pk10r_e$River)
pk10r_e$River=ifelse(pk10r_e$WATERSHED_CDE=='915-488000-41400-00000-0000-0000-000-000-000-000-000-000','WINDY BAY CREEK 2',pk10r_e$River)
pk10r_e$River=ifelse(pk10r_e$WATERSHED_CDE=="915-486500-05300-00000-0000-0000-000-000-000-000-000-000",'LAGOON CREEK 2',pk10r_e$River)
pk10r_e=pk10r_e[order(factor(pk10r_e$River),pk10r_e$BroodYear),]
rownames(pk10r_e)=seq(1:nrow(pk10r_e))


#normalize ECA 2 - square root transformation (ie. sqrt(x))
pk10r_o$sqrt.ECA=sqrt(pk10r_o$ECA_age_proxy_forested_only)
pk10r_o$sqrt.ECA.std=(pk10r_o$sqrt.ECA-mean(pk10r_o$sqrt.ECA))/sd(pk10r_o$sqrt.ECA)

#normalize CPD 2 - square root transformation (ie. sqrt(x))
pk10r_o$sqrt.CPD=sqrt(pk10r_o$disturbedarea_prct_cs)
pk10r_o$sqrt.CPD.std=(pk10r_o$sqrt.CPD-mean(pk10r_o$sqrt.CPD))/sd(pk10r_o$sqrt.CPD)

#normalize ECA 2 - square root transformation (ie. sqrt(x))
pk10r_e$sqrt.ECA=sqrt(pk10r_e$ECA_age_proxy_forested_only)
pk10r_e$sqrt.ECA.std=(pk10r_e$sqrt.ECA-mean(pk10r_e$sqrt.ECA))/sd(pk10r_e$sqrt.ECA)

#normalize CPD 2 - square root transformation (ie. sqrt(x))
pk10r_e$sqrt.CPD=sqrt(pk10r_e$disturbedarea_prct_cs)
pk10r_e$sqrt.CPD.std=(pk10r_e$sqrt.CPD-mean(pk10r_e$sqrt.CPD))/sd(pk10r_e$sqrt.CPD)

pk10r_o$Broodline='Odd'
pk10r_e$Broodline='Even'

pk10r=rbind(pk10r_e,pk10r_o)
pk10r$River2=paste(pk10r$River,pk10r$Broodline,sep='_')
pk10r=pk10r[order(factor(pk10r$River2),pk10r$BroodYear),]
```

# Fig. 3. Global (cross population) effects of ECA/CPD by species ####

Provisional fig. 3 in main text (global - across stock - effects of ECA/CPD by species):

```{r, fig. 3 - draft 1}
d_chm_eca=read.csv(here('stan models','outs','posterior','bh_chm_eca.csv'),check.names=F)
d_chm_cpd=read.csv(here('stan models','outs','posterior','bh_chm_cpd.csv'),check.names=F)

d_pk_eca=read.csv(here('stan models','outs','posterior','bh_pk_eca.csv'),check.names=F)
d_pk_cpd=read.csv(here('stan models','outs','posterior','bh_pk_cpd.csv'),check.names=F)

cols=c('#018571','#993404')
par(mfrow=c(2,2))
x_n_chm_eca=seq(min(ch20r$sqrt.ECA.std),max(ch20r$sqrt.ECA.std),length.out=100)
chm_eca_n=(x_n_chm_eca*sd(ch20r$sqrt.ECA)+mean(ch20r$sqrt.ECA))^2

d_alpha_chm_eca=data.frame(d_chm_eca[,grepl('alpha_t',colnames(d_chm_eca))])
dalpha0_chm_eca=apply(d_alpha_chm_eca,1,median)

pRS_chm_eca=exp(matrix(dalpha0_chm_eca,ncol=100,nrow=nrow(d_chm_eca))+as.matrix(d_chm_eca[,2])%*%x_n_chm_eca)/exp(matrix(dalpha0_chm_eca,ncol=100,nrow=nrow(d_chm_eca))+matrix(as.matrix(d_chm_eca[,2])%*%x_n_chm_eca[1],ncol=100,nrow=nrow(d_chm_eca)))
m_pred_chm_eca=apply(pRS_chm_eca,2,median)

plot(m_pred_chm_eca*100-100~chm_eca_n,bty='l',type='n',ylab='Change in productivity (R/S, %)',xlab='',ylim=c(-100,50),col='darkred',lwd=3,yaxt='n',xlim=c(min(chm_eca_n*100),max(chm_eca_n*100)))
axis(side=2,at=seq(-100,50,by=25))
abline(h=0,lwd=0.5,lty=5)
for(i in 1:nrow(d_chm_eca)){
  lines(pRS_chm_eca[i,]*100-100~c(chm_eca_n*100),col=adjustcolor('darkgray',alpha.f = 0.01))
}
lines(m_pred_chm_eca*100-100~c(chm_eca_n*100),lwd=3,col=cols[1])
mtext(side=3,'Chum',font=2,at=2,line=0.5,col=cols[1],adj=0)

x_n_chm_cpd=seq(min(ch20r$sqrt.CPD.std),max(ch20r$sqrt.CPD.std),length.out=100)
chm_cpd_n=(x_n_chm_cpd*sd(ch20r$sqrt.CPD)+mean(ch20r$sqrt.CPD))^2

d_alpha_chm_cpd=data.frame(d_chm_cpd[,grepl('alpha_t',colnames(d_chm_cpd))])
dalpha0_chm_cpd=apply(d_alpha_chm_cpd,1,median)

pRS_chm_cpd=exp(matrix(dalpha0_chm_cpd,ncol=100,nrow=nrow(d_chm_cpd))+as.matrix(d_chm_cpd[,2])%*%x_n_chm_cpd)/exp(matrix(dalpha0_chm_cpd,ncol=100,nrow=nrow(d_chm_cpd))+matrix(as.matrix(d_chm_cpd[,2])%*%x_n_chm_cpd[1],ncol=100,nrow=nrow(d_chm_cpd)))
m_pred_chm_cpd=apply(pRS_chm_cpd,2,median)

plot(m_pred_chm_cpd*100-100~chm_cpd_n,bty='l',type='n',ylab='',xlab='',ylim=c(-90,50),col='darkred',lwd=3,yaxt='n',xlim=c(min(chm_cpd_n),max(chm_cpd_n)))
axis(side=2,at=seq(-100,50,by=25))
abline(h=0,lwd=0.5,lty=5)
for(i in 1:nrow(d_chm_cpd)){
  lines(pRS_chm_cpd[i,]*100-100~chm_cpd_n,col=adjustcolor('darkgray',alpha.f = 0.01))
}
lines(m_pred_chm_cpd*100-100~chm_cpd_n,lwd=3,col=cols[1])


x_n_pk_eca=seq(min(pk10r$sqrt.ECA.std),max(pk10r$sqrt.ECA.std),length.out=100)
pk_eca_n=(x_n_pk_eca*sd(pk10r$sqrt.ECA)+mean(pk10r$sqrt.ECA))^2

d_alpha_pk_eca=data.frame(d_pk_eca[,grepl('alpha_t',colnames(d_pk_eca))])
dalpha0_pk_eca=apply(d_alpha_pk_eca,1,median)

pRS_pk_eca=exp(matrix(dalpha0_pk_eca,ncol=100,nrow=nrow(d_pk_eca))+as.matrix(d_pk_eca[,2])%*%x_n_pk_eca)/exp(matrix(dalpha0_pk_eca,ncol=100,nrow=nrow(d_pk_eca))+matrix(as.matrix(d_pk_eca[,2])%*%x_n_pk_eca[1],ncol=100,nrow=nrow(d_pk_eca)))
m_pred_pk_eca=apply(pRS_pk_eca,2,median)

plot(m_pred_pk_eca*100-100~pk_eca_n,bty='l',type='n',ylab='Change in productivity (R/S, %)',xlab='Equivalent Clearcut Area (% of watershed)',ylim=c(-100,50),col='darkred',lwd=3,yaxt='n',xlim=c(min(pk_eca_n*100),max(pk_eca_n*100)))
axis(side=2,at=seq(-100,50,by=25))
abline(h=0,lwd=0.5,lty=5)
for(i in 1:nrow(d_pk_eca)){
  lines(pRS_pk_eca[i,]*100-100~c(pk_eca_n*100),col=adjustcolor('darkgray',alpha.f = 0.01))
}
lines(m_pred_pk_eca*100-100~c(pk_eca_n*100),lwd=3,col=cols[2])
mtext(side=3,'Pink',font=2,at=2,line=0.5,col=cols[2],adj=0)

x_n_pk_cpd=seq(min(pk10r$sqrt.CPD.std),max(pk10r$sqrt.CPD.std),length.out=100)
pk_cpd_n=(x_n_pk_cpd*sd(pk10r$sqrt.CPD)+mean(pk10r$sqrt.CPD))^2

d_alpha_pk_cpd=data.frame(d_pk_cpd[,grepl('alpha_t',colnames(d_pk_cpd))])
dalpha0_pk_cpd=apply(d_alpha_pk_cpd,1,median)

pRS_pk_cpd=exp(matrix(dalpha0_pk_cpd,ncol=100,nrow=nrow(d_pk_cpd))+as.matrix(d_pk_cpd[,2])%*%x_n_pk_cpd)/exp(matrix(dalpha0_pk_cpd,ncol=100,nrow=nrow(d_pk_cpd))+matrix(as.matrix(d_pk_cpd[,2])%*%x_n_pk_cpd[1],ncol=100,nrow=nrow(d_pk_cpd)))
m_pred_pk_cpd=apply(pRS_pk_cpd,2,median)

plot(m_pred_pk_cpd*100-100~pk_cpd_n,bty='l',type='n',ylab='',xlab='Cumulative Disturbed Area (% of watershed)',ylim=c(-100,50),col='darkred',lwd=3,yaxt='n',xlim=c(min(pk_cpd_n),max(pk_cpd_n)))
axis(side=2,at=seq(-100,50,by=25))
abline(h=0,lwd=0.5,lty=5)
for(i in 1:nrow(d_pk_cpd)){
  lines(pRS_pk_cpd[i,]*100-100~pk_cpd_n,col=adjustcolor('darkgray',alpha.f = 0.01))
}
lines(m_pred_pk_cpd*100-100~pk_cpd_n,lwd=3,col=cols[2])



```


# Fig. 3. Ricker global (cross population) effects of ECA/CPD by species ####


# Fig. SX1. Coastwide productivity trends by species ####
```{r, fig. Sx1 - draft 1,fig.width=8,fig.height=12}
d_alpha_chm_cpd=data.frame(d_chm_eca[,grepl('alpha_t',colnames(d_chm_eca))])
d_alpha_pke_cpd=data.frame(d_pk_cpd[,grepl('alpha_t.1',colnames(d_pk_cpd))])
d_alpha_pko_cpd=data.frame(d_pk_cpd[,grepl('alpha_t.2',colnames(d_pk_cpd))])
cols=c('#018571','#993404','#d95f0e')

par(mfrow=c(2,1))

plot(c(0,12)~c(min(ch20r$BroodYear),max(ch20r$BroodYear)),type='n',bty='l',ylab='Coastwide mean productivity',xlab='Brood cohort year')
for(i in 1:nrow(d_alpha_chm_cpd)){
  lines(unlist(d_alpha_chm_cpd[i,])~seq(min(ch20r$BroodYear),max(ch20r$BroodYear)),col=adjustcolor('darkgray',alpha.f=0.03))
}
lines(apply(d_alpha_chm_cpd,2,median)~seq(min(ch20r$BroodYear),max(ch20r$BroodYear)),col=cols[1],lwd=2)
points(apply(d_alpha_chm_cpd,2,median)~seq(min(ch20r$BroodYear),max(ch20r$BroodYear)),col='white',bg=cols[1],cex=1.5,lwd=0.5,pch=21)
mtext(side=3,'Chum',font=2,line=0.5,col=cols[1],adj=0,at=2008)

plot(c(-2,5)~c(min(pk10r_e$BroodYear),max(pk10r_e$BroodYear)),type='n',bty='l',ylab='Coastwide mean productivity',xlab='Brood cohort year')
for(i in 1:nrow(d_alpha_chm_cpd)){
  lines(unlist(d_alpha_pke_cpd[i,])~seq(min(pk10r_e$BroodYear),max(pk10r_e$BroodYear),by=2),col=adjustcolor('darkgray',alpha.f=0.03))
}
for(i in 1:nrow(d_alpha_pko_cpd)){
  lines(unlist(d_alpha_pko_cpd[i,])~seq(min(pk10r_o$BroodYear),max(pk10r_o$BroodYear),by=2),col=adjustcolor('darkgray',alpha.f=0.03))
}
lines(apply(d_alpha_pke_cpd,2,median)~seq(min(pk10r_e$BroodYear),max(pk10r_e$BroodYear),by=2),col=cols[2],lwd=2)
lines(apply(d_alpha_pko_cpd,2,median)~seq(min(pk10r_o$BroodYear),max(pk10r_o$BroodYear),by=2),col=cols[3],lwd=2)
points(apply(d_alpha_pko_cpd,2,median)~seq(min(pk10r_o$BroodYear),max(pk10r_o$BroodYear),by=2),col='white',bg=cols[3],cex=1.5,lwd=0.5,pch=21)
points(apply(d_alpha_pke_cpd,2,median)~seq(min(pk10r_e$BroodYear),max(pk10r_e$BroodYear),by=2),col='white',bg=cols[2],cex=1.5,lwd=0.5,pch=21)
mtext(side=3,'Pink (even)',font=2,line=0.5,col=cols[2],adj=0,at=2008)
mtext(side=3,'Pink (odd)',font=2,line=-0.5,col=cols[3],adj=0,at=2008)



```


# Fig. SX2. Ricker vers. Coastwide productivity trends by species####

Time-varying coastwide productivity estimates from Ricker spawner-recruit fits:

```{r, fig. Sx1 - ricker,fig.width=8,fig.height=12}
d_chm_cpd=read.csv(here('stan models','outs','posterior','ric_chm_cpd_ac.csv'),check.names=F)
d_pk_cpd=read.csv(here('stan models','outs','posterior','ric_pk_cpd.csv'),check.names=F)

d_alpha_chm_cpd=data.frame(d_chm_cpd[,grepl('alpha_t',colnames(d_chm_cpd))])
d_alpha_pke_cpd=data.frame(d_pk_cpd[,grepl('alpha_t.1',colnames(d_pk_cpd))])
d_alpha_pko_cpd=data.frame(d_pk_cpd[,grepl('alpha_t.2',colnames(d_pk_cpd))])
cols=c('#018571','#993404','#d95f0e')

par(mfrow=c(2,1))

plot(c(-1,3)~c(min(ch20r$BroodYear),max(ch20r$BroodYear)),type='n',bty='l',ylab='Coastwide mean productivity',xlab='Brood cohort year')
for(i in 1:nrow(d_alpha_chm_cpd)){
  lines(unlist(d_alpha_chm_cpd[i,])~seq(min(ch20r$BroodYear),max(ch20r$BroodYear)),col=adjustcolor('darkgray',alpha.f=0.03))
}
lines(apply(d_alpha_chm_cpd,2,median)~seq(min(ch20r$BroodYear),max(ch20r$BroodYear)),col=cols[1],lwd=2)
points(apply(d_alpha_chm_cpd,2,median)~seq(min(ch20r$BroodYear),max(ch20r$BroodYear)),col='white',bg=cols[1],cex=1.5,lwd=0.5,pch=21)
mtext(side=3,'Chum',font=2,line=0.5,col=cols[1],adj=0,at=2008)

plot(c(-1,3)~c(min(pk10r_e$BroodYear),max(pk10r_e$BroodYear)),type='n',bty='l',ylab='Coastwide mean productivity',xlab='Brood cohort year')
for(i in 1:nrow(d_alpha_chm_cpd)){
  lines(unlist(d_alpha_pke_cpd[i,])~seq(min(pk10r_e$BroodYear),max(pk10r_e$BroodYear),by=2),col=adjustcolor('darkgray',alpha.f=0.03))
}
for(i in 1:nrow(d_alpha_pko_cpd)){
  lines(unlist(d_alpha_pko_cpd[i,])~seq(min(pk10r_o$BroodYear),max(pk10r_o$BroodYear),by=2),col=adjustcolor('darkgray',alpha.f=0.03))
}
lines(apply(d_alpha_pke_cpd,2,median)~seq(min(pk10r_e$BroodYear),max(pk10r_e$BroodYear),by=2),col=cols[2],lwd=2)
lines(apply(d_alpha_pko_cpd,2,median)~seq(min(pk10r_o$BroodYear),max(pk10r_o$BroodYear),by=2),col=cols[3],lwd=2)
points(apply(d_alpha_pko_cpd,2,median)~seq(min(pk10r_o$BroodYear),max(pk10r_o$BroodYear),by=2),col='white',bg=cols[3],cex=1.5,lwd=0.5,pch=21)
points(apply(d_alpha_pke_cpd,2,median)~seq(min(pk10r_e$BroodYear),max(pk10r_e$BroodYear),by=2),col='white',bg=cols[2],cex=1.5,lwd=0.5,pch=21)
mtext(side=3,'Pink (even)',font=2,line=0.5,col=cols[2],adj=0,at=2008)
mtext(side=3,'Pink (odd)',font=2,line=-0.5,col=cols[3],adj=0,at=2008)



```



# Fig. SX3. River-level variance in forestry effects####
```{r, fig. Sx2 - draft 1,fig.width=8,fig.height=11.50}
par(mfrow=c(2,2))
x_n_chm_eca=seq(min(ch20r$sqrt.ECA.std),max(ch20r$sqrt.ECA.std),length.out=100)
chm_eca_n=(x_n_chm_eca*sd(ch20r$sqrt.ECA)+mean(ch20r$sqrt.ECA))^2

d_alpha_chm_eca=data.frame(d_chm_eca[,grepl('alpha_t',colnames(d_chm_eca))])
dalpha0_chm_eca=apply(d_alpha_chm_eca,1,median)

pRS_chm_eca=exp(matrix(dalpha0_chm_eca,ncol=100,nrow=nrow(d_chm_eca))+as.matrix(d_chm_eca[,2])%*%x_n_chm_eca)/exp(matrix(dalpha0_chm_eca,ncol=100,nrow=nrow(d_chm_eca))+matrix(as.matrix(d_chm_eca[,2])%*%x_n_chm_eca[1],ncol=100,nrow=nrow(d_chm_eca)))
m_pred_chm_eca=apply(pRS_chm_eca,2,median)

plot(m_pred_chm_eca*100-100~chm_eca_n,bty='l',type='n',ylab='',xlab='Equivalent clearcut area (%)',ylim=c(-90,90),yaxt='n',xlim=c(min(chm_eca_n*100),max(chm_eca_n*100)))
axis(side=2,at=seq(-90,90,by=15))
abline(h=0,lwd=0.5,lty=5)
for(c in 1:length(unique(ch20r$River))){
  jj=subset(ch20r,River==levels(factor(ch20r$River))[c])
  x_nc=seq(min(jj$sqrt.ECA.std),max(jj$sqrt.ECA.std),length.out=100)
  eca_nc=(x_nc*sd(ch20r$sqrt.ECA)+mean(ch20r$sqrt.ECA))^2

   pRSc=exp(matrix(dalpha0_chm_eca,ncol=100,nrow=nrow(d_chm_eca))+matrix(d_chm_eca[,colnames(d_chm_eca)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d_chm_eca))+matrix(d_chm_eca[,colnames(d_chm_eca)==paste('b_for_rv[',c,']',sep='')])%*%x_nc)/exp(matrix(dalpha0_chm_eca,ncol=100,nrow=nrow(d_chm_eca))+matrix(d_chm_eca[,colnames(d_chm_eca)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d_chm_eca))+matrix(d_chm_eca[,colnames(d_chm_eca)==paste('b_for_rv[',c,']',sep='')],ncol=100,nrow=nrow(d_chm_eca))*x_n_chm_eca[1])
 
  lines(apply(pRSc,2,median)*100-100~c(eca_nc*100),col=adjustcolor('black',alpha.f=0.5))
  
}
lines(m_pred_chm_eca*100-100~c(chm_eca_n*100),lwd=3,col=cols[1])
mtext(side=3,'Chum',font=2,at=2,line=0.5,col=cols[1],adj=0)

x_n_chm_cpd=seq(min(ch20r$sqrt.CPD.std),max(ch20r$sqrt.CPD.std),length.out=100)
chm_cpd_n=(x_n_chm_cpd*sd(ch20r$sqrt.CPD)+mean(ch20r$sqrt.CPD))^2

d_alpha_chm_cpd=data.frame(d_chm_cpd[,grepl('alpha_t',colnames(d_chm_cpd))])
dalpha0_chm_cpd=apply(d_alpha_chm_cpd,1,median)

pRS_chm_cpd=exp(matrix(dalpha0_chm_cpd,ncol=100,nrow=nrow(d_chm_cpd))+as.matrix(d_chm_cpd[,2])%*%x_n_chm_cpd)/exp(matrix(dalpha0_chm_cpd,ncol=100,nrow=nrow(d_chm_cpd))+matrix(as.matrix(d_chm_cpd[,2])%*%x_n_chm_cpd[1],ncol=100,nrow=nrow(d_chm_cpd)))
m_pred_chm_cpd=apply(pRS_chm_cpd,2,median)

plot(m_pred_chm_cpd*100-100~chm_cpd_n,bty='l',type='n',ylab='',xlab='Cumulative disturbed area (%)',ylim=c(-90,80),col='darkred',lwd=3,yaxt='n',xlim=c(min(chm_cpd_n),max(chm_cpd_n)))
axis(side=2,at=seq(-90,90,by=15))
abline(h=0,lwd=0.5,lty=5)
for(c in 1:length(unique(ch20r$River))){
  jj=subset(ch20r,River==levels(factor(ch20r$River))[c])
  x_nc=seq(min(jj$sqrt.CPD.std),max(jj$sqrt.CPD.std),length.out=100)
  cpd_nc=(x_nc*sd(ch20r$sqrt.CPD)+mean(ch20r$sqrt.CPD))^2

   pRSc=exp(matrix(dalpha0_chm_cpd,ncol=100,nrow=nrow(d_chm_cpd))+matrix(d_chm_cpd[,colnames(d_chm_cpd)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d_chm_cpd))+matrix(d_chm_cpd[,colnames(d_chm_cpd)==paste('b_for_rv[',c,']',sep='')])%*%x_nc)/exp(matrix(dalpha0_chm_cpd,ncol=100,nrow=nrow(d_chm_cpd))+matrix(d_chm_cpd[,colnames(d_chm_cpd)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d_chm_cpd))+matrix(d_chm_cpd[,colnames(d_chm_cpd)==paste('b_for_rv[',c,']',sep='')],ncol=100,nrow=nrow(d_chm_cpd))*x_n_chm_cpd[1])
 
  lines(apply(pRSc,2,median)*100-100~cpd_nc,col=adjustcolor('black',alpha.f=0.5))
  
}
lines(m_pred_chm_cpd*100-100~chm_cpd_n,lwd=3,col=cols[1])

x_n_pk_eca=seq(min(pk10r_e$sqrt.ECA.std),max(pk10r_e$sqrt.ECA.std),length.out=100)
pk_eca_n=(x_n_pk_eca*sd(pk10r_e$sqrt.ECA)+mean(pk10r_e$sqrt.ECA))^2

d_alpha_pk_eca=data.frame(d_pk_eca[,grepl('alpha_t',colnames(d_pk_eca))])
dalpha0_pk_eca=apply(d_alpha_pk_eca,1,median)

pRS_pk_eca=exp(matrix(dalpha0_pk_eca,ncol=100,nrow=nrow(d_pk_eca))+as.matrix(d_pk_eca[,2])%*%x_n_pk_eca)/exp(matrix(dalpha0_pk_eca,ncol=100,nrow=nrow(d_pk_eca))+matrix(as.matrix(d_pk_eca[,2])%*%x_n_pk_eca[1],ncol=100,nrow=nrow(d_pk_eca)))
m_pred_pk_eca=apply(pRS_pk_eca,2,median)

plot(m_pred_pk_eca*100-100~pk_eca_n,bty='l',type='n',ylab='Change in productivity (R/S, %)',xlab='Equivalent clearcut area (%)',ylim=c(-10,50),col='darkred',lwd=3,yaxt='n',xlim=c(min(pk_eca_n*100),max(pk_eca_n*100)))
axis(side=2,at=seq(-10,50,by=10))
abline(h=0,lwd=0.5,lty=5)
for(c in 1:length(unique(pk10r_e$River))){
  jj=subset(pk10r_e,River==levels(factor(pk10r_e$River))[c])
  x_nc=seq(min(jj$sqrt.ECA.std),max(jj$sqrt.ECA.std),length.out=100)
  eca_nc=(x_nc*sd(pk10r_e$sqrt.ECA)+mean(pk10r_e$sqrt.ECA))^2

   pRSc=exp(matrix(dalpha0_pk_eca,ncol=100,nrow=nrow(d_pk_eca))+matrix(d_pk_eca[,colnames(d_pk_eca)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d_pk_eca))+matrix(d_pk_eca[,colnames(d_pk_eca)==paste('b_for_rv[',c,']',sep='')])%*%x_nc)/exp(matrix(dalpha0_pk_eca,ncol=100,nrow=nrow(d_pk_eca))+matrix(d_pk_eca[,colnames(d_pk_eca)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d_pk_eca))+matrix(d_pk_eca[,colnames(d_pk_eca)==paste('b_for_rv[',c,']',sep='')],ncol=100,nrow=nrow(d_pk_eca))*x_n_pk_eca[1])
 
  lines(apply(pRSc,2,median)*100-100~c(eca_nc*100),col=adjustcolor('black',alpha.f=0.5))
  
}
lines(m_pred_pk_eca*100-100~c(pk_eca_n*100),lwd=3,col=cols[2])
mtext(side=3,'Pink',font=2,at=2,line=0.5,col=cols[2],adj=0)

x_n_pk_cpd=seq(min(pk10r_e$sqrt.CPD.std),max(pk10r_e$sqrt.CPD.std),length.out=100)
pk_cpd_n=(x_n_pk_cpd*sd(pk10r_e$sqrt.CPD)+mean(pk10r_e$sqrt.CPD))^2

d_alpha_pk_cpd=data.frame(d_pk_cpd[,grepl('alpha_t',colnames(d_pk_cpd))])
dalpha0_pk_cpd=apply(d_alpha_pk_cpd,1,median)

pRS_pk_cpd=exp(matrix(dalpha0_pk_cpd,ncol=100,nrow=nrow(d_pk_cpd))+as.matrix(d_pk_cpd[,2])%*%x_n_pk_cpd)/exp(matrix(dalpha0_pk_cpd,ncol=100,nrow=nrow(d_pk_cpd))+matrix(as.matrix(d_pk_cpd[,2])%*%x_n_pk_cpd[1],ncol=100,nrow=nrow(d_pk_cpd)))
m_pred_pk_cpd=apply(pRS_pk_cpd,2,median)

plot(m_pred_pk_cpd*100-100~pk_cpd_n,bty='l',type='n',ylab='',xlab='Cumulative disturbed area (%)',ylim=c(-10,50),yaxt='n',xlim=c(min(pk_cpd_n),max(pk_cpd_n)))
axis(side=2,at=seq(-10,50,by=10))
abline(h=0,lwd=0.5,lty=5)
for(c in 1:length(unique(pk10r_e$River))){
  jj=subset(pk10r_e,River==levels(factor(pk10r_e$River))[c])
  x_nc=seq(min(jj$sqrt.CPD.std),max(jj$sqrt.CPD.std),length.out=100)
  cpd_nc=(x_nc*sd(pk10r_e$sqrt.CPD)+mean(pk10r_e$sqrt.CPD))^2

   pRSc=exp(matrix(dalpha0_pk_cpd,ncol=100,nrow=nrow(d_pk_cpd))+matrix(d_pk_cpd[,colnames(d_pk_cpd)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d_pk_cpd))+matrix(d_pk_cpd[,colnames(d_pk_cpd)==paste('b_for_rv[',c,']',sep='')])%*%x_nc)/exp(matrix(dalpha0_pk_cpd,ncol=100,nrow=nrow(d_pk_cpd))+matrix(d_pk_cpd[,colnames(d_pk_cpd)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d_pk_cpd))+matrix(d_pk_cpd[,colnames(d_pk_cpd)==paste('b_for_rv[',c,']',sep='')],ncol=100,nrow=nrow(d_pk_cpd))*x_n_pk_cpd[1])
 
  lines(apply(pRSc,2,median)*100-100~cpd_nc,col=adjustcolor('black',alpha.f=0.5))
  
}
lines(m_pred_pk_cpd*100-100~pk_cpd_n,lwd=3,col=cols[2])

```

# Fig. SX3. Ricker v. River-level variance in forestry effects ####

Visualization of the river-specific responses to cumulative forest loss for Chum and Pink salmon.

```{r, fig. Sx2 - ricker,fig.width=8,fig.height=11.50}
d_chm_cpd=read.csv(here('stan models','outs','posterior','ric_chm_cpd_ac.csv'),check.names=F)
d_pk_cpd=read.csv(here('stan models','outs','posterior','ric_pk_cpd.csv'),check.names=F)

par(mfrow=c(1,2))

x_n_chm_cpd=seq(min(ch20r$sqrt.CPD.std),max(ch20r$sqrt.CPD.std),length.out=100)
chm_cpd_n=(x_n_chm_cpd*sd(ch20r$sqrt.CPD)+mean(ch20r$sqrt.CPD))^2

d_alpha_chm_cpd=data.frame(d_chm_cpd[,grepl('alpha_t',colnames(d_chm_cpd))])
dalpha0_chm_cpd=apply(d_alpha_chm_cpd,1,median)

pRS_chm_cpd=exp(matrix(dalpha0_chm_cpd,ncol=100,nrow=nrow(d_chm_cpd))+as.matrix(d_chm_cpd[,2])%*%x_n_chm_cpd)/exp(matrix(dalpha0_chm_cpd,ncol=100,nrow=nrow(d_chm_cpd))+matrix(as.matrix(d_chm_cpd[,2])%*%x_n_chm_cpd[1],ncol=100,nrow=nrow(d_chm_cpd)))
m_pred_chm_cpd=apply(pRS_chm_cpd,2,median)

plot(m_pred_chm_cpd*100-100~chm_cpd_n,bty='l',type='n',ylab='Percent change in productivity (recruits/spawner)',xlab='Cumulative disturbed area (%)',ylim=c(-20,20),col='darkred',lwd=3,yaxt='n',xlim=c(min(chm_cpd_n),max(chm_cpd_n)))
axis(side=2,at=seq(-20,20,by=10))
abline(h=0,lwd=0.5,lty=5)
for(c in 1:length(unique(ch20r$River))){
  jj=subset(ch20r,River==levels(factor(ch20r$River))[c])
  x_nc=seq(min(jj$sqrt.CPD.std),max(jj$sqrt.CPD.std),length.out=100)
  cpd_nc=(x_nc*sd(ch20r$sqrt.CPD)+mean(ch20r$sqrt.CPD))^2

   pRSc=exp(matrix(dalpha0_chm_cpd,ncol=100,nrow=nrow(d_chm_cpd))+matrix(d_chm_cpd[,colnames(d_chm_cpd)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d_chm_cpd))+matrix(d_chm_cpd[,colnames(d_chm_cpd)==paste('b_for_rv[',c,']',sep='')])%*%x_nc)/exp(matrix(dalpha0_chm_cpd,ncol=100,nrow=nrow(d_chm_cpd))+matrix(d_chm_cpd[,colnames(d_chm_cpd)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d_chm_cpd))+matrix(d_chm_cpd[,colnames(d_chm_cpd)==paste('b_for_rv[',c,']',sep='')],ncol=100,nrow=nrow(d_chm_cpd))*x_n_chm_cpd[1])
 
  lines(apply(pRSc,2,median)*100-100~cpd_nc,col=adjustcolor('black',alpha.f=0.5))
  
}
lines(m_pred_chm_cpd*100-100~chm_cpd_n,lwd=3,col=cols[1])
mtext(side=3,'Chum',font=2,at=2,line=0.5,col=cols[1],adj=0)


x_n_pk_cpd=seq(min(pk10r_e$sqrt.CPD.std),max(pk10r_e$sqrt.CPD.std),length.out=100)
pk_cpd_n=(x_n_pk_cpd*sd(pk10r_e$sqrt.CPD)+mean(pk10r_e$sqrt.CPD))^2

d_alpha_pk_cpd=data.frame(d_pk_cpd[,grepl('alpha_t',colnames(d_pk_cpd))])
dalpha0_pk_cpd=apply(d_alpha_pk_cpd,1,median)

pRS_pk_cpd=exp(matrix(dalpha0_pk_cpd,ncol=100,nrow=nrow(d_pk_cpd))+as.matrix(d_pk_cpd[,2])%*%x_n_pk_cpd)/exp(matrix(dalpha0_pk_cpd,ncol=100,nrow=nrow(d_pk_cpd))+matrix(as.matrix(d_pk_cpd[,2])%*%x_n_pk_cpd[1],ncol=100,nrow=nrow(d_pk_cpd)))
m_pred_pk_cpd=apply(pRS_pk_cpd,2,median)

plot(m_pred_pk_cpd*100-100~pk_cpd_n,bty='l',type='n',ylab='',xlab='Cumulative disturbed area (%)',ylim=c(-10,50),yaxt='n',xlim=c(min(pk_cpd_n),max(pk_cpd_n)))
axis(side=2,at=seq(-10,50,by=10))
abline(h=0,lwd=0.5,lty=5)
for(c in 1:length(unique(pk10r_e$River))){
  jj=subset(pk10r_e,River==levels(factor(pk10r_e$River))[c])
  x_nc=seq(min(jj$sqrt.CPD.std),max(jj$sqrt.CPD.std),length.out=100)
  cpd_nc=(x_nc*sd(pk10r_e$sqrt.CPD)+mean(pk10r_e$sqrt.CPD))^2

   pRSc=exp(matrix(dalpha0_pk_cpd,ncol=100,nrow=nrow(d_pk_cpd))+matrix(d_pk_cpd[,colnames(d_pk_cpd)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d_pk_cpd))+matrix(d_pk_cpd[,colnames(d_pk_cpd)==paste('b_for_rv[',c,']',sep='')])%*%x_nc)/exp(matrix(dalpha0_pk_cpd,ncol=100,nrow=nrow(d_pk_cpd))+matrix(d_pk_cpd[,colnames(d_pk_cpd)==paste('alpha_j[',c,']',sep='')],ncol=100,nrow=nrow(d_pk_cpd))+matrix(d_pk_cpd[,colnames(d_pk_cpd)==paste('b_for_rv[',c,']',sep='')],ncol=100,nrow=nrow(d_pk_cpd))*x_n_pk_cpd[1])
 
  lines(apply(pRSc,2,median)*100-100~cpd_nc,col=adjustcolor('black',alpha.f=0.5))
  
}
lines(m_pred_pk_cpd*100-100~pk_cpd_n,lwd=3,col=cols[2])
mtext(side=3,'Pink',font=2,at=2,line=0.5,col=cols[2],adj=0)

```

# Fig. SX3. Response to forestry vs. scale of forestry in watershed####
```{r, fig. Sx3 - draft 1,fig.width=8,fig.height=11.50}
par(mfrow=c(2,2))
rv_chm=ch20r %>% group_by(River) %>% summarize(m.ECA=mean(ECA_age_proxy_forested_only),
                                               min.ECA=min(ECA_age_proxy_forested_only),
                                               max.ECA=max(ECA_age_proxy_forested_only),
                                               m.CPD=mean(disturbedarea_prct_cs),
                                               min.CPD=min(disturbedarea_prct_cs),
                                               max.CPD=max(disturbedarea_prct_cs))

chm_bfor_eca=data.frame(d_chm_eca[,grepl('b_for_rv',colnames(d_chm_eca))])
chmeca_mn=apply(chm_bfor_eca,2,quantile,0.05)
chmeca_mx=apply(chm_bfor_eca,2,quantile,0.95)


plot(apply(chm_bfor_eca,2,median)~rv_chm$m.ECA,type='n',ylim=c(min(chmeca_mn),max(chmeca_mx)),xlab='Mean ECA by river')
for(n in 1:ncol(chm_bfor_eca)){
  lines(c(quantile(chm_bfor_eca[,n],0.05),quantile(chm_bfor_eca[,n],0.95))~rep(rv_chm$m.ECA[n],2),col=adjustcolor('darkgray',alpha.f=0.5))
}  
points(apply(chm_bfor_eca,2,median)~rv_chm$m.ECA,col=adjustcolor('black',alpha.f=0.9))

chm_bfor_cpd=data.frame(d_chm_cpd[,grepl('b_for_rv',colnames(d_chm_cpd))])
chmcpd_mn=apply(chm_bfor_cpd,2,quantile,0.05)
chmcpd_mx=apply(chm_bfor_cpd,2,quantile,0.95)

plot(apply(chm_bfor_cpd,2,median)~rv_chm$m.CPD,type='n',ylim=c(min(chmcpd_mn),max(chmcpd_mx)),xlab='Mean CPD by river')
for(n in 1:ncol(chm_bfor_cpd)){
  lines(c(quantile(chm_bfor_cpd[,n],0.05),quantile(chm_bfor_cpd[,n],0.95))~rep(rv_chm$m.CPD[n],2),col=adjustcolor('darkgray',alpha.f=0.5))
}  
points(apply(chm_bfor_cpd,2,median)~rv_chm$m.CPD,col=adjustcolor('black',alpha.f=0.9))


rv_pk=pk10r %>% group_by(River) %>% summarize(m.ECA=mean(ECA_age_proxy_forested_only),
                                               min.ECA=min(ECA_age_proxy_forested_only),
                                               max.ECA=max(ECA_age_proxy_forested_only),
                                               m.CPD=mean(disturbedarea_prct_cs),
                                               min.CPD=min(disturbedarea_prct_cs),
                                               max.CPD=max(disturbedarea_prct_cs))


pk_bfor_eca=data.frame(d_pk_eca[,grepl('b_for_rv',colnames(d_pk_eca))])
pkeca_mn=apply(pk_bfor_eca,2,quantile,0.05)
pkeca_mx=apply(pk_bfor_eca,2,quantile,0.95)

plot(apply(pk_bfor_eca,2,median)~rv_pk$m.ECA,type='n',ylim=c(min(pkeca_mn),max(pkeca_mx)),xlab='Mean ECA by river')
for(n in 1:ncol(pk_bfor_eca)){
  lines(c(quantile(pk_bfor_eca[,n],0.05),quantile(pk_bfor_eca[,n],0.95))~rep(rv_pk$m.ECA[n],2),col=adjustcolor('darkgray',alpha.f=0.5))
}  
points(apply(pk_bfor_eca,2,median)~rv_pk$m.ECA,col=adjustcolor('black',alpha.f=0.9))

pk_bfor_cpd=data.frame(d_pk_cpd[,grepl('b_for_rv',colnames(d_pk_cpd))])
pkcpd_mn=apply(pk_bfor_cpd,2,quantile,0.05)
pkcpd_mx=apply(pk_bfor_cpd,2,quantile,0.95)

plot(apply(pk_bfor_cpd,2,median)~rv_pk$m.CPD,type='n',ylim=c(min(pkcpd_mn),max(pkcpd_mx)),xlab='Mean CPD by river')
for(n in 1:ncol(pk_bfor_cpd)){
  lines(c(quantile(pk_bfor_cpd[,n],0.05),quantile(pk_bfor_cpd[,n],0.95))~rep(rv_pk$m.CPD[n],2),col=adjustcolor('darkgray',alpha.f=0.5))
}  
points(apply(pk_bfor_cpd,2,median)~rv_pk$m.CPD,col=adjustcolor('black',alpha.f=0.9))

```



# Chum south coast CUs - effects of ECA/CPD ####

Effect sizes when including South Coast CU (CM-14) - with 21 rivers.

```{r, south coast, fig.width=11,fig.height=8}

ch20rsc <-read.csv("../origional-ecofish-data-models/Data/Processed/chum_SR_20_hat_yr.csv")

d_chm_eca=read.csv(here('stan models','outs','posterior','bh_chm_eca_sc.csv'),check.names=F)
d_chm_cpd=read.csv(here('stan models','outs','posterior','bh_chm_cpd_sc.csv'),check.names=F)

cols=c('#018571')
par(mfrow=c(3,2))
x_n_chm_eca=seq(min(ch20r$sqrt.ECA.std),max(ch20r$sqrt.ECA.std),length.out=100)
chm_eca_n=(x_n_chm_eca*sd(ch20r$sqrt.ECA)+mean(ch20r$sqrt.ECA))^2

d_alpha_chm_eca=data.frame(d_chm_eca[,grepl('alpha_t',colnames(d_chm_eca))])
dalpha0_chm_eca=apply(d_alpha_chm_eca,1,median)

pRS_chm_eca=exp(matrix(dalpha0_chm_eca,ncol=100,nrow=nrow(d_chm_eca))+as.matrix(d_chm_eca[,2])%*%x_n_chm_eca)/exp(matrix(dalpha0_chm_eca,ncol=100,nrow=nrow(d_chm_eca))+matrix(as.matrix(d_chm_eca[,2])%*%x_n_chm_eca[1],ncol=100,nrow=nrow(d_chm_eca)))
m_pred_chm_eca=apply(pRS_chm_eca,2,median)

plot(m_pred_chm_eca*100-100~chm_eca_n,bty='l',type='n',ylab='Change in productivity (R/S, %)',xlab='',ylim=c(-100,50),col='darkred',lwd=3,yaxt='n',xlim=c(min(chm_eca_n*100),max(chm_eca_n*100)))
axis(side=2,at=seq(-100,50,by=25))
abline(h=0,lwd=0.5,lty=5)
for(i in 1:nrow(d_chm_eca)){
  lines(pRS_chm_eca[i,]*100-100~c(chm_eca_n*100),col=adjustcolor('darkgray',alpha.f = 0.01))
}
lines(m_pred_chm_eca*100-100~c(chm_eca_n*100),lwd=3,col=cols[1])
mtext(side=3,'Chum',font=2,at=2,line=0.5,col=cols[1],adj=0)

x_n_chm_cpd=seq(min(ch20r$sqrt.CPD.std),max(ch20r$sqrt.CPD.std),length.out=100)
chm_cpd_n=(x_n_chm_cpd*sd(ch20r$sqrt.CPD)+mean(ch20r$sqrt.CPD))^2

d_alpha_chm_cpd=data.frame(d_chm_cpd[,grepl('alpha_t',colnames(d_chm_cpd))])
dalpha0_chm_cpd=apply(d_alpha_chm_cpd,1,median)

pRS_chm_cpd=exp(matrix(dalpha0_chm_cpd,ncol=100,nrow=nrow(d_chm_cpd))+as.matrix(d_chm_cpd[,2])%*%x_n_chm_cpd)/exp(matrix(dalpha0_chm_cpd,ncol=100,nrow=nrow(d_chm_cpd))+matrix(as.matrix(d_chm_cpd[,2])%*%x_n_chm_cpd[1],ncol=100,nrow=nrow(d_chm_cpd)))
m_pred_chm_cpd=apply(pRS_chm_cpd,2,median)

plot(m_pred_chm_cpd*100-100~chm_cpd_n,bty='l',type='n',ylab='',xlab='',ylim=c(-90,50),col='darkred',lwd=3,yaxt='n',xlim=c(min(chm_cpd_n),max(chm_cpd_n)))
axis(side=2,at=seq(-100,50,by=25))
abline(h=0,lwd=0.5,lty=5)
for(i in 1:nrow(d_chm_cpd)){
  lines(pRS_chm_cpd[i,]*100-100~chm_cpd_n,col=adjustcolor('darkgray',alpha.f = 0.01))
}
lines(m_pred_chm_cpd*100-100~chm_cpd_n,lwd=3,col=cols[1])


d_rv=d_chm_eca[,grepl('b_for_rv',colnames(d_chm_eca))]
cu=distinct(ch20rsc,River,.keep_all = T)
sc_cu=subset(cu,CU %in% c('CM-4'))
jj=as.numeric(rownames(cu[cu$CU=='CM-4',]))

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='ECA effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d_chm_eca[,2],bw=0.02)
abline(v=0,lwd=2)
for(j in 1:ncol(d_rv)){ #22 cus
  d=density(d_rv[,j],bw=0.02)
  lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)

for(j in 1:nrow(sc_cu)){ 
  d=density(d_rv[,jj[j]],bw=0.02)
  lines(d$y~d$x,col=adjustcolor('darkblue',alpha.f=0.8))
}

d_rv=d_chm_cpd[,grepl('b_for_rv',colnames(d_chm_cpd))]
cu=distinct(ch20rsc,River,.keep_all = T)
sc_cu=subset(cu,CU %in% c('CM-4'))
jj=as.numeric(rownames(cu[cu$CU=='CM-4',]))

plot(c(0,10)~c(-2,2),bty='l',type='n',ylab='Posterior density',main='CPD effect sizes by River',ylim=c(0,10),yaxt='n',xlab='Standardized coefficients')
d0eca=density(d_chm_cpd[,2],bw=0.02)
abline(v=0,lwd=2)
for(j in 1:ncol(d_rv)){ #22 cus
  d=density(d_rv[,j],bw=0.02)
  lines(d$y~d$x,col=adjustcolor('darkgray',alpha.f=0.2))
}
lines(d0eca$y~d0eca$x,col='darkred',lwd=3)

for(j in 1:nrow(sc_cu)){ 
  d=density(d_rv[,jj[j]],bw=0.02)
  lines(d$y~d$x,col=adjustcolor('darkblue',alpha.f=0.8))
}


par(mfrow=c(1,2))
hist(d_chm_eca[,2],breaks=30,main='ECA',xlab='effect size')
hist(d_chm_cpd[,2],breaks=30,main='CPD',xlab='effect size')

```


# Forestry metrics by river, CU, and watershed area

The third set of models includes watershed area as a mediator of the effect of ECA on productivity:

$log(R_{t,r}/S_{t,r}) = \alpha_r - \beta_r*S_{t,r} + \beta_{eca,c}*ECA_{t,r} + \beta_{eca-x-area,c}*ECA_{t,r}*Area_{r} + w_{t,r}$

## Chum

This is the distribution of watershed area among 295 rivers with Chum surveys:

```{r, watershed area chm}
par(mfrow=c(1,1))
da=distinct(ch20r,River,.keep_all = T)
hist(log10(da$area_km2),xlab='Watershed area (km2)',xaxt='n',main='',breaks=30,xlim=c(0,log10(1e4)))
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

#da=da[order(da$area_km2),]
```

The range of observed ECAs can vary substantially by rivers and CUs:

```{r, chm eca range}
plot(rep(1,nrow(da))~seq(1,295),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(ch20r,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}

cu=distinct(ch20r,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,22),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(ch20r,CU==cu$CU[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(ch20r,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

The same plots for the Cumulative % Disturbed metric:

```{r, chm cpd range}
plot(rep(1,nrow(da))~seq(1,295),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(ch20r,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}

cu=distinct(ch20r,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,22),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(ch20r,CU==cu$CU[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(ch20r,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

## Pink Even

This is the distribution of watershed area among 336 rivers with Pink surveys:

```{r, watershed area pke}
da=distinct(pk10r_o,River,.keep_all = T)
hist(log10(da$area_km2),xlab='Watershed area (km2)',xaxt='n',main='',breaks=30,xlim=c(0,log10(1e4)))
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

#da=da[order(da$area_km2),]
```

The range of observed ECAs can vary substantially by rivers and CUs:

```{r, pke eca range}
plot(rep(1,nrow(da))~seq(1,nrow(da)),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}

cu=distinct(pk10r_o,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,nrow(cu)),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(pk10r_o,CU==cu$CU[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

The same plots for the Cumulative % Disturbed metric:

```{r, pke cpd range}
plot(rep(1,nrow(da))~seq(1,nrow(da)),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}

cu=distinct(pk10r_o,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,nrow(cu)),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(pk10r_o,CU==cu$CU[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

## Pink Odd

This is the distribution of watershed area among 251 rivers with Pink (odd) surveys:

```{r, watershed area pko}
da=distinct(pk10r_o,River,.keep_all = T)
hist(log10(da$area_km2),xlab='Watershed area (km2)',xaxt='n',main='',breaks=30,xlim=c(0,log10(1e4)))
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

#da=da[order(da$area_km2),]
```

The range of observed ECAs can vary substantially by rivers and CUs:

```{r, pko eca range}
plot(rep(1,nrow(da))~seq(1,nrow(da)),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}

cu=distinct(pk10r_o,CU,.keep_all = T)
plot(rep(1,nrow(cu))~seq(1,nrow(cu)),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in CU-level time-series',bty='l',xlab='')
for(i in 1:nrow(cu)){
 s=subset(pk10r_o,CU==cu$CU[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(i,2))
}


plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,1),ylab='Range of ECA observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$ECA_age_proxy_forested_only),max(s$ECA_age_proxy_forested_only))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

The same plots for the Cumulative % Disturbed metric:

```{r, pko cpd range}
plot(rep(1,nrow(da))~seq(1,nrow(da)),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='')
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(i,2))
}



plot(rep(1,nrow(da))~log10(da$area_km2),type='n',xaxt='n',ylim=c(0,100),ylab='Range of CPD observations in River-level time-series',bty='l',xlab='Watershed area (km2)',xlim=c(0,log10(1e4)))
for(i in 1:nrow(da)){
 s=subset(pk10r_o,River==da$River[i])
 lines(c(min(s$disturbedarea_prct_cs),max(s$disturbedarea_prct_cs))~rep(unique(log10(s$area_km2)),2))
}
pow <- 0:5
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

\newpage




# River-level Spawner-Recruit fits
Here is each river-level stock-recruitment curve comparing estimates with ECA or CPD. The observations are shaded according to their ECA/CPD level (brown = higher ECA, green = lower ECA; scaled to each S-R series). The median expected recruits and their 90% credible intervals are displayed as black solid and dashed lines. The expected recruits at minimum and maximum observed ECA/CPD values for that river are shown in brown and green lines, respectively. The time-series for ECA (bottom-left) is shown with the realized effect on productivity under each model (ECA = blue; CPD = orange; bottom-right).

## Chum

```{r, sr time-series chm ric, fig.width=12,fig.height=8, results="asis"}

d1eca=read.csv(here('stan models','outs','posterior','bh_chm_eca.csv'),check.names=F)
d1cpd=read.csv(here('stan models','outs','posterior','bh_chm_cpd.csv'),check.names=F)
r1eca=read.csv(here('stan models','outs','posterior','ric_chm_eca.csv'),check.names=F)
r1cpd=read.csv(here('stan models','outs','posterior','ric_chm_cpd.csv'),check.names=F)

for(c in 1:length(unique(ch20r$River))){
  cat('\n')  
  cat("### ", levels(factor(ch20r$River))[c], "\n")
  #CU header
  rv=subset(ch20r,River==levels(factor(ch20r$River))[c])
   cols= rev(RColorBrewer::brewer.pal(9,'BrBG'));
   br1=quantile(rv$ECA_age_proxy_forested_only,probs=seq(0,1,length.out=8))
   col_points1=adjustcolor(cols[findInterval(rv$ECA_age_proxy_forested_only,br1)],alpha.f=0.8)
   br2=quantile(rv$disturbedarea_prct_cs,probs=seq(0,1,length.out=8))
   col_points2=adjustcolor(cols[findInterval(rv$disturbedarea_prct_cs,br2)],alpha.f=0.8)
   
  par(mfrow=c(3,2))
  
  
  #ECA
   plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(ECA)',sep=' '))
  
  alpha_t=apply(d1eca[,grepl('alpha_t',colnames(d1eca))==T],1,median)
  alpha_j=d1eca[,colnames(d1eca)== paste('alpha_j[',c,']',sep='')]
  Rk_j=d1eca[,colnames(d1eca)== paste('Rk[',c,']',sep='')]
  b_ECA=d1eca[,colnames(d1eca)== paste('b_for_rv[',c,']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j+alpha_t)/Rk_j)%*%s_pred),2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j+alpha_t)/Rk_j)%*%s_pred),2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j+alpha_t)/Rk_j)%*%s_pred),2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j+alpha_t)/Rk_j)%*%s_pred)+matrix(b_ECA*min(rv$sqrt.ECA.std),ncol=length(s_pred),nrow=length(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j+alpha_t)/Rk_j)%*%s_pred)+matrix(b_ECA*max(rv$sqrt.ECA.std),ncol=length(s_pred),nrow=length(alpha_j+alpha_t)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points1,pch=21,cex=1.5) 
  
  #CPD
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main=paste(unique(rv$River),'(CPD)',sep=' '))
  
   alpha_t=apply(d1cpd[,grepl('alpha_t',colnames(d1cpd))==T],1,median)
  alpha_j=d1cpd[,colnames(d1cpd)== paste('alpha_j[',c,']',sep='')]
  Rk_j=d1cpd[,colnames(d1cpd)== paste('Rk[',c,']',sep='')]
  b_ECA=d1cpd[,colnames(d1cpd)==paste('b_for_rv[',c,']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
   RS_pred_m=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j+alpha_t)/Rk_j)%*%s_pred),2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j+alpha_t)/Rk_j)%*%s_pred),2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j+alpha_t)/Rk_j)%*%s_pred),2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j+alpha_t)/Rk_j)%*%s_pred)+matrix(b_ECA*min(rv$sqrt.CPD.std),ncol=length(s_pred),nrow=length(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-log(1+as.matrix(exp(alpha_j+alpha_t)/Rk_j)%*%s_pred)+matrix(b_ECA*max(rv$sqrt.CPD.std),ncol=length(s_pred),nrow=length(alpha_j)),2,median))*s_pred
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points2,pch=24,cex=1.5) 
  
    #ECA
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main='Ricker fit (ECA)')
  
  alpha_t=apply(r1eca[,grepl('alpha_t',colnames(r1eca))==T],1,median)
  alpha_j=r1eca[,colnames(r1eca)== paste('alpha_j[',c,']',sep='')]
  smax_j=r1eca[,colnames(r1eca)== paste('S_max[',c,']',sep='')]
  b_ECA=r1eca[,colnames(r1eca)== paste('b_for_rv[',c,']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
  RS_pred_m=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-as.matrix(1/smax_j)%*%s_pred,2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-as.matrix(1/smax_j)%*%s_pred,2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-as.matrix(1/smax_j)%*%s_pred,2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-as.matrix(1/smax_j)%*%s_pred+matrix(b_ECA*min(rv$sqrt.ECA.std),ncol=length(s_pred),nrow=length(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-as.matrix(1/smax_j)%*%s_pred+matrix(b_ECA*max(rv$sqrt.ECA.std),ncol=length(s_pred),nrow=length(alpha_j)),2,median))*s_pred
  
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points1,pch=24,cex=1.5) 
  
  #CPD
  plot(Recruits~Spawners,data=rv,xlim=c(0,max(rv$Spawners)),ylim=c(0,max(rv$Recruits)),bty='l',type='n',main='Ricker fit (CPD)')
  
   alpha_t=apply(r1cpd[,grepl('alpha_t',colnames(r1cpd))==T],1,median)
  alpha_j=r1cpd[,colnames(r1cpd)== paste('alpha_j[',c,']',sep='')]
  smax_j=r1cpd[,colnames(r1cpd)== paste('S_max[',c,']',sep='')]
  b_ECA=r1cpd[,colnames(r1cpd)==paste('b_for_rv[',c,']',sep='')]                                                                          
  s_pred=seq(0,max(rv$Spawners),length.out=100)
  
   RS_pred_m=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-as.matrix(1/smax_j)%*%s_pred,2,median))*s_pred
  RS_pred_l=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-as.matrix(1/smax_j)%*%s_pred,2,quantile,0.05))*s_pred
  RS_pred_u=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-as.matrix(1/smax_j)%*%s_pred,2,quantile,0.95))*s_pred
  
  
  RS_pred_eca_l=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-as.matrix(1/smax_j)%*%s_pred+matrix(b_ECA*min(rv$sqrt.CPD.std),ncol=length(s_pred),nrow=length(alpha_j)),2,median))*s_pred
  
  RS_pred_eca_u=exp(apply(matrix(alpha_j+alpha_t,ncol=length(s_pred),nrow=length(alpha_j))-as.matrix(1/smax_j)%*%s_pred+matrix(b_ECA*max(rv$sqrt.CPD.std),ncol=length(s_pred),nrow=length(alpha_j)),2,median))*s_pred
  lines(RS_pred_m~s_pred,lwd=3)
  lines(RS_pred_l~s_pred,lwd=1,lty=5)
  lines(RS_pred_u~s_pred,lwd=1,lty=5)
  lines(RS_pred_eca_l~s_pred,col=adjustcolor(cols[1],alpha.f=0.8),lwd=3)
  lines(RS_pred_eca_u~s_pred,col=adjustcolor(cols[9],alpha.f=0.8),lwd=3)
  
  points(Recruits~Spawners,data=rv,bg=col_points2,pch=24,cex=1.5) 
  
   plot(rv$ECA_age_proxy_forested_only~rv$BroodYear,bty='l',type='n',xlab='Brood Year',ylab='Forest loss metric',ylim=c(0,1))
   lines(ECA_age_proxy_forested_only~BroodYear,data=rv,col='navy',lwd=2)
    points(ECA_age_proxy_forested_only~BroodYear,data=rv,bg=col_points1,pch=21,cex=1.5,col='navy') 
   lines(rv$disturbedarea_prct_cs/100~BroodYear,data=rv,col='tan2',lwd=2)
    points(rv$disturbedarea_prct_cs/100~BroodYear,data=rv,bg=col_points2,pch=21,cex=1.5,col='tan2')
    text(x=par('usr')[2]-4,y=par('usr')[4]*0.95,'ECA',col='navy')
    text(x=par('usr')[2]-4,y=par('usr')[4]*0.88,'CPD',col='tan2')
  
  realized_eca=as.matrix(d1eca[,colnames(d1eca)==paste('b_for_rv[',c,']',sep='')])%*%rv$sqrt.ECA.std
 realized_eca_m=apply(realized_eca,2,median)
  
   realized_cpd=as.matrix(d1cpd[,colnames(d1cpd)==paste('b_for_rv[',c,']',sep='')])%*%as.vector(rv$sqrt.CPD.std)
 realized_cpd_m=apply(realized_cpd,2,median)
 
 realized_eca_r=as.matrix(r1eca[,colnames(r1eca)==paste('b_for_rv[',c,']',sep='')])%*%rv$sqrt.ECA.std
 realized_eca_m_r=apply(realized_eca_r,2,median)
  
   realized_cpd_r=as.matrix(r1cpd[,colnames(r1cpd)==paste('b_for_rv[',c,']',sep='')])%*%as.vector(rv$sqrt.CPD.std)
 realized_cpd_m_r=apply(realized_cpd_r,2,median)
    
   plot(realized_eca_m~rv$BroodYear,bty='l',type='n',ylim=c(min(c(realized_eca_m,realized_cpd_m)),max(c(realized_eca_m,realized_cpd_m))*1.2),ylab='Marginal effect on productivity',xlab='Brood Year')
   lines(realized_eca_m~BroodYear,data=rv,col='navy',lwd=2)
    points(realized_eca_m~BroodYear,data=rv,col='navy',bg=col_points1,pch=21,cex=1.5) 
  
   lines(realized_cpd_m~BroodYear,data=rv,col='tan2',lwd=2)
    points(realized_cpd_m~BroodYear,data=rv,col='tan2',bg=col_points2,pch=21,cex=1.5) 
    lines(realized_eca_m_r~BroodYear,data=rv,col='navy',lwd=2)
    points(realized_eca_m_r~BroodYear,data=rv,col='navy',bg=col_points1,pch=24,cex=1.5) 
  
   lines(realized_cpd_m_r~BroodYear,data=rv,col='tan2',lwd=2)
    points(realized_cpd_m_r~BroodYear,data=rv,col='tan2',bg=col_points2,pch=24,cex=1.5) 
   
    
    text(x=par('usr')[2]-5,y=realized_eca_m[length(realized_eca_m)]+(par('usr')[4]-par('usr')[3])*0.03,'ECA',col='navy')
    text(x=par('usr')[2]-5,y=realized_cpd_m[length(realized_cpd_m)]+(par('usr')[4]-par('usr')[3])*0.03,'CPD',col='tan2')

   cat('\n')  
}
```

